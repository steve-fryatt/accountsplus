REM >!RunImage
REM !Accounts+
REM Accounting Software
REM
REM (C) Stephen Fryatt, 1995
REM
REM This code may not be copied or altered without the author's permission.
:
REMTRACE TO "RAM:TraceFile" : TRACE ON
debug%=FALSE
build_version$="1.32"
build_date$="27th February 1997"
:
file_type_accounts%=&0AD
file_type_account%=&1AC
file_type_text%=&FFF
file_type_csv%=&DFE
:
LIBRARY "BASIC:Menu"
LIBRARY "BASIC:Resources"
:
LIBRARY "src/HelpLib.bbt"
:
ON ERROR SYS "Hourglass_Smash" : PRINT TAB(0,0) REPORT$+" at line "+STR$(ERL) : END
:
SYS "XOS_GetEnv" TO state$
:
PROCinitiate
:
ON ERROR PROCerror
:
REPEAT
 PROCpoll
 UNTIL quit%
:
PROCclose_down
:
END
:
DEF PROCpoll
SYS "Wimp_Poll",,b% TO reason%
CASE reason% OF
 WHEN 0 : IF system_date% THEN PROCget_date
          IF info_bar_time% THEN PROCupdate_info_bar
 WHEN 1 : PROCredraw_screen
 WHEN 2 : CASE !b% OF
           WHEN main%,pane% : PROCopen_pane
           WHEN acc_view% : PROCopen_apane
           WHEN pref_wind% : PROCopen_ppane
           WHEN sl_wind% : PROCopen_spane
           WHEN head_wind% : PROCopen_head_pane
           WHEN hel_wind% : PROCopen_hel_pane
           WHEN bal_wind% : PROCopen_bpane
           WHEN swl_wind% : PROCopen_wpane
          OTHERWISE
           SYS "Wimp_OpenWindow",,b%
          ENDCASE
 WHEN 3 : SYS "Wimp_CloseWindow",,b%
          CASE !b% OF
           WHEN main% : PROCclose_window(pane%) : PROCclose_window(pane2%)
           WHEN acc_view% : PROCclose_window(apane%) : view_account%=-1 : PROCset_tool_state
           WHEN pref_wind% : PROCclose_window(ppane%)
           WHEN sl_wind% : PROCclose_window(spane%)
           WHEN head_wind% : PROCclose_window(hpane%)
           WHEN hel_wind% : PROCclose_window(lpane%)
           WHEN bal_wind% : PROCclose_window(bpane%)
           WHEN swl_wind% : PROCclose_window(wpane%)
          ENDCASE
 WHEN 6 : PROCmouse_click(b%!12,b%!16,b%!8,!b%,b%!4)
 WHEN 7 : PROCget_path
 WHEN 8 : PROCkey_press(!b%,b%!4,b%!8,b%!12,b%!24)
 WHEN 9 : PROCmenu_selection(!b%,b%!4,b%!8,b%!12)
 WHEN 17,18 : PROCrecieve_message(b%!16)
ENDCASE
ENDPROC
:
DEF PROCmouse_click(window%,icon%,buttons%,x%,y%)
LOCAL flag%
flag%=FALSE
CASE buttons% OF
 WHEN 64
  CASE window% OF
   WHEN save%     : PROCdrag_box(save%)
   WHEN exp_wind% : IF icon%=0 THEN PROCdrag_box(exp_wind%)
   ENDCASE
 WHEN 4
  CASE window% OF
   WHEN mess_wind%
    PROCclose_window(mess_wind%)
    PROCreset_mouse
    CASE mess% OF
     WHEN 1 : IF icon%=3 THEN PROCdelete_line
     WHEN 2 : IF icon%=3 THEN PROCcut_line
     WHEN 3 : IF icon%=3 THEN quit%=TRUE
              IF icon%=2 THEN PROCopen_as_menu(save%,x%,y%)
     WHEN 4 : IF icon%=3 THEN PROCremove_lines
     WHEN 5 : IF icon%=3 THEN PROCdelete_so
     WHEN 6 : IF icon%=3 THEN PROCclear_file : PROCredraw_main : PROCrecalc
     WHEN 7 : IF icon%=3 THEN PROCadd_standing_orders(FALSE) : PROCget_standing_orders
     WHEN 8 : IF icon%=3 THEN PROCdelete_he
     WHEN 9 : IF icon%=3 THEN PROCdelete_account
     WHEN 10 : IF icon%=3 THEN quit%=TRUE : reset%=TRUE
               IF icon%=2 THEN PROCopen_as_menu(save%,size_x%/2,size_y%/2)
     WHEN 11 : IF icon%=3 THEN PROCload
     WHEN 12 : IF icon%=3 THEN PROCsearch(FALSE,FALSE,FALSE)
     WHEN 13 : IF icon%=3 THEN PROCsearch(FALSE,FALSE,TRUE)
     ENDCASE
   WHEN -2
    PROCopen_window(main%):PROCopen_window(pane%):PROCopen_window(pane2%)
    IF NOT FNfind_caret(pane2%,-1) THEN
     IF FNicon_deleted(pane2%,0) THEN PROCend_caret(pane2%,1) ELSE PROCend_caret(pane2%,0)
    ENDIF
   WHEN main%
    PROCmouse_select(y%,4)
    IF NOT FNfind_caret(pane2%,-1) THEN
     IF FNicon_deleted(pane2%,0) THEN PROCend_caret(pane2%,1) ELSE PROCend_caret(pane2%,0)
    ENDIF
   WHEN acc_view%
    IF FNpreference(27) THEN PROCaccount_mouse_select(y%,4)
   WHEN pane%
    CASE icon% OF
     WHEN 7 : PROCopen_window(bal_wind%) : PROCopen_window(bpane%)
     WHEN 8 : PROCset_menu_title(amenu%,FNmess_trans("ViewAcc"))
              PROCset_menu_width(amenu%,wide_amenu%)
              PROCdisplay_menu(amenu%,x%,y%) : amenu_no%=3
     WHEN 9 : PROCselect_line(0)
     WHEN 10 : IF FNpreference(2) THEN
                mess%=1 : PROCmessage("Delete?|<S>","Cancel","","Delete")
               ELSE
                PROCdelete_line
               ENDIF
     WHEN 11 : PROCset_icon_state(date_wind%,1,ABS(system_date%),0,0)
               PROCset_icon_state(date_wind%,2,ABS(NOT system_date%),0,0)
               PROCset_icon_state(date_wind%,3,0,ABS(system_date%),0)
               $FNindirection(date_wind%,3)=other_date$
               PROCopen_as_menu(date_wind%,x%,y%)
     WHEN 12 : PROCset_printt_window
               PROCopen_window(printt_wind%) : PROCend_caret(printt_wind%,-1)
     WHEN 13 : PROCopen_window(swl_wind%) : PROCopen_window(wpane%)
     WHEN 14 : PROCopen_as_menu(save%,x%,y%)
     WHEN 15 : PROCopen_window(hel_wind%) : PROCopen_window(lpane%)
     WHEN 17 : $FNindirection(goto_wind%,0)="" : $g_title%=FNmess_trans("GotoTrans") : PROCopen_as_menu(goto_wind%,x%,y%) : g_type%=1
     WHEN 18: PROCsearch_window: PROCopen_at(search_wind%,x%,y%) : PROCend_caret(search_wind%,2)
     ENDCASE
   WHEN pane2%
    CASE icon% OF
     WHEN 5 : PROCadd_line
     WHEN 6 : PROCset_icon_state(pane2%,0,0,0,ABS(FNicon_selected(pane2%,6)))
              IF FNfind_caret(pane2%,0) THEN PROCend_caret(pane2%,1)
              PROCredraw_icon(pane2%,0)
     WHEN 7 : PROCset_menu_title(amenu%,FNmess_trans("Accounts"))
              PROCset_menu_width(amenu%,narrow_amenu%)
              PROCdisplay_menu(amenu%,x%,y%) : amenu_no%=1
     WHEN 8 : PROCset_menu_title(amenu%,FNmess_trans("Accounts"))
              PROCset_menu_width(amenu%,narrow_amenu%)
              PROCdisplay_menu(amenu%,x%,y%) : amenu_no%=2
     WHEN 9 : PROCinsert_line_below
     WHEN 10 : PROCreplace_line
     WHEN 11 : PROCcopy_line
     WHEN 12 : IF FNpreference(3) THEN
                mess%=2 : PROCmessage("Cut?|<S>","Cancel","","Cut")
               ELSE
                PROCcut_line
               ENDIF
     WHEN 13 : PROCclear_edit_bar
     WHEN 14 : PROCinsert_line_above
     WHEN 17 : PROCrun_help
     ENDCASE
   WHEN apane%
    CASE icon% OF
     WHEN 8 : PROCset_menu_title(amenu%,FNmess_trans("ViewAcc"))
              PROCset_menu_width(amenu%,wide_amenu%)
              PROCdisplay_menu(amenu%,x%,y%) : amenu_no%=3
     WHEN 9 : PROCopen_window(bal_wind%) : PROCopen_window(bpane%)
     WHEN 10 :
     WHEN 11 : $FNindirection(inb_wind%,1)=FNpoint(initial%(view_account%)) : PROCopen_as_menu(inb_wind%,x%,y%)
     WHEN 13 : $FNindirection(exp_wind%,0)=sprite_csv$
               $FNindirection(exp_wind%,1)=FNmess_trans("CSV")
               $FNindirection(exp_wind%,5)=$FNindirection(acc_wind%,view_account%+1)
               $FNindirection(exp_wind%,6)=FNmess_trans("Account")+":"
               $FNindirection(exp_wind%,7)=FNmess_trans("LineNo")
               $FNindirection(exp_wind%,8)=FNmess_trans("Heads")
               $FNindirection(exp_wind%,9)=FNmess_trans("Quotes")
               PROCset_export_extent(3)
               d_type%=3
               PROCopen_as_menu(exp_wind%,x%,y%)
     WHEN 14 : $FNindirection(goto_wind%,0)="" : $g_title%=FNmess_trans("GotoLine") : PROCopen_as_menu(goto_wind%,x%,y%) : g_type%=2
     WHEN 15 : PROCset_print_window
               PROCopen_window(print_wind%) : PROCend_caret(print_wind%,-1)
     WHEN 16 : PROCopen_window(hel_wind%) : PROCopen_window(lpane%)
     WHEN 18 : PROCselect_line(0)
     WHEN 19 : IF FNpreference(2) THEN
                mess%=1 : PROCmessage("Delete?|<S>","Cancel","","Delete")
               ELSE
                PROCdelete_line
               ENDIF
     ENDCASE
   WHEN save%
    CASE icon% OF
     WHEN 2 : PROCquick_save(1)
     ENDCASE
   WHEN exp_wind%
    CASE icon% OF
     WHEN 2 : PROCquick_save(d_type%+1)
     ENDCASE
   WHEN acc_wind%
    CASE icon% OF
     WHEN 1,2,3,4,5,6,7,8,9,10 : PROCedit_account(icon%)
     WHEN 20 : PROCcancel_account : PROCclose_window(acc_wind%)
     WHEN 21 : PROCnew_account
     OTHERWISE : PROCend_caret(acc_wind%,-1)
     ENDCASE
   WHEN ed_acc%
    CASE icon% OF
     WHEN 2 : PROCcancel_account
     WHEN 3 : IF FNpreference(7) THEN
                mess%=9 : PROCmessage("DeleteAcc?","Cancel","","Delete")
               ELSE
                PROCdelete_account
               ENDIF
     WHEN 4 : PROCchange_account
     ENDCASE
   WHEN print_wind%
    CASE icon% OF
     WHEN 6 : PROCincrease_icon(print_wind%,5,pmax_size%) : PROCcalculate_print_values
     WHEN 7 : PROCdecrease_icon(print_wind%,5,0) : PROCcalculate_print_values
     WHEN 10 : PROCincrease_icon(print_wind%,9,pmax_top%) : PROCcalculate_print_values
     WHEN 11 : PROCdecrease_icon(print_wind%,9,0) : PROCcalculate_print_values
     WHEN 14 : PROCincrease_icon(print_wind%,13,pmax_base%) : PROCcalculate_print_values
     WHEN 15 : PROCdecrease_icon(print_wind%,13,0) : PROCcalculate_print_values
     WHEN 18 : PROCincrease_icon(print_wind%,17,pmax_left%) : PROCcalculate_print_values
     WHEN 19 : PROCdecrease_icon(print_wind%,17,0) : PROCcalculate_print_values
     WHEN 25 : PROCcalculate_print_values
     WHEN 28 : PROCset_print_values(FALSE) : PROCprint_account
     WHEN 29 : PROCclose_window(print_wind%)
     WHEN 30 : PROCset_print_values(TRUE)
     WHEN 33 : PROCset_icon_state(print_wind%,33,1,0,0)
               PROCset_icon_state(print_wind%,36,0,1,0)
               PROCset_icon_state(print_wind%,37,0,1,0)
               IF FNfind_caret(print_wind%,36) OR FNfind_caret(print_wind%,37) THEN PROCend_caret(print_wind%,-1)
     WHEN 34 : PROCset_icon_state(print_wind%,34,1,0,0)
               PROCset_icon_state(print_wind%,36,0,0,0)
               PROCset_icon_state(print_wind%,37,0,0,0)
               IF FNfind_caret(print_wind%,-1) THEN PROCend_caret(print_wind%,36)
     WHEN 38 : PROCset_code_window : PROCopen_window(printcon_wind%) : PROCend_caret(printcon_wind%,1)
     WHEN 39 : PROCset_print_values(FALSE) : PROCclose_window(print_wind%)
     ENDCASE
   WHEN printh_wind%
    CASE icon% OF
     WHEN 6 : PROCincrease_icon(printh_wind%,5,pmax_size%) : PROCcalculate_printh_values
     WHEN 7 : PROCdecrease_icon(printh_wind%,5,0) : PROCcalculate_printh_values
     WHEN 10 : PROCincrease_icon(printh_wind%,9,phmax_top%) : PROCcalculate_printh_values
     WHEN 11 : PROCdecrease_icon(printh_wind%,9,0) : PROCcalculate_printh_values
     WHEN 16 : PROCincrease_icon(printh_wind%,15,phmax_left%) : PROCcalculate_printh_values
     WHEN 17 : PROCdecrease_icon(printh_wind%,15,0) : PROCcalculate_printh_values
     WHEN 23 : PROCset_printh_values(FALSE) : PROCprint_headers
     WHEN 24 : PROCclose_window(printh_wind%)
     WHEN 25 : PROCset_printh_values(TRUE)
     WHEN 26 : PROCset_code_window : PROCopen_window(printcon_wind%) : PROCend_caret(printcon_wind%,1)
     WHEN 27 : PROCset_printh_values(FALSE) : PROCclose_window(printh_wind%)
     OTHERWISE : PROCend_caret(printh_wind%,-1)
     ENDCASE
   WHEN printt_wind%
    CASE icon% OF
     WHEN 4 : PROCincrease_icon(printt_wind%,3,ptmax_size%) : PROCcalculate_printt_values
     WHEN 5 : PROCdecrease_icon(printt_wind%,3,0) : PROCcalculate_printt_values
     WHEN 8 : PROCincrease_icon(printt_wind%,7,ptmax_top%) : PROCcalculate_printt_values
     WHEN 9 : PROCdecrease_icon(printt_wind%,7,0) : PROCcalculate_printt_values
     WHEN 12 : PROCincrease_icon(printt_wind%,11,ptmax_base%) : PROCcalculate_printt_values
     WHEN 13 : PROCdecrease_icon(printt_wind%,11,0) : PROCcalculate_printt_values
     WHEN 16 : PROCincrease_icon(printt_wind%,15,ptmax_left%) : PROCcalculate_printt_values
     WHEN 17 : PROCdecrease_icon(printt_wind%,15,0) : PROCcalculate_printt_values
     WHEN 23 : PROCcalculate_printt_values
     WHEN 26 : PROCset_printt_values(FALSE) : PROCprint_transactions
     WHEN 27 : PROCclose_window(printt_wind%)
     WHEN 28 : PROCset_printt_values(TRUE)
     WHEN 31 : PROCset_icon_state(printt_wind%,31,1,0,0)
               PROCset_icon_state(printt_wind%,34,0,1,0)
               PROCset_icon_state(printt_wind%,35,0,1,0)
               IF FNfind_caret(printt_wind%,34) OR FNfind_caret(printt_wind%,35) THEN PROCend_caret(printt_wind%,-1)
     WHEN 32 : PROCset_icon_state(printt_wind%,32,1,0,0)
               PROCset_icon_state(printt_wind%,34,0,0,0)
               PROCset_icon_state(printt_wind%,35,0,0,0)
               IF FNfind_caret(printt_wind%,-1) THEN PROCend_caret(printt_wind%,34)
     WHEN 36 : PROCset_code_window : PROCopen_window(printcon_wind%) : PROCend_caret(printcon_wind%,1)
     WHEN 37 : PROCset_printt_values(FALSE) : PROCclose_window(printt_wind%)
     ENDCASE
   WHEN printcon_wind%
    CASE icon% OF
     WHEN 21 : PROCset_printcodes(FALSE) : PROCclose_window(printcon_wind%)
     WHEN 22 : PROCset_printcodes(TRUE) : PROCclose_window(printcon_wind%)
     WHEN 23 : PROCclose_window(printcon_wind%)
     ENDCASE
   WHEN head_wind%
    CASE icon% OF
     WHEN 1 : PROCnew_head
     WHEN 2 : PROCcancel_head : PROCclose_window(head_wind%) : PROCclose_window(hpane%)
     OTHERWISE : PROCend_caret(head_wind%,-1)
     ENDCASE
   WHEN set_title%
    CASE icon% OF
     WHEN 1 : PROCset_new_title
     ENDCASE
   WHEN inb_wind%
    CASE icon% OF
     WHEN 2 : PROCinitial_balance
     ENDCASE
   WHEN goto_wind%
    CASE icon% OF
     WHEN 1
      CASE g_type% OF
       WHEN 1 : PROCgoto_line(main%,VAL($FNindirection(goto_wind%,0)))
       WHEN 2 : PROCgoto_line(acc_view%,VAL($FNindirection(goto_wind%,0))+1)
       ENDCASE
     ENDCASE
   WHEN pref_wind%
    CASE icon% OF
     WHEN 1 : PROCsave_preferences(TRUE) : PROCclose_window(pref_wind%) : PROCclose_window(ppane%)
     WHEN 2 : PROCsave_preferences(FALSE) : PROCclose_window(pref_wind%) : PROCclose_window(ppane%)
     WHEN 3 : PROCload_preferences(FALSE) : PROCclose_window(pref_wind%) : PROCclose_window(ppane%)
     OTHERWISE : PROCend_caret(ppane%,-1)
     ENDCASE
   WHEN ppane%
    CASE icon% OF
     WHEN 2  : PROCset_icon_state(ppane%,66,0,ABS(NOT FNicon_selected(ppane%,2) OR (NOT os_350%)),0)
     WHEN 3  : PROCset_icon_state(ppane%,38,0,ABS(NOT FNicon_selected(ppane%,3)),0)
               PROCset_icon_state(ppane%,39,0,ABS(NOT FNicon_selected(ppane%,3)),0)
               PROCset_icon_state(ppane%,40,0,ABS(NOT FNicon_selected(ppane%,3)),0)
     WHEN 28 : PROCset_icon_state(ppane%,67,0,ABS(NOT FNicon_selected(ppane%,28)),0)
     WHEN 32 : PROCset_icon_state(ppane%,63,0,ABS(NOT FNicon_selected(ppane%,32)),0)
               PROCset_icon_state(ppane%,57,0,ABS(NOT FNicon_selected(ppane%,32)),0)
               IF FNicon_shaded(ppane%,63) AND FNfind_caret(ppane%,63) THEN PROCend_caret(ppane%,71)
     WHEN 33 : PROCset_icon_state(ppane%,35,0,ABS(NOT FNicon_selected(ppane%,33)),0)
               PROCset_icon_state(ppane%,36,0,ABS(NOT FNicon_selected(ppane%,33)),0)
               PROCset_icon_state(ppane%,37,0,ABS(NOT FNicon_selected(ppane%,33)),0)
               IF FNicon_shaded(ppane%,35) AND FNfind_caret(ppane%,35) THEN PROCend_caret(ppane%,56)
     WHEN 38,40 : PROCset_cmenu_tick(FNget_icon_colour(ppane%,38))
                  PROCdisplay_menu(cmenu%,x%,y%) : c_menu%=1
     WHEN 41,43 : PROCset_cmenu_tick(FNget_icon_colour(ppane%,41))
                  PROCdisplay_menu(cmenu%,x%,y%) : c_menu%=2
     WHEN 44,46 : PROCset_cmenu_tick(FNget_icon_colour(ppane%,44))
                  PROCdisplay_menu(cmenu%,x%,y%) : c_menu%=3
     WHEN 47,49 : PROCset_cmenu_tick(FNget_icon_colour(ppane%,47))
                  PROCdisplay_menu(cmenu%,x%,y%) : c_menu%=4
     WHEN 50,52 : PROCset_cmenu_tick(FNget_icon_colour(ppane%,50))
                  PROCdisplay_menu(cmenu%,x%,y%) : c_menu%=5
     WHEN 53,55 : PROCset_cmenu_tick(FNget_icon_colour(ppane%,53))
                  PROCdisplay_menu(cmenu%,x%,y%) : c_menu%=6
     WHEN 69,70 : PROCset_icon_state(ppane%,58,0,ABS(NOT FNicon_selected(ppane%,70)),0)
                  IF FNicon_shaded(ppane%,58) AND FNfind_caret(ppane%,58) THEN PROCend_caret(ppane%,71)
     ENDCASE
   WHEN search_wind%
    CASE icon% OF
     WHEN 9  : PROCclose_window(search_wind%)
     WHEN 10 : PROCsearch(TRUE,FALSE,TRUE)
     WHEN 11 : PROCsearch(TRUE,FALSE,FALSE)
     WHEN 17 : PROCset_menu_title(amenu%,"Accounts")
               PROCset_menu_width(amenu%,narrow_amenu%)
               PROCdisplay_menu(amenu%,x%,y%) : amenu_no%=6
     WHEN 18 : PROCset_menu_title(amenu%,"Accounts")
               PROCset_menu_width(amenu%,narrow_amenu%)
               PROCdisplay_menu(amenu%,x%,y%) : amenu_no%=7
     ENDCASE
   WHEN found_wind%
    CASE icon% OF
     WHEN 8 : PROCclose_window(found_wind%)
     WHEN 9 : PROCclose_window(found_wind%) : PROCsearch(FALSE,TRUE,TRUE)
     WHEN 10 : PROCclose_window(found_wind%) : PROCsearch(FALSE,FALSE,FALSE)
     WHEN 11 : PROCclose_window(found_wind%) : PROCsearch(FALSE,TRUE,FALSE)
     OTHERWISE : PROCend_caret(found_wind%,-1)
     ENDCASE
   WHEN so_wind%
    CASE icon% OF
     WHEN 25 : PROCset_icon_state(so_wind%,25,1,0,0)
               PROCset_icon_state(so_wind%,3,0,0,0)
               PROCset_icon_state(so_wind%,24,0,0,0)
               PROCset_icon_state(so_wind%,8,0,1,0)
               IF FNfind_caret(so_wind%,8) THEN PROCend_caret(so_wind%,3)
     WHEN 24 : PROCset_icon_state(so_wind%,25,0,0,0)
               PROCset_icon_state(so_wind%,3,0,1,0)
               PROCset_icon_state(so_wind%,24,1,0,0)
               PROCset_icon_state(so_wind%,8,0,0,0)
               IF FNfind_caret(so_wind%,3) THEN PROCend_caret(so_wind%,8)
     WHEN 18 : PROCset_menu_title(amenu%,"Accounts")
               PROCset_menu_width(amenu%,narrow_amenu%)
               PROCdisplay_menu(amenu%,x%,y%) : amenu_no%=4
     WHEN 19 : PROCset_menu_title(amenu%,"Accounts")
               PROCset_menu_width(amenu%,narrow_amenu%)
               PROCdisplay_menu(amenu%,x%,y%) : amenu_no%=5
     WHEN 20 : IF FNpreference(6) THEN
                mess%=5 : PROCmessage("DeleteSO?","Cancel","","Delete")
               ELSE
                PROCdelete_so
               ENDIF
     WHEN 21 : PROCcancel_so
     WHEN 22 : PROCchange_so
     ENDCASE
   WHEN he_wind%
    CASE icon% OF
     WHEN 5 : IF FNpreference(22) THEN
                mess%=8 : PROCmessage("DeleteHead?","Cancel","","Delete")
               ELSE
                PROCdelete_he
               ENDIF
     WHEN 6 : PROCcancel_head
     WHEN 7 : PROCchange_head
     ENDCASE
   WHEN sl_wind%
    CASE icon% OF
     WHEN 1 : PROCnew_so
     WHEN 2 : PROCcancel_so : PROCclose_window(sl_wind%) : PROCclose_window(spane%)
     OTHERWISE : PROCend_caret(sl_wind%,-1)
     ENDCASE
   WHEN spane%
    PROCedit_so(icon%)
   WHEN hpane%
    PROCedit_head(icon%)
   WHEN loadcsv_wind%
    CASE icon% OF
     WHEN 2 : PROCset_icon_state(loadcsv_wind%,2,1,0,0)
              PROCset_icon_state(loadcsv_wind%,3,0,0,0)
              PROCset_icon_state(loadcsv_wind%,4,0,1,0)
              PROCset_icon_state(loadcsv_wind%,5,0,1,0)
              $FNindirection(loadcsv_wind%,12)="From:"
              $FNindirection(loadcsv_wind%,16)="To:"
              $FNindirection(loadcsv_wind%,20)="Amount:"
              PROCredraw_icon(loadcsv_wind%,12)
              PROCredraw_icon(loadcsv_wind%,16)
              PROCredraw_icon(loadcsv_wind%,20)
     WHEN 3 : PROCset_icon_state(loadcsv_wind%,2,0,0,0)
              PROCset_icon_state(loadcsv_wind%,3,1,0,0)
              PROCset_icon_state(loadcsv_wind%,4,0,0,0)
              PROCset_icon_state(loadcsv_wind%,5,0,0,0)
              $FNindirection(loadcsv_wind%,12)="From/To:"
              $FNindirection(loadcsv_wind%,16)="Debits:"
              $FNindirection(loadcsv_wind%,20)="Credits:"
              PROCredraw_icon(loadcsv_wind%,12)
              PROCredraw_icon(loadcsv_wind%,16)
              PROCredraw_icon(loadcsv_wind%,20)
     WHEN 5 : PROCset_menu_title(amenu%,"Accounts")
              PROCset_menu_width(amenu%,narrow_amenu%)
              PROCdisplay_menu(amenu%,x%,y%) : amenu_no%=8
     WHEN 10 : $FNindirection(loadcsv_wind%,9)=FNincrement_field_number(9,1)
     WHEN 11 : $FNindirection(loadcsv_wind%,9)=FNincrement_field_number(9,-1)
     WHEN 14 : $FNindirection(loadcsv_wind%,13)=FNincrement_field_number(13,1)
     WHEN 15 : $FNindirection(loadcsv_wind%,13)=FNincrement_field_number(13,-1)
     WHEN 18 : $FNindirection(loadcsv_wind%,17)=FNincrement_field_number(17,1)
     WHEN 19 : $FNindirection(loadcsv_wind%,17)=FNincrement_field_number(17,-1)
     WHEN 22 : $FNindirection(loadcsv_wind%,21)=FNincrement_field_number(21,1)
     WHEN 23 : $FNindirection(loadcsv_wind%,21)=FNincrement_field_number(21,-1)
     WHEN 26 : $FNindirection(loadcsv_wind%,25)=FNincrement_field_number(25,1)
     WHEN 27 : $FNindirection(loadcsv_wind%,25)=FNincrement_field_number(25,-1)
     WHEN 28 : PROCload_csv
     WHEN 29 : PROCclose_window(loadcsv_wind%)
     OTHERWISE : PROCend_caret(loadcsv_wind%,-1)
     ENDCASE
   WHEN loadacc_wind%
    CASE icon% OF
     WHEN 1 : PROCset_menu_title(amenu%,"Accounts")
              PROCset_menu_width(amenu%,narrow_amenu%)
              PROCdisplay_menu(amenu%,x%,y%) : amenu_no%=9
     WHEN 2 : PROCload_account
     WHEN 3 : PROCclose_window(loadacc_wind%)
     WHEN 8 : PROCset_icon_state(loadacc_wind%,8,1,0,0)
              PROCset_icon_state(loadacc_wind%,11,0,1,0)
              PROCset_icon_state(loadacc_wind%,12,0,1,0)
              IF FNfind_caret(loadacc_wind%,11) THEN PROCend_caret(loadacc_wind%,-1)
     WHEN 9 : PROCset_icon_state(loadacc_wind%,9,1,0,0)
              PROCset_icon_state(loadacc_wind%,11,0,1,0)
              PROCset_icon_state(loadacc_wind%,12,0,1,0)
              IF FNfind_caret(loadacc_wind%,11) THEN PROCend_caret(loadacc_wind%,-1)
     WHEN 10 : PROCset_icon_state(loadacc_wind%,10,1,0,0)
               PROCset_icon_state(loadacc_wind%,11,0,0,0)
               PROCset_icon_state(loadacc_wind%,12,0,0,0)
               IF FNfind_caret(loadacc_wind%,-1) THEN PROCend_caret(loadacc_wind%,11)
     WHEN 13 : PROCset_icon_state(loadacc_wind%,13,1,0,0)
               PROCset_icon_state(loadacc_wind%,11,0,1,0)
               PROCset_icon_state(loadacc_wind%,12,0,1,0)
               IF FNfind_caret(loadacc_wind%,11) THEN PROCend_caret(loadacc_wind%,-1)
     OTHERWISE : PROCend_caret(loadacc_wind%,-1)
     ENDCASE
   WHEN date_wind%
    CASE icon% OF
     WHEN 1 : PROCset_icon_state(date_wind%,1,1,0,0)
              PROCset_icon_state(date_wind%,2,0,0,0)
              PROCset_icon_state(date_wind%,3,0,1,0)
     WHEN 2 : PROCset_icon_state(date_wind%,1,0,0,0)
              PROCset_icon_state(date_wind%,2,1,0,0)
              PROCset_icon_state(date_wind%,3,0,0,0)
     WHEN 4 : other_date$=$FNindirection(date_wind%,3)
              system_date%=FNicon_selected(date_wind%,1)
              IF system_date% THEN PROCdisplay_menu(-1,0,0)
              PROCget_date
     ENDCASE
  ENDCASE
 WHEN 2
  CASE window% OF
   WHEN -2
    PROCdisplay_bar_menu(imenu%,5,2,x%)
   WHEN main%,pane%,pane2%
    PROCset_menu_width(amenu%,wide_amenu%)
    PROCset_menu_title(amenu%,"View Account")
    PROCdisplay_menu(mmenu%,x%,y%)
   WHEN acc_view%,apane%
    PROCset_menu_width(amenu%,wide_amenu%)
    PROCset_menu_title(amenu%,"View Account")
    PROCdisplay_menu(vmenu%,x%,y%)
   ENDCASE
 WHEN 1
  CASE window% OF
   WHEN main%
    PROCmouse_select(y%,1)
   WHEN pane%
    CASE icon% OF
     WHEN 7 : PROCopen_window(acc_wind%) : PROCend_caret(acc_wind%,-1)
     WHEN 12 : PROCset_code_window : PROCopen_window(printcon_wind%) : PROCend_caret(printcon_wind%,1)
     WHEN 13 : PROCopen_window(sl_wind%) : PROCopen_window(spane%) : PROCend_caret(sl_wind%,-1)
     WHEN 14 : $FNindirection(exp_wind%,6)=FNmess_trans("ToExp")+":"
               $FNindirection(exp_wind%,0)=sprite_csv$
               $FNindirection(exp_wind%,1)=FNmess_trans("CSV")
               $FNindirection(exp_wind%,5)=FNmess_trans("Trans")
               $FNindirection(exp_wind%,7)=FNmess_trans("LineNo")
               $FNindirection(exp_wind%,8)=FNmess_trans("Heads")
               $FNindirection(exp_wind%,9)=FNmess_trans("Quotes")
               PROCset_export_extent(3)
               d_type%=8
               PROCopen_as_menu(exp_wind%,x%,y%)
     WHEN 15 : PROCopen_window(head_wind%) : PROCopen_window(hpane%) : PROCend_caret(head_wind%,-1)
     WHEN 17 : IF select%>0 THEN PROCgoto_line(main%,select%)
     ENDCASE
   WHEN pane2%
    CASE icon% OF
     WHEN 7 : IF no_y% THEN PROCdisplay_menu(ymenu%,x%,y%) : hmenu_no%=1
     WHEN 8 : IF no_z% THEN PROCdisplay_menu(zmenu%,x%,y%) : hmenu_no%=1
     ENDCASE
   WHEN acc_view%
    IF FNpreference(27) THEN PROCaccount_mouse_select(y%,1)
   WHEN apane%
    CASE icon% OF
     WHEN 9 : PROCopen_window(acc_wind%) : PROCend_caret(acc_wind%,-1)
     WHEN 13 : $FNindirection(exp_wind%,0)=sprite_account$
               $FNindirection(exp_wind%,1)=FNmess_trans("AccountF")
               $FNindirection(exp_wind%,5)=$FNindirection(acc_wind%,view_account%+1)
               $FNindirection(exp_wind%,6)=FNmess_trans("Account")+":"
               PROCset_export_extent(1)
               $FNindirection(exp_wind%,7)=FNmess_trans("Dates")
               d_type%=1
               PROCopen_as_menu(exp_wind%,x%,y%)
     WHEN 14 : IF FNaccount_selection(select%)>-1 AND select%>0 THEN PROCgoto_line(acc_view%,FNaccount_selection(select%)+1)
     WHEN 15 : PROCset_code_window : PROCopen_window(printcon_wind%) : PROCend_caret(printcon_wind%,1)
     WHEN 16 : PROCopen_window(head_wind%) : PROCopen_window(hpane%) : PROCend_caret(head_wind%,-1)
      ENDCASE
   WHEN pref_wind%
    CASE icon% OF
     WHEN 1 : PROCsave_preferences(TRUE)
     WHEN 2 : PROCsave_preferences(FALSE)
     WHEN 3 : PROCload_preferences(FALSE)
     ENDCASE
   WHEN ppane%
    CASE icon% OF
     WHEN 2  : PROCset_icon_state(ppane%,66,0,ABS(NOT FNicon_selected(ppane%,2) OR (NOT os_350%)),0)
     WHEN 3  : PROCset_icon_state(ppane%,38,0,ABS(NOT FNicon_selected(ppane%,3)),0)
               PROCset_icon_state(ppane%,39,0,ABS(NOT FNicon_selected(ppane%,3)),0)
               PROCset_icon_state(ppane%,40,0,ABS(NOT FNicon_selected(ppane%,3)),0)
     WHEN 28 : PROCset_icon_state(ppane%,67,0,ABS(NOT FNicon_selected(ppane%,28)),0)
     WHEN 32 : PROCset_icon_state(ppane%,63,0,ABS(NOT FNicon_selected(ppane%,32)),0)
               PROCset_icon_state(ppane%,57,0,ABS(NOT FNicon_selected(ppane%,32)),0)
               IF FNicon_shaded(ppane%,63) AND FNfind_caret(ppane%,63) THEN PROCend_caret(ppane%,71)
     WHEN 33 : PROCset_icon_state(ppane%,35,0,ABS(NOT FNicon_selected(ppane%,33)),0)
               PROCset_icon_state(ppane%,36,0,ABS(NOT FNicon_selected(ppane%,33)),0)
               PROCset_icon_state(ppane%,37,0,ABS(NOT FNicon_selected(ppane%,33)),0)
               IF FNicon_shaded(ppane%,35) AND FNfind_caret(ppane%,35) THEN PROCend_caret(ppane%,56)
     WHEN 69,70 : PROCset_icon_state(ppane%,58,0,ABS(NOT FNicon_selected(ppane%,70)),0)
                  IF FNicon_shaded(ppane%,58) AND FNfind_caret(ppane%,58) THEN PROCend_caret(ppane%,71)
     ENDCASE
   WHEN print_wind%
    CASE icon% OF
     WHEN 6 : PROCdecrease_icon(print_wind%,5,0) : PROCcalculate_print_values
     WHEN 7 : PROCincrease_icon(print_wind%,5,pmax_size%) : PROCcalculate_print_values
     WHEN 10 : PROCdecrease_icon(print_wind%,9,0) : PROCcalculate_print_values
     WHEN 11 : PROCincrease_icon(print_wind%,9,pmax_top%) : PROCcalculate_print_values
     WHEN 14 : PROCdecrease_icon(print_wind%,13,0) : PROCcalculate_print_values
     WHEN 15 : PROCincrease_icon(print_wind%,13,pmax_base%) : PROCcalculate_print_values
     WHEN 18 : PROCdecrease_icon(print_wind%,17,0) : PROCcalculate_print_values
     WHEN 19 : PROCincrease_icon(print_wind%,17,pmax_left%) : PROCcalculate_print_values
     WHEN 25 : PROCcalculate_print_values
     WHEN 33 : PROCset_icon_state(print_wind%,33,1,0,0)
               PROCset_icon_state(print_wind%,36,0,1,0)
               PROCset_icon_state(print_wind%,37,0,1,0)
               IF FNfind_caret(print_wind%,36) OR FNfind_caret(print_wind%,37) THEN PROCend_caret(print_wind%,-1)
     WHEN 34 : PROCset_icon_state(print_wind%,34,1,0,0)
               PROCset_icon_state(print_wind%,36,0,0,0)
               PROCset_icon_state(print_wind%,37,0,0,0)
               IF FNfind_caret(print_wind%,-1) THEN PROCend_caret(print_wind%,36)
     ENDCASE
   WHEN printh_wind%
    CASE icon% OF
     WHEN 6 : PROCdecrease_icon(printh_wind%,5,0) : PROCcalculate_printh_values
     WHEN 7 : PROCincrease_icon(printh_wind%,5,pmax_size%) : PROCcalculate_printh_values
     WHEN 10 : PROCdecrease_icon(printh_wind%,9,0) : PROCcalculate_printh_values
     WHEN 11 : PROCincrease_icon(printh_wind%,9,phmax_top%) : PROCcalculate_printh_values
     WHEN 16 : PROCdecrease_icon(printh_wind%,15,0) : PROCcalculate_printh_values
     WHEN 17 : PROCincrease_icon(printh_wind%,15,phmax_left%) : PROCcalculate_printh_values
     ENDCASE
   WHEN printt_wind%
    CASE icon% OF
     WHEN 4 : PROCdecrease_icon(printt_wind%,3,0) : PROCcalculate_printt_values
     WHEN 5 : PROCincrease_icon(printt_wind%,3,ptmax_size%) : PROCcalculate_printt_values
     WHEN 8 : PROCdecrease_icon(printt_wind%,7,0) : PROCcalculate_printt_values
     WHEN 9 : PROCincrease_icon(printt_wind%,7,ptmax_top%) : PROCcalculate_printt_values
     WHEN 12 : PROCdecrease_icon(printt_wind%,11,0) : PROCcalculate_printt_values
     WHEN 13 : PROCincrease_icon(printt_wind%,11,ptmax_base%) : PROCcalculate_printt_values
     WHEN 16 : PROCdecrease_icon(printt_wind%,15,0) : PROCcalculate_printt_values
     WHEN 17 : PROCincrease_icon(printt_wind%,15,ptmax_left%) : PROCcalculate_printt_values
     WHEN 31 : PROCset_icon_state(printt_wind%,31,1,0,0)
               PROCset_icon_state(printt_wind%,34,0,1,0)
               PROCset_icon_state(printt_wind%,35,0,1,0)
               IF FNfind_caret(printt_wind%,34) OR FNfind_caret(printt_wind%,35) THEN PROCend_caret(printt_wind%,-1)
     WHEN 32 : PROCset_icon_state(printt_wind%,32,1,0,0)
               PROCset_icon_state(printt_wind%,34,0,0,0)
               PROCset_icon_state(printt_wind%,35,0,0,0)
               IF FNfind_caret(printt_wind%,-1) THEN PROCend_caret(printt_wind%,34)
     ENDCASE
   WHEN search_wind%
    CASE icon% OF
     WHEN 6 : PROCset_icon_state(search_wind%,6,1,0,0)
     WHEN 7 : PROCset_icon_state(search_wind%,7,1,0,0)
     WHEN 17 : IF no_w% THEN PROCdisplay_menu(wmenu%,x%,y%) : hmenu_no%=1
     WHEN 18 : IF no_w% THEN PROCdisplay_menu(wmenu%,x%,y%) : hmenu_no%=2
     ENDCASE
   WHEN so_wind%
    CASE icon% OF
     WHEN 18 : IF no_y% THEN PROCdisplay_menu(ymenu%,x%,y%) : hmenu_no%=2
     WHEN 19 : IF no_z% THEN PROCdisplay_menu(zmenu%,x%,y%) : hmenu_no%=2
     WHEN 25 : PROCset_icon_state(so_wind%,25,1,0,0)
               PROCset_icon_state(so_wind%,3,0,0,0)
               PROCset_icon_state(so_wind%,24,0,0,0)
               PROCset_icon_state(so_wind%,8,0,1,0)
               IF FNfind_caret(so_wind%,8) THEN  PROCend_caret(so_wind%,3)
     WHEN 24 : PROCset_icon_state(so_wind%,25,0,0,0)
               PROCset_icon_state(so_wind%,3,0,1,0)
               PROCset_icon_state(so_wind%,24,1,0,0)
               PROCset_icon_state(so_wind%,8,0,0,0)
               IF FNfind_caret(so_wind%,3) THEN PROCend_caret(so_wind%,8)
     ENDCASE
   WHEN loadcsv_wind%
    CASE icon% OF
     WHEN 2 : PROCset_icon_state(loadcsv_wind%,2,1,0,0)
              PROCset_icon_state(loadcsv_wind%,3,0,0,0)
              PROCset_icon_state(loadcsv_wind%,4,0,1,0)
              PROCset_icon_state(loadcsv_wind%,5,0,1,0)
              $FNindirection(loadcsv_wind%,12)="From:"
              $FNindirection(loadcsv_wind%,16)="To:"
              $FNindirection(loadcsv_wind%,20)="Amount:"
              PROCredraw_icon(loadcsv_wind%,12)
              PROCredraw_icon(loadcsv_wind%,16)
              PROCredraw_icon(loadcsv_wind%,20)
     WHEN 3 : PROCset_icon_state(loadcsv_wind%,2,0,0,0)
              PROCset_icon_state(loadcsv_wind%,3,1,0,0)
              PROCset_icon_state(loadcsv_wind%,4,0,0,0)
              PROCset_icon_state(loadcsv_wind%,5,0,0,0)
              $FNindirection(loadcsv_wind%,12)="From/To:"
              $FNindirection(loadcsv_wind%,16)="Debits:"
              $FNindirection(loadcsv_wind%,20)="Credits:"
              PROCredraw_icon(loadcsv_wind%,12)
              PROCredraw_icon(loadcsv_wind%,16)
              PROCredraw_icon(loadcsv_wind%,20)
     WHEN 10 : $FNindirection(loadcsv_wind%,9)=FNincrement_field_number(9,-1)
     WHEN 11 : $FNindirection(loadcsv_wind%,9)=FNincrement_field_number(9,1)
     WHEN 14 : $FNindirection(loadcsv_wind%,13)=FNincrement_field_number(13,-1)
     WHEN 15 : $FNindirection(loadcsv_wind%,13)=FNincrement_field_number(13,1)
     WHEN 18 : $FNindirection(loadcsv_wind%,17)=FNincrement_field_number(17,-1)
     WHEN 19 : $FNindirection(loadcsv_wind%,17)=FNincrement_field_number(17,1)
     WHEN 22 : $FNindirection(loadcsv_wind%,21)=FNincrement_field_number(21,-1)
     WHEN 23 : $FNindirection(loadcsv_wind%,21)=FNincrement_field_number(21,1)
     WHEN 26 : $FNindirection(loadcsv_wind%,25)=FNincrement_field_number(25,-1)
     WHEN 27 : $FNindirection(loadcsv_wind%,25)=FNincrement_field_number(25,1)
     ENDCASE
   WHEN loadacc_wind%
    CASE icon% OF
     WHEN 8 : PROCset_icon_state(loadacc_wind%,8,1,0,0)
              PROCset_icon_state(loadacc_wind%,11,0,1,0)
              PROCset_icon_state(loadacc_wind%,12,0,1,0)
              IF FNfind_caret(loadacc_wind%,11) THEN PROCend_caret(loadacc_wind%,-1)
     WHEN 9 : PROCset_icon_state(loadacc_wind%,9,1,0,0)
              PROCset_icon_state(loadacc_wind%,11,0,1,0)
              PROCset_icon_state(loadacc_wind%,12,0,1,0)
              IF FNfind_caret(loadacc_wind%,11) THEN PROCend_caret(loadacc_wind%,-1)
     WHEN 10 : PROCset_icon_state(loadacc_wind%,10,1,0,0)
               PROCset_icon_state(loadacc_wind%,12,0,0,0)
               IF FNfind_caret(loadacc_wind%,-1) THEN PROCend_caret(loadacc_wind%,11)
     WHEN 13 : PROCset_icon_state(loadacc_wind%,13,1,0,0)
               PROCset_icon_state(loadacc_wind%,11,0,1,0)
               PROCset_icon_state(loadacc_wind%,12,0,1,0)
               IF FNfind_caret(loadacc_wind%,11) THEN PROCend_caret(loadacc_wind%,-1)
     ENDCASE
   WHEN date_wind%
    CASE icon% OF
     WHEN 1 : PROCset_icon_state(date_wind%,1,1,0,0)
              PROCset_icon_state(date_wind%,2,0,0,0)
              PROCset_icon_state(date_wind%,3,0,1,0)
     WHEN 2 : PROCset_icon_state(date_wind%,1,0,0,0)
              PROCset_icon_state(date_wind%,2,1,0,0)
              PROCset_icon_state(date_wind%,3,0,0,0)
    ENDCASE
   ENDCASE
 ENDCASE
ENDPROC
:
DEF PROCkey_press(window%,icon%,x%,y%,key%)
CASE key% OF
 WHEN 13
  CASE window% OF
   WHEN pane2% : PROCadd_line
   WHEN so_wind% : PROCchange_so
   WHEN ed_acc% : PROCchange_account
   WHEN inb_wind% : PROCinitial_balance
   WHEN save% : PROCquick_save(1)
   WHEN exp_wind% : PROCquick_save(d_type%+1)
   WHEN set_title% : PROCset_new_title
   WHEN he_wind% : PROCchange_head
   WHEN ppane% : PROCsave_preferences(FALSE):PROCclose_window(pref_wind%):PROCclose_window(ppane%)
   WHEN print_wind% : PROCset_print_values(FALSE) : PROCprint_account
   WHEN printh_wind% : PROCset_printh_values(FALSE) : PROCprint_headers
   WHEN printt_wind% : PROCset_printt_values(FALSE) : PROCprint_transactions
   WHEN printcon_wind% : PROCset_printcodes(FALSE) : PROCclose_window(printcon_wind%)
   WHEN acc_wind% : PROCcancel_account : PROCclose_window(acc_wind%)
   WHEN sl_wind% : PROCcancel_so : PROCclose_window(sl_wind%) : PROCclose_window(spane%)
   WHEN head_wind% : PROCcancel_head : PROCclose_window(head_wind%) : PROCclose_window(hpane%)
   WHEN loadcsv_wind% : PROCload_csv
   WHEN loadacc_wind% : PROCload_account
   WHEN search_wind% : PROCsearch(TRUE,FALSE,FALSE)
   WHEN found_wind% : PROCclose_window(found_wind%) : PROCsearch(FALSE,TRUE,FALSE)
   WHEN goto_wind%
    CASE g_type% OF
     WHEN 1 : PROCgoto_line(main%,VAL($FNindirection(goto_wind%,0)))
     WHEN 2 : PROCgoto_line(acc_view%,VAL($FNindirection(goto_wind%,0))+1)
     ENDCASE
   WHEN date_wind%: other_date$=$FNindirection(date_wind%,3)
                    system_date%=FNicon_selected(date_wind%,1)
                    IF system_date% THEN PROCdisplay_menu(-1,0,0)
                    PROCget_date
   ENDCASE
 WHEN &1B
  CASE window% OF
   WHEN so_wind% : PROCcancel_so
   WHEN ed_acc% : PROCcancel_account
   WHEN he_wind% : PROCcancel_head
   WHEN ppane% : PROCload_preferences(FALSE):PROCclose_window(pref_wind%):PROCclose_window(ppane%)
   WHEN print_wind% : PROCclose_window(print_wind%)
   WHEN printh_wind% : PROCclose_window(printh_wind%)
   WHEN printt_wind% : PROCclose_window(printt_wind%)
   WHEN printcon_wind% : PROCclose_window(printcon_wind%)
   WHEN loadcsv_wind% : PROCclose_window(loadcsv_wind%)
   WHEN loadacc_wind% : PROCclose_window(loadacc_wind%)
   WHEN search_wind% : PROCclose_window(search_wind%)
   WHEN found_wind% : PROCclose_window(found_wind%)
   ENDCASE
 WHEN 3  : IF select%>0 THEN PROCcopy_line
 WHEN 4  : $FNindirection(pane2%,0)=FNdecode_given_date(date%)
           PROCredraw_icon(pane2%,0)
           IF FNfind_caret(pane2%,0) THEN PROCend_caret(pane2%,0)
 WHEN 5  : PROCclear_edit_bar
 WHEN 11 : IF select%>0 THEN
            IF FNpreference(2) THEN
             mess%=1 : PROCmessage("Delete?|<S>","Cancel","","Delete")
            ELSE
             PROCdelete_line
            ENDIF
           ENDIF
 WHEN 20 : $FNindirection(set_title%,0)=account_name$ : PROCopen_as_menu(set_title%,size_x%/2,size_y%/2)
 WHEN 22 : IF select%>0 THEN PROCreplace_line
 WHEN 24 : IF select%>0 THEN
            IF FNpreference(3) THEN
             mess%=2 : PROCmessage("Cut?|<S>","Cancel","","Cut")
            ELSE
             PROCcut_line
            ENDIF
           ENDIF
 WHEN 26 : PROCselect_line(0)
 WHEN 30 : PROCpage_home
 WHEN &180 : IF view_account%>-1 THEN PROCset_print_window : PROCopen_window(print_wind%) : PROCend_caret(print_wind%,-1)
 WHEN &181 : PROCadd_line
 WHEN &183 : IF FNpreference(13) THEN
              PROCquick_save(1)
             ELSE
              PROCopen_as_menu(save%,size_x%/2,size_y%/2)
             ENDIF
 WHEN &184 : PROCsearch_window
             PROCopen_at(search_wind%,size_x%/2,size_y%/2)
             PROCend_caret(search_wind%,2)
 WHEN &185 : g_type%=1
             $g_title%=FNmess_trans("GotoTrans")
             $FNindirection(goto_wind%,0)=""
             PROCopen_as_menu(goto_wind%,size_x%/2,size_y%/2)
 WHEN &186 : PROCsort
 WHEN &187 : PROCopen_window(bal_wind%) : PROCopen_window(bpane%)
 WHEN &188 : PROCopen_window(hel_wind%) : PROCopen_window(lpane%)
 WHEN &18E : PROCline_down
 WHEN &18F : PROCline_up
 WHEN &190 : PROCset_printh_window : PROCopen_window(printh_wind%) : PROCend_caret(printh_wind%,-1)
 WHEN &191 : PROCfile_info : PROCopen_as_menu(finfo_wind%,size_x%/2,size_y%/2)
 WHEN &193 : IF view_account%>-1 THEN
              $FNindirection(exp_wind%,0)=sprite_account$
              $FNindirection(exp_wind%,1)=FNmess_trans("AccountF")
              $FNindirection(exp_wind%,5)=$FNindirection(acc_wind%,view_account%+1)
              $FNindirection(exp_wind%,6)=FNmess_trans("Account")+":"
              $FNindirection(exp_wind%,7)=FNmess_trans("Dates")
              PROCset_export_extent(1)
              d_type%=1
              PROCopen_as_menu(exp_wind%,size_x%/2,size_y%/2)
             ENDIF
 WHEN &195 : IF view_account%>-1 THEN
              g_type%=2
              $g_title%=FNmess_trans("GotoLine")
              $FNindirection(goto_wind%,0)=""
              PROCopen_as_menu(goto_wind%,size_x%/2,size_y%/2)
             ENDIF
 WHEN &196 : PROCopen_window(sl_wind%) : PROCopen_window(spane%) : PROCend_caret(sl_wind%,-1)
 WHEN &197 : PROCopen_window(acc_wind%) : PROCend_caret(acc_wind%,-1)
 WHEN &198 : PROCopen_window(head_wind%) : PROCopen_window(hpane%) : PROCend_caret(head_wind%,-1)
 WHEN &19E : PROCpage_down
 WHEN &19F : PROCpage_up
 WHEN &1A0 : PROCset_printt_window : PROCopen_window(printt_wind%) : PROCend_caret(printt_wind%,-1)
 WHEN &1A1 : PROCrun_help
 WHEN &1A2 : PROCclose_window(main%) : PROCclose_window(pane%) : PROCclose_window(pane2%)
             PROCclose_window(acc_view%) : PROCclose_window(apane%)
             view_account%=-1 : PROCset_tool_state
             PROCclose_window(hel_wind%) : PROCclose_window(lpane%)
             PROCclose_window(bal_wind%) : PROCclose_window(bpane%)
             PROCclose_window(swl_wind%) : PROCclose_window(wpane%)
 WHEN &1A3 : IF view_account%>-1 THEN
              $FNindirection(exp_wind%,0)=sprite_csv$
              $FNindirection(exp_wind%,1)=FNmess_trans("CSV")
              $FNindirection(exp_wind%,5)=$FNindirection(acc_wind%,view_account%+1)
              $FNindirection(exp_wind%,6)=FNmess_trans("Account")+":"
              $FNindirection(exp_wind%,7)=FNmess_trans("LineNo")
              $FNindirection(exp_wind%,8)=FNmess_trans("Heads")
              $FNindirection(exp_wind%,9)=FNmess_trans("Quotes")
              PROCset_export_extent(3)
              d_type%=3
              PROCopen_as_menu(exp_wind%,size_x%/2,size_y%/2)
             ENDIF
 WHEN &1A6 : PROCopen_window(swl_wind%) : PROCopen_window(wpane%)
 WHEN &1AE : PROCpage_end
 WHEN &1AF : PROCpage_home
 WHEN &1B0 : PROCset_code_window : PROCopen_window(printcon_wind%) : PROCend_caret(printcon_wind%,1)
 WHEN &1B3 : IF view_account%>-1 THEN
              $FNindirection(exp_wind%,0)=sprite_text$
              $FNindirection(exp_wind%,1)=FNmess_trans("TSV")
              $FNindirection(exp_wind%,5)=$FNindirection(acc_wind%,view_account%+1)
              $FNindirection(exp_wind%,6)=FNmess_trans("Account")+":"
              $FNindirection(exp_wind%,7)=FNmess_trans("LineNo")
              $FNindirection(exp_wind%,8)=FNmess_trans("Heads")
              PROCset_export_extent(2)
              d_type%=4
              PROCopen_as_menu(exp_wind%,size_x%/2,size_y%/2)
             ENDIF
 WHEN &1CD : PROCinsert_line_below
 WHEN &1DD : PROCinsert_line_above
 OTHERWISE : SYS "Wimp_ProcessKey",key%
 ENDCASE
ENDPROC
:
DEF PROCmenu_selection(s1%,s2%,s3%,s4%)
SYS "Wimp_GetPointerInfo",,q%
stay_up%=(q%!8=1)
CASE menuup% OF
 WHEN imenu%
  CASE s1% OF
   WHEN 0 : PROCopen_as_menu(info%,size_x%/2,size_y%/2) : stay_up%=FALSE
   WHEN 1 : PROCscroll_top(ppane%) : PROCopen_window(pref_wind%) : PROCopen_window(ppane%)
            IF FNicon_shaded(ppane%,35) THEN PROCend_caret(ppane%,56) ELSE PROCend_caret(ppane%,35)
   WHEN 2 : PROCset_code_window : PROCopen_window(printcon_wind%) : PROCend_caret(printcon_wind%,1)
   WHEN 3 : PROCrun_help
   WHEN 4 : IF modified% AND FNpreference(5) THEN
             mess%=3 : PROCmessage("NotSaved","Cancel","Save","Quit")
            ELSE
             quit%=TRUE
            ENDIF
   ENDCASE
 WHEN mmenu%
  CASE s1% OF
   WHEN 0
    CASE s2% OF
     WHEN 0 : PROCopen_as_menu(info%,size_x%/2,size_y%/2) : stay_up%=FALSE
     WHEN 1 : PROCfile_info : PROCopen_as_menu(finfo_wind%,size_x%/2,size_y%/2) : stay_up%=FALSE
     WHEN 4 : IF modified% AND FNpreference(8) THEN
             mess%=6 : PROCmessage("ClearFile?","Cancel","","Clear")
            ELSE
             PROCclear_file : PROCredraw_main : PROCrecalc
            ENDIF
     ENDCASE
   WHEN 1 : PROCquick_save(1)
   WHEN 2
    CASE s2% OF
     WHEN 0 : PROCsearch_window : PROCopen_window(search_wind%) : PROCend_caret(search_wind%,2)
     WHEN 2 : PROCsort
     WHEN 3 : PROCupdate_file
     WHEN 5 : PROCset_printt_window
              PROCopen_window(printt_wind%) : PROCend_caret(printt_wind%,-1)
     ENDCASE
   WHEN 3
    CASE s2% OF
     WHEN 0 : IF s3%>-1 THEN PROCshow_account(s3%)
     WHEN 1 : PROCopen_window(bal_wind%) : PROCopen_window(bpane%)
     WHEN 2 : PROCopen_window(acc_wind%) : PROCend_caret(acc_wind%,-1)
     WHEN 4 : PROCset_print_window
              PROCopen_window(print_wind%) : PROCend_caret(print_wind%,-1)
     ENDCASE
   WHEN 4
    CASE s2% OF
     WHEN 0 : PROCopen_window(sl_wind%) : PROCopen_window(spane%) : PROCend_caret(sl_wind%,-1)
     WHEN 1 : PROCopen_window(swl_wind%) : PROCopen_window(wpane%)
     WHEN 2 : PROCadd_standing_orders(TRUE)
     ENDCASE
   WHEN 5
    CASE s2% OF
     WHEN 0 : PROCopen_window(head_wind%) : PROCopen_window(hpane%) : PROCend_caret(head_wind%,-1)
     WHEN 1 : PROCopen_window(hel_wind%) : PROCopen_window(lpane%)
     WHEN 3 : PROCset_printh_window : PROCopen_window(printh_wind%) : PROCend_caret(printh_wind%,-1)
     ENDCASE
   WHEN 6
    CASE s2% OF
     WHEN 0 : PROCadd_line
     WHEN 1 : PROCinsert_line_above
     WHEN 2 : PROCinsert_line_below
     ENDCASE
   WHEN 7
    CASE s2% OF
     WHEN 0 : IF FNpreference(3) THEN
               mess%=2 : PROCmessage("Cut?|<S>","Cancel","","Cut")
              ELSE
               PROCcut_line
              ENDIF
     WHEN 1 : PROCcopy_line
     WHEN 2 : PROCreplace_line
     WHEN 3 : IF FNpreference(2) THEN
               mess%=1 : PROCmessage("Delete?|<S>","Cancel","","Delete")
              ELSE
               PROCdelete_line
              ENDIF
     WHEN 4 : IF FNpreference(4) THEN
             mess%=4 : PROCmessage("Remove?|<S>","Cancel","","Remove")
            ELSE
             PROCremove_lines
            ENDIF
     WHEN 5 : PROCselect_line(0)
     ENDCASE
   ENDCASE
 WHEN vmenu%
  CASE s1% OF
   WHEN 2 : IF s2%>-1 THEN PROCshow_account(s2%)
   WHEN 3 : PROCopen_window(bal_wind%) : PROCopen_window(bpane%)
   WHEN 4 : PROCopen_window(acc_wind%) : PROCend_caret(acc_wind%,-1)
   WHEN 6 : PROCset_print_window
            PROCopen_window(print_wind%) : PROCend_caret(print_wind%,-1)
   ENDCASE
 WHEN wmenu%
  CASE hmenu_no% OF
   WHEN 1 : $FNindirection(search_wind%,2)=$FNget_menu_text(wmenu%,s1%) : PROCredraw_icon(search_wind%,2) : IF FNfind_caret(search_wind%,2) THEN PROCend_caret(search_wind%,2)
   WHEN 2 : $FNindirection(search_wind%,3)=$FNget_menu_text(wmenu%,s1%) : PROCredraw_icon(search_wind%,3) : IF FNfind_caret(search_wind%,3) THEN PROCend_caret(search_wind%,3)
   ENDCASE
 WHEN ymenu%
  CASE hmenu_no% OF
   WHEN 1 : $FNindirection(pane2%,1)=$FNget_menu_text(ymenu%,s1%) : PROCredraw_icon(pane2%,1) : IF FNfind_caret(pane2%,1) THEN PROCend_caret(pane2%,1)
   WHEN 2 : $FNindirection(so_wind%,15)=$FNget_menu_text(ymenu%,s1%) : PROCredraw_icon(so_wind%,15) : IF FNfind_caret(so_wind%,15) THEN PROCend_caret(so_wind%,15)
   ENDCASE
 WHEN zmenu%
  CASE hmenu_no% OF
   WHEN 1 : $FNindirection(pane2%,2)=$FNget_menu_text(zmenu%,s1%) : PROCredraw_icon(pane2%,2) : IF FNfind_caret(pane2%,2) THEN PROCend_caret(pane2%,2)
   WHEN 2 : $FNindirection(so_wind%,17)=$FNget_menu_text(zmenu%,s1%) : PROCredraw_icon(so_wind%,17) : IF FNfind_caret(so_wind%,17) THEN PROCend_caret(so_wind%,17)
   WHEN 3 : REM Search Window
   ENDCASE
 WHEN cmenu%
  CASE c_menu% OF
   WHEN 1 : PROCset_icon_colour(ppane%,38,7,s1%) : PROCset_cmenu_tick(FNget_icon_colour(ppane%,38))
   WHEN 2 : PROCset_icon_colour(ppane%,41,7,s1%) : PROCset_cmenu_tick(FNget_icon_colour(ppane%,41))
   WHEN 3 : PROCset_icon_colour(ppane%,44,7,s1%) : PROCset_cmenu_tick(FNget_icon_colour(ppane%,44))
   WHEN 4 : PROCset_icon_colour(ppane%,47,7,s1%) : PROCset_cmenu_tick(FNget_icon_colour(ppane%,47))
   WHEN 5 : PROCset_icon_colour(ppane%,50,7,s1%) : PROCset_cmenu_tick(FNget_icon_colour(ppane%,50))
   WHEN 6 : PROCset_icon_colour(ppane%,53,7,s1%) : PROCset_cmenu_tick(FNget_icon_colour(ppane%,53))
   ENDCASE
 WHEN amenu%
  CASE amenu_no% OF
   WHEN 1 : $FNindirection(pane2%,1)=$FNindirection(acc_wind%,s1%+1) : PROCredraw_icon(pane2%,1) : IF FNfind_caret(pane2%,1) THEN PROCend_caret(pane2%,1)
   WHEN 2 : $FNindirection(pane2%,2)=$FNindirection(acc_wind%,s1%+1) : PROCredraw_icon(pane2%,2) : IF FNfind_caret(pane2%,2) THEN PROCend_caret(pane2%,2)
   WHEN 3 : PROCshow_account(s1%)
   WHEN 4 : $FNindirection(so_wind%,15)=$FNindirection(acc_wind%,s1%+1) : PROCredraw_icon(so_wind%,15) : IF FNfind_caret(so_wind%,15) THEN PROCend_caret(so_wind%,15)
   WHEN 5 : $FNindirection(so_wind%,17)=$FNindirection(acc_wind%,s1%+1) : PROCredraw_icon(so_wind%,17) : IF FNfind_caret(so_wind%,17) THEN PROCend_caret(so_wind%,17)
   WHEN 6 : $FNindirection(search_wind%,2)=$FNindirection(acc_wind%,s1%+1) : PROCredraw_icon(search_wind%,2) : IF FNfind_caret(search_wind%,2) THEN PROCend_caret(search_wind%,2)
   WHEN 7 : $FNindirection(search_wind%,3)=$FNindirection(acc_wind%,s1%+1) : PROCredraw_icon(search_wind%,3) : IF FNfind_caret(search_wind%,3) THEN PROCend_caret(search_wind%,3)
   WHEN 8 : $FNindirection(loadcsv_wind%,4)=$FNindirection(acc_wind%,s1%+1) : PROCredraw_icon(loadcsv_wind%,4)
   WHEN 9 : $FNindirection(loadacc_wind%,0)=$FNindirection(acc_wind%,s1%+1) : PROCredraw_icon(loadacc_wind%,0)
   ENDCASE
 ENDCASE
IF stay_up% THEN PROCdisplay_menu(menuup%,0,0)
ENDPROC
:
DEF PROCrecieve_message(code%)
CASE code% OF
 WHEN 0 : quit%=TRUE
 WHEN 2 : CASE drag_from% OF
           WHEN 1 : $FNindirection(save%,1)=FNstring(b%+44) : PROCsave
           WHEN 2 : $FNindirection(exp_wind%,1)=FNstring(b%+44) : PROCsave_account
           WHEN 3 : $FNindirection(exp_wind%,1)=FNstring(b%+44) : PROCsave_text
           WHEN 4 : $FNindirection(exp_wind%,1)=FNstring(b%+44) : PROCsave_csv
           WHEN 5 : $FNindirection(exp_wind%,1)=FNstring(b%+44) : PROCsave_tsv
           WHEN 6 : $FNindirection(exp_wind%,1)=FNstring(b%+44) : PROCsave_csvh
           WHEN 7 : $FNindirection(exp_wind%,1)=FNstring(b%+44) : PROCsave_tsvh
           WHEN 8 : $FNindirection(exp_wind%,1)=FNstring(b%+44) : PROCsave_texth
           WHEN 9 : $FNindirection(exp_wind%,1)=FNstring(b%+44) : PROCsave_csvt
           WHEN 10 : $FNindirection(exp_wind%,1)=FNstring(b%+44) : PROCsave_tsvt
           WHEN 11 : $FNindirection(exp_wind%,1)=FNstring(b%+44) : PROCsave_textt
           ENDCASE
 WHEN 3 : CASE b%!40 OF
           WHEN file_type_accounts% : IF modified% AND FNpreference(23) THEN
                        mess%=11 : PROCmessage("LoadNew?","Cancel","","Load")
                       ELSE
                        PROCload
                       ENDIF
           WHEN file_type_csv% : PROCinitialise_csv_load
           WHEN file_type_text% : PROCinitialise_tsv_load
           WHEN file_type_account% : PROCinitialise_account_load
           OTHERWISE : mess%=0 : PROCmessage("FileType","","OK","")
           ENDCASE
 WHEN 5 : PROCquick_load
 WHEN 8 : IF FNpreference(24) AND modified% THEN PROCpre_quit
 WHEN &502 : PROChelp
 WHEN &400C0 : PROCsub_menu(b%!20,b%!24,b%!28,b%!32,b%!36,b%!40,b%!44)
 WHEN &400C1 : PROCget_size
 WHEN &400CF : PROCload_font
 ENDCASE
ENDPROC
:
DEF PROCsub_menu(w%,x%,y%,s1%,s2%,s3%,s4%)
CASE w% OF
 WHEN set_title%   : $FNindirection(set_title%,0)=account_name$
 WHEN inb_wind%    : $FNindirection(inb_wind%,1)=FNpoint(initial%(view_account%))
 WHEN finfo_wind%  : PROCfile_info
 WHEN goto_wind%   : $FNindirection(goto_wind%,0)=""
                     IF menuup%=mmenu% THEN
                      g_type%=1 : $g_title%=FNmess_trans("GotoTrans")
                     ELSE
                      g_type%=2 : $g_title%=FNmess_trans("GotoLine")
                     ENDIF
 WHEN date_wind%   : PROCset_icon_state(date_wind%,1,ABS(system_date%),0,0)
                     PROCset_icon_state(date_wind%,2,ABS(NOT system_date%),0,0)
                     PROCset_icon_state(date_wind%,3,0,ABS(system_date%),0)
                     $FNindirection(date_wind%,3)=other_date$
 WHEN exp_wind%
  CASE s1% OF
   WHEN 5
    CASE menuup% OF
     WHEN vmenu% : $FNindirection(exp_wind%,6)=FNmess_trans("Account")+":"
      CASE s2% OF
       WHEN 0 : $FNindirection(exp_wind%,0)=sprite_account$
                $FNindirection(exp_wind%,1)=FNmess_trans("AccountF")
                $FNindirection(exp_wind%,5)=$FNindirection(acc_wind%,view_account%+1)
                PROCset_export_extent(1)
                $FNindirection(exp_wind%,7)=FNmess_trans("Dates")
                d_type%=1
       WHEN 1 : $FNindirection(exp_wind%,0)=sprite_csv$
                $FNindirection(exp_wind%,1)=FNmess_trans("CSV")
                $FNindirection(exp_wind%,5)=$FNindirection(acc_wind%,view_account%+1)
                $FNindirection(exp_wind%,7)=FNmess_trans("LineNo")
                $FNindirection(exp_wind%,8)=FNmess_trans("Heads")
                $FNindirection(exp_wind%,9)=FNmess_trans("Quotes")
                PROCset_export_extent(3)
                d_type%=3
       WHEN 2 : $FNindirection(exp_wind%,0)=sprite_text$
                $FNindirection(exp_wind%,1)=FNmess_trans("TSV")
                $FNindirection(exp_wind%,5)=$FNindirection(acc_wind%,view_account%+1)
                $FNindirection(exp_wind%,7)=FNmess_trans("LineNo")
                $FNindirection(exp_wind%,8)=FNmess_trans("Heads")
                PROCset_export_extent(2)
                d_type%=4
       WHEN 3 : $FNindirection(exp_wind%,0)=sprite_text$
                $FNindirection(exp_wind%,1)=FNmess_trans("Text")
                $FNindirection(exp_wind%,5)=$FNindirection(acc_wind%,view_account%+1)
                PROCset_export_extent(3)
                $FNindirection(exp_wind%,7)=FNmess_trans("LineNo")
                $FNindirection(exp_wind%,8)=FNmess_trans("Heads")
                $FNindirection(exp_wind%,9)=FNmess_trans("DateFile")
                d_type%=2
       ENDCASE
     WHEN mmenu% : $FNindirection(exp_wind%,6)=FNmess_trans("ToExp")+":"
      CASE s3% OF
       WHEN 0 : $FNindirection(exp_wind%,0)=sprite_csv$
                $FNindirection(exp_wind%,1)=FNmess_trans("CSV")
                $FNindirection(exp_wind%,5)=FNmess_trans("Head")
                $FNindirection(exp_wind%,7)=FNmess_trans("Heads")
                $FNindirection(exp_wind%,8)=FNmess_trans("Quotes")
                PROCset_export_extent(2)
                d_type%=5
       WHEN 1 : $FNindirection(exp_wind%,0)=sprite_text$
                $FNindirection(exp_wind%,1)=FNmess_trans("TSV")
                $FNindirection(exp_wind%,5)=FNmess_trans("Head")
                $FNindirection(exp_wind%,7)=FNmess_trans("Heads")
                PROCset_export_extent(1)
                d_type%=6
       WHEN 2 : $FNindirection(exp_wind%,0)=sprite_text$
                $FNindirection(exp_wind%,1)=FNmess_trans("Text")
                $FNindirection(exp_wind%,5)=FNmess_trans("Head")
                PROCset_export_extent(2)
                $FNindirection(exp_wind%,7)=FNmess_trans("Heads")
                $FNindirection(exp_wind%,8)=FNmess_trans("DateFile")
                d_type%=7
       ENDCASE
     ENDCASE
   WHEN 2 : $FNindirection(exp_wind%,6)=FNmess_trans("ToExp")+":"
    CASE s3% OF
     WHEN 0 : $FNindirection(exp_wind%,0)=sprite_csv$
              $FNindirection(exp_wind%,1)=FNmess_trans("CSV")
              $FNindirection(exp_wind%,5)=FNmess_trans("Trans")
              $FNindirection(exp_wind%,7)=FNmess_trans("LineNo")
              $FNindirection(exp_wind%,8)=FNmess_trans("Heads")
              $FNindirection(exp_wind%,9)=FNmess_trans("Quotes")
              PROCset_export_extent(3)
              d_type%=8
     WHEN 1 : $FNindirection(exp_wind%,0)=sprite_text$
              $FNindirection(exp_wind%,1)=FNmess_trans("TSV")
              $FNindirection(exp_wind%,5)=FNmess_trans("Trans")
              $FNindirection(exp_wind%,7)=FNmess_trans("LineNo")
              $FNindirection(exp_wind%,8)=FNmess_trans("Heads")
              PROCset_export_extent(2)
              d_type%=9
     WHEN 2 : $FNindirection(exp_wind%,0)=sprite_text$
              $FNindirection(exp_wind%,1)=FNmess_trans("Text")
              $FNindirection(exp_wind%,5)=FNmess_trans("Trans")
              PROCset_export_extent(3)
              $FNindirection(exp_wind%,7)=FNmess_trans("LineNo")
              $FNindirection(exp_wind%,8)=FNmess_trans("Heads")
              $FNindirection(exp_wind%,9)=FNmess_trans("DateFile")
              d_type%=10
     ENDCASE
   WHEN 3 : $FNindirection(exp_wind%,6)=FNmess_trans("Account")+":"
    CASE s3% OF
     WHEN 0 : $FNindirection(exp_wind%,0)=sprite_account$
              $FNindirection(exp_wind%,1)=FNmess_trans("AccountF")
              $FNindirection(exp_wind%,5)=$FNindirection(acc_wind%,view_account%+1)
              $FNindirection(exp_wind%,7)=FNmess_trans("Dates")
              PROCset_export_extent(1)
              d_type%=1
     WHEN 1 : $FNindirection(exp_wind%,0)=sprite_csv$
              $FNindirection(exp_wind%,1)=FNmess_trans("CSV")
              $FNindirection(exp_wind%,5)=$FNindirection(acc_wind%,view_account%+1)
              $FNindirection(exp_wind%,7)=FNmess_trans("LineNo")
              $FNindirection(exp_wind%,8)=FNmess_trans("Heads")
              $FNindirection(exp_wind%,9)=FNmess_trans("Quotes")
              PROCset_export_extent(3)
              d_type%=3
     WHEN 2 : $FNindirection(exp_wind%,0)=sprite_text$
              $FNindirection(exp_wind%,1)=FNmess_trans("TSV")
              $FNindirection(exp_wind%,5)=$FNindirection(acc_wind%,view_account%+1)
              $FNindirection(exp_wind%,7)=FNmess_trans("LineNo")
              $FNindirection(exp_wind%,8)=FNmess_trans("Heads")
              PROCset_export_extent(2)
              d_type%=4
     WHEN 3 : $FNindirection(exp_wind%,0)=sprite_text$
              $FNindirection(exp_wind%,1)=FNmess_trans("Text")
              $FNindirection(exp_wind%,5)=$FNindirection(acc_wind%,view_account%+1)
              PROCset_export_extent(3)
              $FNindirection(exp_wind%,7)=FNmess_trans("LineNo")
              $FNindirection(exp_wind%,8)=FNmess_trans("Heads")
              $FNindirection(exp_wind%,9)=FNmess_trans("DateFile")
              d_type%=2
     ENDCASE
   ENDCASE
 ENDCASE
SYS "Wimp_CreateSubMenu",,w%,x%,y%
ENDPROC
:
DEF PROCinitiate
LOCAL loop%, resources$
SYS "Hourglass_On"
:
DIM b% 4300,q% 256,az% 256, a% 255

REM Locate the application resources.

resources$ = FNresources_find_territory_folder("<Accounts+$Dir>.Resources")


DIM message_list% 38
!message_list%=&502
message_list%!4=&400C0
message_list%!8=&400C1
message_list%!12=&400CF
message_list%!16=2
message_list%!20=3
message_list%!24=5
message_list%!28=8
message_list%!32=0
quit%=FALSE
reset%=FALSE
$b%="TASK"
SYS "Wimp_Initialise",300,!b%,"Accounts+",message_list% TO wimp%
:
os_350%=(wimp%>=350)
:
:
DIM messages% 16
SYS "MessageTrans_FileInfo",,resources$+"Messages" TO flags%,,length%
IF flags% AND 1 THEN m_block%=0 ELSE DIM m_block% length%
SYS "MessageTrans_OpenFile",messages%,resources$+"Messages",m_block%
:
accounts%=10
per_account%=500
max_entries%=5000
s_orders%=30
headers%=30
:
DIM date%(max_entries%),from%(max_entries%),to%(max_entries%),trans%(max_entries%)
DIM from_text$(max_entries%),text$(max_entries%),a_fdate%(accounts%),a_tdate%(accounts%)
DIM run_bal%(accounts%,per_account%),line_ref%(accounts%,per_account%),total%(accounts%)
DIM initial%(accounts%),size%(accounts%),colours%(15),balance_off%(accounts%,1)
DIM s_to%(s_orders%),s_from%(s_orders%),s_from_text$(s_orders%),s_trans%(s_orders%)
DIM s_next%(s_orders%),s_type%(s_orders%),s_int%(s_orders%),s_ref%(7*s_orders%)
DIM h_fdate%(headers%),h_tdate%(headers%),s_dates%(7*s_orders%)
DIM matches%(accounts%+headers%),fill%(accounts%)
DIM h_type%(headers%),h_vals%(headers%,1),s$(4)
:
text$(0)="Opening balance"
:
icon%=FNicon_bar("!accounts+")
:
PROCget_size
:
sp_area%=FNload_sprites("<Accounts+$Dir>.Sprites")
:
banner%=FNload_sprites("<Accounts+$Dir>.Banner")
:
ind_size%=11000
:
DIM ind_data% ind_size%
PROCopen_templates(resources$+"Templates")
to%=FNload_template("Intro",b%,ind_data%,ind_size%)
b%!64=banner%
SYS "Wimp_CreateWindow",,b% TO welcome%
to%=FNload_template("Main",b%,to%,ind_size%-(to%-ind_data%))
m_title%=b%!72
SYS "Wimp_CreateWindow",,b% TO main%
to%=FNload_template("Pane",b%,to%,ind_size%-(to%-ind_data%))
b%!64=sp_area%
SYS "Wimp_CreateWindow",,b% TO pane%
to%=FNload_template("Pane2",b%,to%,ind_size%-(to%-ind_data%))
b%!64=sp_area%
SYS "Wimp_CreateWindow",,b% TO pane2%
to%=FNload_template("APane",b%,to%,ind_size%-(to%-ind_data%))
b%!64=sp_area%
SYS "Wimp_CreateWindow",,b% TO apane%
to%=FNload_template("Account",b%,to%,ind_size%-(to%-ind_data%))
a_title%=b%!72
SYS "Wimp_CreateWindow",,b% TO acc_view%
to%=FNload_template("Accounts",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO acc_wind%
to%=FNload_template("Balances",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO bal_wind%
to%=FNload_template("AccountE",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO ed_acc%
to%=FNload_template("NewTitle",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO set_title%
to%=FNload_template("Info",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO info%
to%=FNload_template("Save",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO save%
to%=FNload_template("SOrder",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO so_wind%
to%=FNload_template("SOList",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO sl_wind%
to%=FNload_template("SOPane",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO spane%
to%=FNload_template("SOPane",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO hpane%
to%=FNload_template("Preferences",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO pref_wind%
to%=FNload_template("PrefPane",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO ppane%
to%=FNload_template("InitBal",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO inb_wind%
to%=FNload_template("FileInfo",b%,to%,ind_size%-(to%-ind_data%))
f_title%=b%!72
SYS "Wimp_CreateWindow",,b% TO finfo_wind%
to%=FNload_template("Goto",b%,to%,ind_size%-(to%-ind_data%))
g_title%=b%!72
SYS "Wimp_CreateWindow",,b% TO goto_wind%
to%=FNload_template("Message",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO mess_wind%
to%=FNload_template("Search",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO search_wind%
to%=FNload_template("Find",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO found_wind%
to%=FNload_template("Export",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO exp_wind%
to%=FNload_template("Headers",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO head_wind%
to%=FNload_template("EditHead",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO he_wind%
to%=FNload_template("HeadList",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO hel_wind%
to%=FNload_template("HPane",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO lpane%
to%=FNload_template("BPane",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO bpane%
to%=FNload_template("Print",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO print_wind%
to%=FNload_template("PrintTrans",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO printt_wind%
to%=FNload_template("PrintHead",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO printh_wind%
to%=FNload_template("Codes",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO printcon_wind%
to%=FNload_template("LoadCSV",b%,to%,ind_size%-(to%-ind_data%))
i_title%=b%!72
SYS "Wimp_CreateWindow",,b% TO loadcsv_wind%
to%=FNload_template("LoadAccount",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO loadacc_wind%
to%=FNload_template("SPane",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO wpane%
to%=FNload_template("NewSList",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO swl_wind%
to%=FNload_template("NewDate",b%,to%,ind_size%-(to%-ind_data%))
SYS "Wimp_CreateWindow",,b% TO date_wind%
PROCclose_templates
:
rcl%=@%
@%=&0102020A
$FNindirection(info%,6)=CHR$(169) + " Stephen Fryatt, 1992-" + MID$(build_date$, 8)
$FNindirection(info%,7)=build_version$+" ("+build_date$+")"
$FNindirection(welcome%,3)="Version: "+build_version$+"   ("+build_date$+")"
@%=rcl%
:
SYS "OS_ConvertHex4",file_type_accounts%,b%,255
b%?4=13
sprite_accounts$="file_"+MID$($b%,2)
SYS "OS_ConvertHex4",file_type_account%,b%,255
b%?4=13
sprite_account$="file_"+MID$($b%,2)
SYS "OS_ConvertHex4",file_type_text%,b%,255
b%?4=13
sprite_text$="file_"+MID$($b%,2)
SYS "OS_ConvertHex4",file_type_csv%,b%,255
b%?4=13
sprite_csv$="file_"+MID$($b%,2)
:
menuup%=0
size%=0
edit_account%=-1
view_account%=-1
account_name$="Untitled"
edit_so%=-1
edit_h%=-1
select%=0
date$=""
date%=0
account_number%=1
so_number%=0
h_number%=0
narrow_amenu%=8
wide_amenu%=12
preferences%=0
modified%=FALSE
info_bar_time%=0
info_bar_reset%=0
s_list_offset%=0
add_count%=0
system_date%=TRUE
other_date$=""
:
PROCdrag_init
:
DIM time_b% 8
DIM time_format% 128, time_string% 128
:

PROCmenu_initialise

b%!0 = info%
b%!4 = info%
b%!8 = finfo_wind%
b%!12 = set_title%
b%!16 = date_wind%
PROCmenu_load_templates(resources$ + "Menus", b%)
imenu% = b%!0
gmenu% = b%!4
cmenu% = b%!8


DIM mmenu% 300,amenu% 300,emenu% 300,smenu% 300,vmenu% 300,bmenu% 300
DIM omenu% 300,wmenu% 999,xmenu% 300,hmenu% 300,ymenu% 999,zmenu% 999,fmenu% 300
DIM tmenu% 300
mw%=0 : me%=0
:
PROCinit_menu(xmenu%,mw%,me%,"Export")
PROCst_menu_item(xmenu%,mw%,me%,"Account     F3",0,0,0,0,exp_wind%,1)
PROCst_menu_item(xmenu%,mw%,me%,"CSV         ^F3",0,0,0,0,exp_wind%,1)
PROCst_menu_item(xmenu%,mw%,me%,"TSV        ^F3",0,0,0,0,exp_wind%,1)
PROCst_menu_item(xmenu%,mw%,me%,"ASCII Text",0,0,0,1,exp_wind%,1)
:
PROCinit_menu(fmenu%,mw%,me%,"Export")
PROCst_menu_item(fmenu%,mw%,me%,"CSV",0,0,0,0,exp_wind%,1)
PROCst_menu_item(fmenu%,mw%,me%,"TSV",0,0,0,0,exp_wind%,1)
PROCst_menu_item(fmenu%,mw%,me%,"ASCII Text",0,0,0,1,exp_wind%,1)
:
PROCinit_menu(tmenu%,mw%,me%,"Transactions")
PROCst_menu_item(gmenu%,mw%,me%,"Search & replace... F4",0,0,0,0,-1,0)
PROCst_menu_item(gmenu%,mw%,me%,"Goto transaction    F5",0,0,0,0,goto_wind%,1)
PROCst_menu_item(gmenu%,mw%,me%,"Sort by dates       F6",0,0,0,0,-1,0)
PROCst_menu_item(gmenu%,mw%,me%,"Update transactions",0,1,0,0,-1,0)
PROCst_menu_item(bmenu%,mw%,me%,"Export",0,0,0,0,fmenu%,0)
PROCst_menu_item(bmenu%,mw%,me%,"Print...        ^PRINT",0,0,0,1,-1,0)
:
PROCinit_menu(bmenu%,mw%,me%,"Accounts")
PROCst_menu_item(bmenu%,mw%,me%,"View account",0,0,0,0,amenu%,0)
PROCst_menu_item(bmenu%,mw%,me%,"View balances... F7",0,0,0,0,-1,0)
PROCst_menu_item(bmenu%,mw%,me%,"Edit...         F7",0,1,0,0,-1,0)
PROCst_menu_item(bmenu%,mw%,me%,"Export",0,0,1,0,xmenu%,0)
PROCst_menu_item(bmenu%,mw%,me%,"Print...   PRINT",0,0,1,1,-1,0)
:
PROCinit_menu(omenu%,mw%,me%,"S.Orders")
PROCst_menu_item(omenu%,mw%,me%,"Edit...        F6",0,0,0,0,-1,0)
PROCst_menu_item(omenu%,mw%,me%,"Forthcoming... ^F6",0,1,0,0,-1,0)
PROCst_menu_item(omenu%,mw%,me%,"Update",0,0,0,1,-1,0)
:
PROCinit_menu(hmenu%,mw%,me%,"Headers")
PROCst_menu_item(hmenu%,mw%,me%,"Edit...             F8",0,0,0,0,-1,0)
PROCst_menu_item(hmenu%,mw%,me%,"View transactions... F8",0,1,0,0,-1,0)
PROCst_menu_item(hmenu%,mw%,me%,"Export",0,0,0,0,fmenu%,0)
PROCst_menu_item(hmenu%,mw%,me%,"Print...         PRINT",0,0,0,1,-1,0)
:
PROCinit_menu(emenu%,mw%,me%,"Edit")
PROCst_menu_item(emenu%,mw%,me%,"Add to end        F1",0,1,0,0,-1,0)
PROCst_menu_item(emenu%,mw%,me%,"Insert above INSERT",0,0,1,0,-1,0)
PROCst_menu_item(emenu%,mw%,me%,"Insert below  INSERT",0,0,1,1,-1,0)
:
PROCinit_menu(smenu%,mw%,me%,"Selection")
PROCst_menu_item(smenu%,mw%,me%,"Cut selection      ^X",0,0,0,0,-1,0)
PROCst_menu_item(smenu%,mw%,me%,"Copy selection     ^C",0,0,0,0,-1,0)
PROCst_menu_item(smenu%,mw%,me%,"Replace selection  ^V",0,1,0,0,-1,0)
PROCst_menu_item(smenu%,mw%,me%,"Delete selection   ^K",0,0,0,0,-1,0)
PROCst_menu_item(smenu%,mw%,me%,"Remove transactions",0,1,0,0,-1,0)
PROCst_menu_item(smenu%,mw%,me%,"Clear selection    ^Z",0,0,0,1,-1,0)
:
PROCinit_menu(mmenu%,mw%,me%,"Accounts+")
PROCst_menu_item(mmenu%,mw%,me%,"Misc",0,0,0,0,gmenu%,0)
PROCst_menu_item(mmenu%,mw%,me%,"Save      F3",0,0,0,0,save%,0)
PROCst_menu_item(mmenu%,mw%,me%,"Transactions",0,0,0,0,tmenu%,0)
PROCst_menu_item(mmenu%,mw%,me%,"Accounts",0,0,0,0,bmenu%,0)
PROCst_menu_item(mmenu%,mw%,me%,"S.Orders",0,0,0,0,omenu%,0)
PROCst_menu_item(mmenu%,mw%,me%,"Headers",0,0,0,0,hmenu%,0)
PROCst_menu_item(mmenu%,mw%,me%,"Edit",0,0,0,0,emenu%,0)
PROCst_menu_item(mmenu%,mw%,me%,"Selection",0,0,1,1,smenu%,0)
:
PROCinit_menu(vmenu%,mw%,me%,"Account")
PROCst_menu_item(vmenu%,mw%,me%,"Initial balance",0,0,0,0,inb_wind%,1)
PROCst_menu_item(vmenu%,mw%,me%,"Goto line        F5",0,1,0,0,goto_wind%,1)
PROCst_menu_item(vmenu%,mw%,me%,"View account",0,0,0,0,amenu%,0)
PROCst_menu_item(vmenu%,mw%,me%,"View balances...  F7",0,0,0,0,-1,0)
PROCst_menu_item(vmenu%,mw%,me%,"Edit accounts... F7",0,1,0,0,-1,0)
PROCst_menu_item(vmenu%,mw%,me%,"Export",0,0,1,0,xmenu%,0)
PROCst_menu_item(vmenu%,mw%,me%,"Print...   PRINT",0,0,1,1,-1,0)
:
colours%()=7,7,7,7,0,0,0,0,0,7,0,0,7,0,7,7
:
flag%=FNmenu_flags(1,0,0,0,0,1,0,0,0,7,0,0)
:
PROCinit_menu(amenu%,mw%,me%,"View Account")
PROCmenu_item(amenu%,mw%,me%,"",0,0,0,0,-1,0,0,flag%,FNindirection(acc_wind%,1),-1,21)
PROCmenu_item(amenu%,mw%,me%,"",0,0,0,0,-1,0,0,flag%,FNindirection(acc_wind%,2),-1,21)
PROCmenu_item(amenu%,mw%,me%,"",0,0,0,0,-1,0,0,flag%,FNindirection(acc_wind%,3),-1,21)
PROCmenu_item(amenu%,mw%,me%,"",0,0,0,0,-1,0,0,flag%,FNindirection(acc_wind%,4),-1,21)
PROCmenu_item(amenu%,mw%,me%,"",0,0,0,0,-1,0,0,flag%,FNindirection(acc_wind%,5),-1,21)
PROCmenu_item(amenu%,mw%,me%,"",0,0,0,0,-1,0,0,flag%,FNindirection(acc_wind%,6),-1,21)
PROCmenu_item(amenu%,mw%,me%,"",0,0,0,0,-1,0,0,flag%,FNindirection(acc_wind%,7),-1,21)
PROCmenu_item(amenu%,mw%,me%,"",0,0,0,0,-1,0,0,flag%,FNindirection(acc_wind%,8),-1,21)
PROCmenu_item(amenu%,mw%,me%,"",0,0,0,0,-1,0,0,flag%,FNindirection(acc_wind%,9),-1,21)
PROCmenu_item(amenu%,mw%,me%,"",0,0,0,1,-1,0,0,flag%,FNindirection(acc_wind%,10),-1,21)
PROCset_menu_end(amenu%,0,1)
:
DIM blank% 2 : $blank%=""
:
PROCinit_menu(ymenu%,mw%,me%,"Headers")
FOR loop%=1 TO headers%-1
PROCmenu_item(ymenu%,mw%,me%,"",0,0,0,0,-1,0,0,flag%,blank%,-1,21)
NEXT loop%
PROCmenu_item(ymenu%,mw%,me%,"",0,0,0,1,-1,0,0,flag%,blank%,-1,21)
:
PROCinit_menu(zmenu%,mw%,me%,"Headers")
FOR loop%=1 TO headers%-1
PROCmenu_item(zmenu%,mw%,me%,"",0,0,0,0,-1,0,0,flag%,blank%,-1,21)
NEXT loop%
PROCmenu_item(zmenu%,mw%,me%,"",0,0,0,1,-1,0,0,flag%,blank%,-1,21)
:
PROCinit_menu(wmenu%,mw%,me%,"Headers")
FOR loop%=1 TO headers%-1
PROCmenu_item(wmenu%,mw%,me%,"",0,0,0,0,-1,0,0,flag%,blank%,-1,21)
NEXT loop%
PROCmenu_item(wmenu%,mw%,me%,"",0,0,0,1,-1,0,0,flag%,blank%,-1,21)
:
PROCmake_header_menu
:
$FNindirection(acc_wind%,1)="Untitled"
:
SYS "OS_ReadVarVal","Accounts+$Font",b%,255,0,3 TO ,,len%
b%?len%=13
disp_font$=$b%
disp_font%=-1
:
PROCload_preferences(TRUE)
PROCload_print_values
PROCload_printh_values
PROCload_printt_values
PROCload_printcodes
PROCset_tool_state
SYS "Hourglass_Off"
:
state%=INSTR(state$,"!RunImage")+11
state$=MID$(state$,state%)
IF state$<>"" THEN PROCinit_load(state$)
PROCopen_as_menu(welcome%,(size_x%/2)-380,(size_y%/2)+206)
ENDPROC
:
DEF PROCload_font
LOCAL new_font$,fh%
IF disp_font%>-1 THEN SYS "Font_LoseFont",disp_font%
IF os_350% AND FNpreference(26) THEN
 SYS "Wimp_ReadSysInfo",8 TO fh%
 IF fh%=0 THEN
  new_font$=disp_font$
 ELSE
  SYS "Font_ReadDefn",fh%,q%
  new_font$=FNstring(q%)
 ENDIF
ELSE
 new_font$=disp_font$
ENDIF
SYS "Font_FindFont",,new_font$,12*16,11*16 TO disp_font%
PROCredraw_main
PROCredraw_window(hel_wind%)
PROCredraw_window(bal_wind%)
PROCredraw_window(swl_wind%)
ENDPROC
:
DEF PROCpre_quit
!b%=20
b%!12=b%!8
b%!16=0
SYS "Wimp_SendMessage",19,b%
mess%=10 : PROCmessage("ShutDown?","Cancel","Save","Shutdown")
ENDPROC
:
DEF PROCclose_down
SYS "Font_LoseFont",disp_font%
SYS "XMessageTrans_CloseFile",messages%
IF reset% THEN SYS "Wimp_ProcessKey",&1FC
SYS "Wimp_CloseDown"
ENDPROC
:
DEF PROCredraw_screen
LOCAL more%,grid%,font%,x_min%,x_max%
SYS "Font_SetFont",disp_font%
font%=FNpreference(0)
grid%=FNpreference(1)
so_off%=(NOT FNpreference(25))*s_list_offset%
SYS "Wimp_RedrawWindow",,b% TO more%
ox%=b%!4-b%!20
oy%=b%!16-b%!24+4
WHILE more%
x_min%=(b%!28-b%!4)+b%!20
x_max%=(b%!36-b%!4)+b%!20
CASE !b% OF
 WHEN main%
  top%=((oy%-b%!40) DIV 32)-1
  IF top%<0 top%=0
  base%=((oy%-b%!32) DIV 32)
  i%=top%
  IF grid% THEN
   SYS "Wimp_SetColour",grid_colour%
   IF x_min%<=76 AND x_max%>=76 THEN LINE ox%+76,oy%-(oy%-b%!32),ox%+76,oy%-(oy%-b%!40)
   IF x_min%<=248 AND x_max%>=248 THEN LINE ox%+248,oy%-(oy%-b%!32),ox%+248,oy%-(oy%-b%!40)
   IF x_min%<=620 AND x_max%>=620 THEN LINE ox%+620,oy%-(oy%-b%!32),ox%+620,oy%-(oy%-b%!40)
   IF x_min%<=992 AND x_max%>=992 THEN LINE ox%+992,oy%-(oy%-b%!32),ox%+992,oy%-(oy%-b%!40)
   IF x_min%<=1154 AND x_max%>=1154 THEN LINE ox%+1154,oy%-(oy%-b%!32),ox%+1154,oy%-(oy%-b%!40)
  ENDIF
  WHILE i%<=base%
  IF grid% THEN
   SYS "Wimp_SetColour",grid_colour%
   LINE ox%,oy%-(i%<<5)-60,ox%+15260,oy%-(i%<<5)-60
  ENDIF
  IF (i%-3)<=size% THEN
  line%=i%-3
  IF select%=(line%+1) THEN
   SYS "Wimp_SetColour",sel_colour%
   RECTANGLE FILL ox%,oy%-(i%<<5)-56,1526,24
  ENDIF
  IF line%>=0 THEN
  IF select%=line% THEN
   IF font% THEN
    SYS "Wimp_SetFontColours",,sel_colour%,colours%(sel_colour%)
   ELSE
    SYS "Wimp_SetColour",colours%(sel_colour%)
   ENDIF
  ELSE
   IF font% THEN
    SYS "Wimp_SetFontColours",,back_colour%,text_colour%
   ELSE
    SYS "Wimp_SetColour",text_colour%
   ENDIF
  ENDIF
  IF font% THEN
   IF x_min%<=72 THEN
    text$=STR$(line%)
    SYS "Font_Paint",,text$,16,ox%+72-FNtext_len(text$),oy%-(i%<<5)-20
   ENDIF
   IF x_min%<=248 AND x_max%>=76 THEN
    text$=FNdecode_stored_date(line%)
    SYS "Font_Paint",,text$,16,ox%+82+(164-FNtext_len(text$))/2,oy%-(i%<<5)-20
   ENDIF
   IF x_min%<=620 AND x_max%>=254 THEN
    IF from%(line%)>-1 THEN
     IF from%(line%) AND FNhi THEN
      head%=from%(line%)-FNhi
      text$=$FNindirection(hpane%,head%)
     ELSE
      text$=$FNindirection(acc_wind%,from%(line%)+1)
     ENDIF
    ELSE
     text$=from_text$(line%)
    ENDIF
    SYS "Font_Paint",,text$,16,ox%+254,oy%-(i%<<5)-20
   ENDIF
   IF x_min%<=992 AND x_max%>=626 THEN
    IF to%(line%)>-1 THEN
     IF to%(line%) AND FNhi THEN
      head%=to%(line%)-FNhi
      text$=$FNindirection(hpane%,head%)
     ELSE
      text$=$FNindirection(acc_wind%,to%(line%)+1)
     ENDIF
    ELSE
     text$=from_text$(line%)
    ENDIF
    SYS "Font_Paint",,text$,16,ox%+626,oy%-(i%<<5)-20
   ENDIF
   IF x_min%<=1150 AND x_max%>=992 THEN
    text$=FNpoint(trans%(line%))
    SYS "Font_Paint",,text$,16,ox%+1150-FNtext_len(text$),oy%-(i%<<5)-20
   ENDIF
   IF x_max%>=1160 THEN
    text$=text$(line%)
    SYS "Font_Paint",,text$,16,ox%+1160,oy%-(i%<<5)-20
   ENDIF
  ELSE
   IF x_min%<=72 THEN
    text$=STR$(line%)
    MOVE ox%+72-(LEN(text$)*16),oy%-(i%<<5) : PRINT text$
   ENDIF
   IF x_min%<=248 AND x_max%>=76 THEN
    text$=FNdecode_stored_date(line%)
    MOVE ox%+82+(164-(LEN(text$)*16))/2,oy%-(i%<<5) : PRINT text$
   ENDIF
   IF x_min%<=620 AND x_max%>=254 THEN
    IF from%(line%)>-1 THEN
     IF from%(line%) AND FNhi THEN
      head%=from%(line%)-FNhi
      text$=$FNindirection(hpane%,head%)
     ELSE
      text$=$FNindirection(acc_wind%,from%(line%)+1)
     ENDIF
    ELSE
     text$=from_text$(line%)
    ENDIF
    MOVE ox%+254,oy%-(i%<<5) : PRINT text$
   ENDIF
   IF x_min%<=992 AND x_max%>=626 THEN
    IF to%(line%)>-1 THEN
     IF to%(line%) AND FNhi THEN
      head%=to%(line%)-FNhi
      text$=$FNindirection(hpane%,head%)
     ELSE
      text$=$FNindirection(acc_wind%,to%(line%)+1)
     ENDIF
    ELSE
     text$=from_text$(line%)
    ENDIF
    MOVE ox%+626,oy%-(i%<<5) : PRINT text$
   ENDIF
   IF x_min%<=1150 AND x_max%>=992 THEN
    text$=FNpoint(trans%(line%))
    MOVE ox%+1152-(LEN(text$)*16),oy%-(i%<<5) : PRINT text$
   ENDIF
   IF x_max%>=1160 THEN
    text$=text$(line%)
    MOVE ox%+1160,oy%-(i%<<5) : PRINT text$
   ENDIF
  ENDIF
  ENDIF
  ENDIF
  i%+=1
ENDWHILE
 WHEN acc_view%
  top%=((oy%-b%!40) DIV 32)-1
  IF top%<0 top%=0
  base%=((oy%-b%!32) DIV 32)
  i%=top%
  IF grid% THEN
   SYS "Wimp_SetColour",grid_colour%
   IF x_min%<=76 AND x_max%>=76 THEN LINE ox%+76,oy%-(oy%-b%!32),ox%+76,oy%-(oy%-b%!40)
   IF x_min%<=248 AND x_max%>=248 THEN LINE ox%+248,oy%-(oy%-b%!32),ox%+248,oy%-(oy%-b%!40)
   IF x_min%<=620 AND x_max%>=620 THEN LINE ox%+620,oy%-(oy%-b%!32),ox%+620,oy%-(oy%-b%!40)
   IF x_min%<=782 AND x_max%>=782 THEN LINE ox%+782,oy%-(oy%-b%!32),ox%+782,oy%-(oy%-b%!40)
   IF x_min%<=944 AND x_max%>=944 THEN LINE ox%+944,oy%-(oy%-b%!32),ox%+944,oy%-(oy%-b%!40)
   IF x_min%<=1106 AND x_max%>=1106 THEN LINE ox%+1106,oy%-(oy%-b%!32),ox%+1106,oy%-(oy%-b%!40)
  ENDIF
  WHILE i%<=base%
  IF grid% THEN
   SYS "Wimp_SetColour",grid_colour%
   LINE ox%,oy%-(i%<<5)-60,ox%+1478,oy%-(i%<<5)-60
  ENDIF
  IF (i%-4)<=size%(view_account%) THEN
  line%=i%-4
  IF line%=0 THEN
  IF font% THEN
  SYS "Wimp_SetFontColours",,back_colour%,text_colour%
  IF x_min%<=1100 AND x_max%>=944 THEN
   IF FNpreference(28) AND balance_off%(view_account%,0)>0 THEN
    text$=FNpoint(initial%(view_account%)+balance_off%(view_account%,0))
   ELSE
    text$=FNpoint(initial%(view_account%))
   ENDIF
   SYS "Font_Paint",,text$,16,ox%+1100-FNtext_len(text$),oy%-(i%<<5)-20
  ENDIF
  IF x_max%>=1112 THEN
   IF FNpreference(28) AND balance_off%(view_account%,0)>0 THEN
    text$=FNmess_trans("Offset")
   ELSE
    text$=FNmess_trans("Initial")
   ENDIF
   SYS "Font_Paint",,text$,16,ox%+1112,oy%-(i%<<5)-20
  ENDIF
  ELSE
  SYS "Wimp_SetColour",text_colour%
  IF x_min%<=1100 AND x_max%>=944 THEN
   IF FNpreference(28) AND balance_off%(view_account%,0)>0 THEN
    text$=FNpoint(initial%(view_account%)+balance_off%(view_account%,0))
   ELSE
    text$=FNpoint(initial%(view_account%))
   ENDIF
   MOVE ox%+1100-(LEN(text$)*16),oy%-(i%<<5) : PRINT text$
  ENDIF
  IF x_max%>=1112 THEN
   IF FNpreference(28) AND balance_off%(view_account%,0)>0 THEN
    text$=FNmess_trans("Offset")
   ELSE
    text$=FNmess_trans("Initial")
   ENDIF
   MOVE ox%+1112,oy%-(i%<<5) : PRINT text$
  ENDIF
  ENDIF
  ENDIF
  IF line%>=0 AND line%<=size%(view_account%)-1 THEN
   IF select%=(ABS(line_ref%(view_account%,line%+1))) AND FNpreference(18) AND select%>0 THEN
    SYS "Wimp_SetColour",rep_colour%
    RECTANGLE FILL ox%,oy%-(i%<<5)-56,1478,24
   ENDIF
  ENDIF
  IF line%>0 THEN
  IF select%=ABS(line_ref%(view_account%,line%)) AND FNpreference(18) THEN
   IF font% THEN
    IF line%=size%(view_account%) AND fill%(view_account%) THEN
     SYS "Wimp_SetFontColours",,rep_colour%,fill_colour%
    ELSE
     SYS "Wimp_SetFontColours",,rep_colour%,colours%(rep_colour%)
    ENDIF
   ELSE
    IF line%=size%(view_account%) AND fill%(view_account%) THEN
     SYS "Wimp_SetColour",fill_colour%
    ELSE
     SYS "Wimp_SetColour",text_colour%
    ENDIF
   ENDIF
  ELSE
   IF font% THEN
    IF line%=size%(view_account%) AND fill%(view_account%) THEN
     SYS "Wimp_SetFontColours",,back_colour%,fill_colour%
    ELSE
     SYS "Wimp_SetFontColours",,back_colour%,text_colour%
    ENDIF
   ELSE
    IF line%=size%(view_account%) AND fill%(view_account%) THEN
     SYS "Wimp_SetColour",fill_colour%
    ELSE
     SYS "Wimp_SetColour",text_colour%
    ENDIF
   ENDIF
  ENDIF
  IF font% THEN
   IF x_min%<=72 THEN
    text$=STR$(line%)
    SYS "Font_Paint",,text$,16,ox%+72-FNtext_len(text$),oy%-(i%<<5)-20
   ENDIF
   IF x_min%<=248 AND x_max%>=76 THEN
    text$=FNdecode_stored_date(ABS(line_ref%(view_account%,line%)))
    SYS "Font_Paint",,text$,16,ox%+82+(164-FNtext_len(text$))/2,oy%-(i%<<5)-20
   ENDIF
   IF x_min%<=620 AND x_max%>=254 THEN
    IF SGN(line_ref%(view_account%,line%))=1 THEN
     IF from%(ABS(line_ref%(view_account%,line%)))>-1 THEN
      IF from%(ABS(line_ref%(view_account%,line%))) AND FNhi THEN
       head%=from%(ABS(line_ref%(view_account%,line%)))-FNhi
       text$=$FNindirection(hpane%,head%)
      ELSE
       text$=$FNindirection(acc_wind%,from%(ABS(line_ref%(view_account%,line%)))+1)
      ENDIF
     ELSE
      text$=from_text$(ABS(line_ref%(view_account%,line%)))
     ENDIF
    ELSE
     IF to%(ABS(line_ref%(view_account%,line%)))>-1 THEN
      IF to%(ABS(line_ref%(view_account%,line%))) AND FNhi THEN
       head%=to%(ABS(line_ref%(view_account%,line%)))-FNhi
       text$=$FNindirection(hpane%,head%)
      ELSE
       text$=$FNindirection(acc_wind%,to%(ABS(line_ref%(view_account%,line%)))+1)
      ENDIF
     ELSE
      text$=from_text$(ABS(line_ref%(view_account%,line%)))
     ENDIF
    ENDIF
    SYS "Font_Paint",,text$,16,ox%+254,oy%-(i%<<5)-20
   ENDIF
   IF x_min%<=938 AND x_max%>=620 THEN
    text$=FNpoint(trans%(ABS(line_ref%(view_account%,line%))))
    IF SGN(line_ref%(view_account%,line%))=1 THEN
     SYS "Font_Paint",,text$,16,ox%+938-FNtext_len(text$),oy%-(i%<<5)-20
    ELSE
     SYS "Font_Paint",,text$,16,ox%+776-FNtext_len(text$),oy%-(i%<<5)-20
    ENDIF
   ENDIF
   IF x_min%<=1100 AND x_max%>=944 THEN
    text$=FNpoint(run_bal%(view_account%,line%))
    IF run_bal%(view_account%,line%)<0 THEN SYS "Wimp_SetFontColours",,back_colour%,fill_colour%
    SYS "Font_Paint",,text$,16,ox%+1100-FNtext_len(text$),oy%-(i%<<5)-20
    IF run_bal%(view_account%,line%)<0 THEN SYS "Wimp_SetFontColours",,back_colour%,text_colour%
   ENDIF
   IF x_max%>=1112 THEN
    text$=text$(ABS(line_ref%(view_account%,line%)))
    SYS "Font_Paint",,text$,16,ox%+1112,oy%-(i%<<5)-20
   ENDIF
  ELSE
   IF x_min%<=72 THEN
    text$=STR$(line%)
    MOVE ox%+72-(LEN(text$)*16),oy%-(i%<<5) : PRINT text$
   ENDIF
   IF x_min%<=248 AND x_max%>=76 THEN
    text$=FNdecode_stored_date(ABS(line_ref%(view_account%,line%)))
    MOVE ox%+82+(164-(LEN(text$)*16))/2,oy%-(i%<<5) : PRINT text$
   ENDIF
   IF x_min%<=620 AND x_max%>=254 THEN
    IF SGN(line_ref%(view_account%,line%))=1 THEN
     IF from%(ABS(line_ref%(view_account%,line%)))>-1 THEN
      IF from%(ABS(line_ref%(view_account%,line%))) AND FNhi THEN
       head%=from%(ABS(line_ref%(view_account%,line%)))-FNhi
       text$=$FNindirection(hpane%,head%)
      ELSE
       text$=$FNindirection(acc_wind%,from%(ABS(line_ref%(view_account%,line%)))+1)
      ENDIF
     ELSE
      text$=from_text$(ABS(line_ref%(view_account%,line%)))
     ENDIF
    ELSE
     IF to%(ABS(line_ref%(view_account%,line%)))>-1 THEN
      IF to%(ABS(line_ref%(view_account%,line%))) AND FNhi THEN
       head%=to%(ABS(line_ref%(view_account%,line%)))-FNhi
       text$=$FNindirection(hpane%,head%)
      ELSE
       text$=$FNindirection(acc_wind%,to%(ABS(line_ref%(view_account%,line%)))+1)
      ENDIF
     ELSE
      text$=from_text$(ABS(line_ref%(view_account%,line%)))
     ENDIF
    ENDIF
    MOVE ox%+254,oy%-(i%<<5) : PRINT text$
   ENDIF
   IF x_min%<=938 AND x_max%>=620 THEN
    text$=FNpoint(trans%(ABS(line_ref%(view_account%,line%))))
    IF SGN(line_ref%(view_account%,line%))=1 THEN
     MOVE ox%+938-(LEN(text$)*16),oy%-(i%<<5) : PRINT text$
    ELSE
     MOVE ox%+776-(LEN(text$)*16),oy%-(i%<<5) : PRINT text$
    ENDIF
   ENDIF
   IF x_min%<=1100 AND x_max%>=944 THEN
    text$=FNpoint(run_bal%(view_account%,line%))
    IF run_bal%(view_account%,line%)<0 THEN SYS "Wimp_SetColour",fill_colour%
    MOVE ox%+1100-(LEN(text$)*16),oy%-(i%<<5) : PRINT text$
    IF run_bal%(view_account%,line%)<0 THEN SYS "Wimp_SetColour",text_colour%
   ENDIF
   IF x_max%>=1112 THEN
    text$=text$(ABS(line_ref%(view_account%,line%)))
    MOVE ox%+1112,oy%-(i%<<5) : PRINT text$
   ENDIF
  ENDIF
  ENDIF
  ENDIF
  i%+=1
 ENDWHILE
 WHEN hel_wind%
  top%=((oy%-b%!40) DIV 32)-1
  IF top%<0 top%=0
  base%=((oy%-b%!32) DIV 32)
  i%=top%
  IF grid% THEN
   SYS "Wimp_SetColour",grid_colour%
   IF x_min%<=372 AND x_max%>=372 THEN LINE ox%+372,oy%-(oy%-b%!32),ox%+372,oy%-(oy%-b%!40)
   IF x_min%<=482 AND x_max%>=482 THEN LINE ox%+482,oy%-(oy%-b%!32),ox%+482,oy%-(oy%-b%!40)
   IF x_min%<=654 AND x_max%>=654 THEN LINE ox%+654,oy%-(oy%-b%!32),ox%+654,oy%-(oy%-b%!40)
   IF x_min%<=826 AND x_max%>=862 THEN LINE ox%+826,oy%-(oy%-b%!32),ox%+826,oy%-(oy%-b%!40)
   IF x_min%<=988 AND x_max%>=988 THEN LINE ox%+988,oy%-(oy%-b%!32),ox%+988,oy%-(oy%-b%!40)
   IF x_min%<=1150 AND x_max%>=1150 THEN LINE ox%+1150,oy%-(oy%-b%!32),ox%+1150,oy%-(oy%-b%!40)
  ENDIF
  WHILE i%<=base%
  IF grid% THEN
   SYS "Wimp_SetColour",grid_colour%
   LINE ox%,oy%-(i%<<5)-60,ox%+1312,oy%-(i%<<5)-60
  ENDIF
  IF font% THEN
   SYS "Wimp_SetFontColours",,back_colour%,text_colour%
  ELSE
   SYS "Wimp_SetColour",text_colour%
  ENDIF
  line%=i%-2
  IF line%>=0 AND line%<h_number% THEN
   IF font% THEN
    IF x_min%<=372 THEN
     text$=$FNindirection(hpane%,line%)
     SYS "Font_Paint",,text$,16,ox%+4,oy%-(i%<<5)-20
    ENDIF
    IF x_min%<=482 AND x_max%>=372 THEN
     IF (h_type%(line%+1) AND 1)=1 THEN text$=FNmess_trans("In")
     IF (h_type%(line%+1) AND 2)=2 THEN text$=FNmess_trans("Out")
     IF (h_type%(line%+1) AND 3)=3 THEN text$=FNmess_trans("IO")
     SYS "Font_Paint",,text$,16,ox%+376+(102-FNtext_len(text$))/2,oy%-(i%<<5)-20
    ENDIF
    IF x_min%<=654 AND x_max%>=482 THEN
     text$=FNdecode_given_date(h_fdate%(line%+1))
     SYS "Font_Paint",,text$,16,ox%+486+(172-FNtext_len(text$))/2,oy%-(i%<<5)-20
    ENDIF
    IF x_min%<=826 AND x_max%>=654 THEN
     text$=FNdecode_given_date(h_tdate%(line%+1))
     SYS "Font_Paint",,text$,16,ox%+658+(172-FNtext_len(text$))/2,oy%-(i%<<5)-20
    ENDIF
    IF x_min%<=984 AND x_max%>=826 THEN
     IF (h_type%(line%+1) AND 1)=1 THEN
      text$=FNpoint(h_vals%(line%+1,0))
      SYS "Font_Paint",,text$,16,ox%+984-FNtext_len(text$),oy%-(i%<<5)-20
     ENDIF
    ENDIF
    IF x_min%<=1146 AND x_max%>=984 THEN
     IF (h_type%(line%+1) AND 2)=2 THEN
      text$=FNpoint(h_vals%(line%+1,1))
      SYS "Font_Paint",,text$,16,ox%+1146-FNtext_len(text$),oy%-(i%<<5)-20
     ENDIF
    ENDIF
    IF x_max%>=1150 THEN
     text$=FNpoint(h_vals%(line%+1,0)-h_vals%(line%+1,1))
     SYS "Font_Paint",,text$,16,ox%+1308-FNtext_len(text$),oy%-(i%<<5)-20
    ENDIF
   ELSE
    IF x_min%<=372 THEN
     text$=$FNindirection(hpane%,line%)
     MOVE ox%+4,oy%-(i%<<5) : PRINT text$
    ENDIF
    IF x_min%<=482 AND x_max%>=372 THEN
     IF (h_type%(line%+1) AND 1)=1 THEN text$=FNmess_trans("In")
     IF (h_type%(line%+1) AND 2)=2 THEN text$=FNmess_trans("Out")
     IF (h_type%(line%+1) AND 3)=3 THEN text$=FNmess_trans("IO")
     MOVE ox%+376+(102-(16*LEN(text$)))/2,oy%-(i%<<5) : PRINT text$
    ENDIF
    IF x_min%<=654 AND x_max%>=482 THEN
     text$=FNdecode_given_date(h_fdate%(line%+1))
     MOVE ox%+486+(172-LEN(text$))/2,oy%-(i%<<5) : PRINT text$
    ENDIF
    IF x_min%<=826 AND x_max%>=654 THEN
     text$=FNdecode_given_date(h_tdate%(line%+1))
     MOVE ox%+658+(172-LEN(text$))/2,oy%-(i%<<5) : PRINT text$
    ENDIF
    IF x_min%<=984 AND x_max%>=826 THEN
     IF (h_type%(line%+1) AND 1)=1 THEN
      text$=FNpoint(h_vals%(line%+1,0))
      MOVE ox%+984-16*LEN(text$),oy%-(i%<<5) : PRINT text$
     ENDIF
    ENDIF
    IF x_min%<=1146 AND x_max%>=984 THEN
     IF (h_type%(line%+1) AND 2)=2 THEN
      text$=FNpoint(h_vals%(line%+1,1))
      MOVE ox%+1146-16*LEN(text$),oy%-(i%<<5) : PRINT text$
     ENDIF
    ENDIF
    IF x_max%>=1150 THEN
     text$=FNpoint(h_vals%(line%+1,0)-h_vals%(line%+1,1))
     MOVE ox%+1308-16*LEN(text$),oy%-(i%<<5) : PRINT text$
    ENDIF
   ENDIF
  ENDIF
  i%+=1
 ENDWHILE
 WHEN bal_wind%
  top%=((oy%-b%!40) DIV 32)-1
  IF top%<0 top%=0
  base%=((oy%-b%!32) DIV 32)
  i%=top%
  IF grid% THEN
   SYS "Wimp_SetColour",grid_colour%
   IF x_min%<=366 AND x_max%>=366 THEN LINE ox%+366,oy%-(oy%-b%!32),ox%+366,oy%-(oy%-b%!40)
   IF x_min%<=528 AND x_max%>=528 THEN LINE ox%+528,oy%-(oy%-b%!32),ox%+528,oy%-(oy%-b%!40)
   IF x_min%<=700 AND x_max%>=700 THEN LINE ox%+700,oy%-(oy%-b%!32),ox%+700,oy%-(oy%-b%!40)
  ENDIF
  WHILE i%<=base%
  IF grid% THEN
   IF i%>=(account_number%) THEN
    SYS "Wimp_SetColour",grid_colour%
    RECTANGLE FILL ox%+530,oy%-(account_number%<<5)-90,344,28
    SYS "Wimp_SetColour",back_colour%
    LINE ox%+366,oy%-(account_number%<<5)-62,ox%+366,oy%-(account_number%<<5)-90
    SYS "Wimp_SetColour",text_colour%
   ELSE
    SYS "Wimp_SetColour",grid_colour%
   ENDIF
   LINE ox%,oy%-(i%<<5)-60,ox%+872,oy%-(i%<<5)-60
  ENDIF
  IF font% THEN
   SYS "Wimp_SetFontColours",,back_colour%,text_colour%
  ELSE
   SYS "Wimp_SetColour",text_colour%
  ENDIF
  line%=i%-2
  IF line%>=0 AND line%<account_number% THEN
   IF font% THEN
    IF x_min%<=366 THEN
     text$=$FNindirection(acc_wind%,line%+1)
     SYS "Font_Paint",,text$,16,ox%+4,oy%-(i%<<5)-20
    ENDIF
    IF x_min%<=524 AND x_max%>=366 THEN
     text$=FNpoint(total%(line%))
     SYS "Font_Paint",,text$,16,ox%+524-FNtext_len(text$),oy%-(i%<<5)-20
    ENDIF
    IF x_min%<=700 AND x_max%>=528 THEN
     text$=FNdecode_given_date(a_fdate%(line%+1))
     SYS "Font_Paint",,text$,16,ox%+532+(164-FNtext_len(text$))/2,oy%-(i%<<5)-20,oy%-(i%<<5)-20
    ENDIF
    IF x_max%>=700 THEN
     text$=FNdecode_given_date(a_tdate%(line%+1))
     SYS "Font_Paint",,text$,16,ox%+704+(164-FNtext_len(text$))/2,oy%-(i%<<5)-20,oy%-(i%<<5)-20
    ENDIF
   ELSE
    IF x_min%<=366 THEN
     text$=$FNindirection(acc_wind%,line%+1)
     MOVE ox%+4,oy%-(i%<<5) : PRINT text$
    ENDIF
    IF x_max%>=366 THEN
     text$=FNpoint(total%(line%))
     MOVE ox%+524-16*LEN(text$),oy%-(i%<<5) : PRINT text$
    ENDIF
    IF x_min%<=700 AND x_max%>=528 THEN
     text$=FNdecode_given_date(a_fdate%(line%+1))
     MOVE ox%+532+(164-LEN(text$))/2,oy%-(i%<<5)-20,oy%-(i%<<5) : PRINT text$
    ENDIF
    IF x_max%>=700 THEN
     text$=FNdecode_given_date(a_tdate%(line%+1))
     MOVE ox%+704+(164-LEN(text$))/2,oy%-(i%<<5)-20,oy%-(i%<<5) : PRINT text$
    ENDIF
   ENDIF
  ENDIF
  IF line%=account_number% THEN
   IF font% THEN
    text$=FNmess_trans("Total")
    SYS "Font_Paint",,text$,16,ox%+4,oy%-(i%<<5)-20
    text$=FNpoint(overall_balance%)
    SYS "Font_Paint",,text$,16,ox%+524-FNtext_len(text$),oy%-(i%<<5)-20
   ELSE
    text$=FNmess_trans("Total")
    MOVE ox%+4,oy%-(i%<<5) : PRINT text$
    text$=FNpoint(overall_balance%)
    MOVE ox%+524-16*LEN(text$),oy%-(i%<<5) : PRINT text$
   ENDIF
  ENDIF
 i%+=1
 ENDWHILE
 WHEN swl_wind%
  top%=((oy%-b%!40) DIV 32)-1
  IF top%<0 top%=0
  base%=((oy%-b%!32) DIV 32)
  i%=top%
  IF grid% THEN
   SYS "Wimp_SetColour",grid_colour%
   IF x_min%<=172 AND x_max%>=172 LINE ox%+172,oy%-(oy%-b%!32),ox%+172,oy%-(oy%-b%!40)
   IF x_min%<=544 AND x_max%>=544 LINE ox%+544,oy%-(oy%-b%!32),ox%+544,oy%-(oy%-b%!40)
   IF x_min%<=916 AND x_max%>=916 LINE ox%+916,oy%-(oy%-b%!32),ox%+916,oy%-(oy%-b%!40)
   IF x_min%<=1288 AND x_max%>=1288 LINE ox%+1288,oy%-(oy%-b%!32),ox%+1288,oy%-(oy%-b%!40)
  ENDIF
  WHILE i%<=base%
  IF grid% THEN
   SYS "Wimp_SetColour",grid_colour%
   LINE ox%,oy%-(i%<<5)-60,ox%+1450,oy%-(i%<<5)-60
  ENDIF
  IF font% THEN
   IF i%<2 THEN line%=0 ELSE line%=i%-2
   IF s_dates%(line%-so_off%)<=date% THEN
    SYS "Wimp_SetFontColours",,back_colour%,fill_colour%
   ELSE
    SYS "Wimp_SetFontColours",,back_colour%,text_colour%
   ENDIF
  ELSE
   IF i%<2 THEN line%=0 ELSE line%=i%-2
   IF s_dates%(line%-so_off%)<=date% THEN
    SYS "Wimp_SetColour",fill_colour%
   ELSE
    SYS "Wimp_SetColour",text_colour%
   ENDIF
  ENDIF
  line%=i%-2-so_off%
  IF line%>=0 THEN
   IF s_ref%(line%)>-1 THEN
    IF font% THEN
     IF x_min%<=172 THEN
      text$=FNdecode_given_date(s_dates%(line%))
      SYS "Font_Paint",,text$,16,ox%+4+(164-FNtext_len(text$))/2,oy%-(i%<<5)-20
     ENDIF
     IF x_min%<=544 AND x_max%>=178 THEN
      text$=$FNindirection(spane%,s_ref%(line%)-1)
      SYS "Font_Paint",,text$,16,ox%+178,oy%-(i%<<5)-20
     ENDIF
     IF x_min%<=916 AND x_max%>=550 THEN
      IF s_from%(s_ref%(line%))>-1 THEN
       IF s_from%(s_ref%(line%)) AND FNhi THEN
        head%=s_from%(s_ref%(line%))-FNhi
        text$=$FNindirection(hpane%,head%)
       ELSE
        text$=$FNindirection(acc_wind%,s_from%(s_ref%(line%))+1)
       ENDIF
      ELSE
       text$=s_from_text$(s_ref%(line%))
      ENDIF
      SYS "Font_Paint",,text$,16,ox%+550,oy%-(i%<<5)-20
     ENDIF
     IF x_min%<=1288 AND x_max%>=922 THEN
      IF s_to%(s_ref%(line%))>-1 THEN
       IF s_from%(s_ref%(line%)) AND FNhi THEN
        head%=s_to%(s_ref%(line%))-FNhi
        text$=$FNindirection(hpane%,head%)
       ELSE
        text$=$FNindirection(acc_wind%,s_to%(s_ref%(line%))+1)
       ENDIF
      ELSE
       text$=s_from_text$(s_ref%(line%))
      ENDIF
      SYS "Font_Paint",,text$,16,ox%+922,oy%-(i%<<5)-20
     ENDIF
     IF x_max%>=1288 THEN
      text$=FNpoint(s_trans%(s_ref%(line%)))
      SYS "Font_Paint",,text$,16,ox%+1444-FNtext_len(text$),oy%-(i%<<5)-20
     ENDIF
    ELSE
     IF x_min%<=172 THEN
      text$=FNdecode_given_date(s_dates%(line%))
      MOVE ox%+4+(164-FNtext_len(text$))/2,oy%-(i%<<5) : PRINT text$
     ENDIF
     IF x_min%<=544 AND x_max%>=178 THEN
      text$=$FNindirection(spane%,s_ref%(line%)-1)
      MOVE ox%+178,oy%-(i%<<5) : PRINT text$
     ENDIF
     IF x_min%<=916 AND x_max%>=550 THEN
      IF s_from%(s_ref%(line%))>-1 THEN
       IF s_from%(s_ref%(line%)) AND FNhi THEN
        head%=s_from%(s_ref%(line%))-FNhi
        text$=$FNindirection(spane%,head%)
       ELSE
        text$=$FNindirection(acc_wind%,s_from%(s_ref%(line%))+1)
       ENDIF
      ELSE
       text$=s_from_text$(s_ref%(line%))
      ENDIF
      MOVE ox%+550,oy%-(i%<<5) : PRINT text$
     ENDIF
     IF x_min%<=1288 AND x_max%>=922 THEN
      IF s_to%(s_ref%(line%))>-1 THEN
       IF s_from%(s_ref%(line%)) AND FNhi THEN
        head%=s_to%(s_ref%(line%))-FNhi
        text$=$FNindirection(spane%,head%)
       ELSE
        text$=$FNindirection(acc_wind%,s_to%(s_ref%(line%))+1)
       ENDIF
      ELSE
       text$=s_from_text$(s_ref%(line%))
      ENDIF
      MOVE ox%+922,oy%-(i%<<5) : PRINT text$
     ENDIF
     IF x_max%>=1288 THEN
      text$=FNpoint(s_trans%(s_ref%(line%)))
      MOVE ox%+1444-FNtext_len(text$),oy%-(i%<<5) : PRINT text$
     ENDIF
    ENDIF
   ENDIF
  ENDIF
 i%+=1
 ENDWHILE
ENDCASE
SYS "Wimp_GetRectangle",,b% TO more%
ENDWHILE
ENDPROC
:
DEF PROCredraw_line(w%,line%)
y1%=-((line%+4)<<5)+8
y2%=-((line%+3)<<5)+8
SYS "Wimp_ForceRedraw",w%,0,y1%,1526,y2%
ENDPROC
:
DEF PROCredraw_from(w%,line%)
LOCAL wth%,hht%
!b%=w%
SYS "Wimp_GetWindowState",,b%
wth%=b%!12-b%!4
hht%=b%!16-b%!8
SYS "Wimp_ForceRedraw",w%,b%!20,b%!24-(b%!16-b%!8),b%!20+(b%!12-b%!4),-((line%+3)<<5)+8
ENDPROC
:
DEF PROCredraw_main
LOCAL wth%,hht%
!b%=main%
SYS "Wimp_GetWindowState",,b%
wth%=b%!12-b%!4
hht%=b%!16-b%!8
SYS "Wimp_ForceRedraw",main%,b%!20,b%!24-hht%,b%!20+wth%,b%!24
ENDPROC
:
DEF PROCredraw_account
LOCAL wth%,hht%
!b%=acc_view%
SYS "Wimp_GetWindowState",,b%
wth%=b%!12-b%!4
hht%=b%!16-b%!8
SYS "Wimp_ForceRedraw",acc_view%,b%!20,b%!24-hht%,b%!20+wth%,b%!24
ENDPROC
:
DEF PROCredraw_window(whand%)
!q%=whand%
SYS "Wimp_GetWindowState",,q%
SYS "Wimp_ForceRedraw",whand%,q%!20,(q%!24)-(q%!16-q%!8),(q%!20)+(q%!12-q%!4),q%!24
SYS "Wimp_ForceRedraw",-1,q%!4,q%!16,q%!12+40,q%!16+40
ENDPROC
:
DEF PROCredraw_title(whand%)
!q%=whand%
SYS "Wimp_GetWindowState",,q%
SYS "Wimp_ForceRedraw",-1,q%!4,q%!16,q%!12+40,q%!16+40
ENDPROC
:
DEF PROCredraw_icon(w%,i%)
!q%=w%
q%!4=i%
SYS "Wimp_GetIconState",,q%
SYS "Wimp_ForceRedraw",!q%,q%!8,q%!12,q%!16,q%!20
ENDPROC
:
DEF FNtext(t$,field%,left%)
LOCAL len%,pad%
len%=LENt$
IF len%>field% t$=LEFT$(t$,field%)
pad%=field%-len%
IF left%=TRUE THEN
t$=t$+STRING$(pad%," ")
ENDIF
IF left%=FALSE THEN
t$=STRING$(pad%," ")+t$
ENDIF
IF left%=2 THEN
t$=STRING$((pad% DIV 2)," ")+t$+STRING$((pad% DIV 2)+(pad% MOD 2)," ")
ENDIF
=t$
:
DEF FNpoint(val%)
LOCAL val$
val$=STR$(ABS(val%))
IF LEN(val$)<3 THEN val$=RIGHT$("000"+val$,3)
=STRING$(ABS(SGN(val%)=-1),"-")+LEFT$(val$,LEN(val$)-2)+"."+RIGHT$(val$,2)
:
DEF FNval(s$)
LOCAL pt%,pn$,pc$
pt%=INSTR(s$,".")
IF pt%>0 THEN
 pn$=LEFT$(s$,pt%-1)
 pc$=MID$(s$,pt%+1)
ELSE
 pn$=s$
 pc$=""
ENDIF
=VAL(pn$+LEFT$(pc$+"00",2))
:
DEF FNtext_len(t$)
SYS "Font_Converttopoints",,1280,40 TO ,xpts%,ypts%
SYS "Font_StringWidth",,t$,xpts%,ypts%,32,LEN(t$)+1 TO ,,xopt%,yopt%
SYS "Font_ConverttoOS",,xopt%,yopt% TO ,xo%
=xo%
:
:
DEF PROCadd_line
IF size%>=max_entries% THEN  mess%=0 : PROCmessage("TooManyTrans","","OK","") : ENDPROC
IF NOT FNicon_selected(pane2%,6) AND FNtest_date($FNindirection(pane2%,0)) THEN ENDPROC
IF FNvalid_transfer($FNindirection(pane2%,1),$FNindirection(pane2%,2)) THEN ENDPROC
size%+=1
IF FNicon_selected(pane2%,6) THEN
date%(size%)=date%
ELSE
PROCstore_text_date(size%,$FNindirection(pane2%,0))
ENDIF
from%(size%)=FNaccount_number($FNindirection(pane2%,1))
IF (from%(size%) AND FNhi) AND from%(size%)>-1 THEN
 head%=from%(size%)-FNhi
 IF (h_type%(head%+1) AND 1)=0 THEN from%(size%)=-1
ENDIF
to%(size%)=FNaccount_number($FNindirection(pane2%,2))
IF (to%(size%) AND FNhi) AND to%(size%)>-1 THEN
 head%=to%(size%)-FNhi
 IF (h_type%(head%+1) AND 2)=0 THEN to%(size%)=-1
ENDIF
from_text$(size%)=""
IF from%(size%)=-1 THEN from_text$(size%)=$FNindirection(pane2%,1)
IF to%(size%)=-1 THEN from_text$(size%)=$FNindirection(pane2%,2)
trans%(size%)=FNval($FNindirection(pane2%,3))
text$(size%)=$FNindirection(pane2%,4)
PROCrecalc
IF FNpreference(12) THEN
 IF FNicon_deleted(pane2%,0) THEN PROCend_caret(pane2%,1) ELSE PROCend_caret(pane2%,0)
ENDIF
PROCset_main_extent(size%)
PROCredraw_line(main%,size%)
PROCgoto_line(main%,size%)
modified%=TRUE
PROCmain_window_title
PROCinfo_bar_message("AddTo",1)
ENDPROC
:
DEF PROCinsert_line_above
LOCAL loop%
IF size%>=max_entries% THEN  mess%=0 : PROCmessage("TooManyTrans","","OK","") : ENDPROC
IF NOT FNicon_selected(pane2%,6) AND FNtest_date($FNindirection(pane2%,0)) THEN ENDPROC
IF FNvalid_transfer($FNindirection(pane2%,1),$FNindirection(pane2%,2)) THEN ENDPROC
size%+=1
:
FOR loop%=size% TO select%+1 STEP -1
 date%(loop%)=date%(loop%-1)
 from%(loop%)=from%(loop%-1)
 to%(loop%)=to%(loop%-1)
 from_text$(loop%)=from_text$(loop%-1)
 trans%(loop%)=trans%(loop%-1)
 text$(loop%)=text$(loop%-1)
NEXT loop%
:
IF FNicon_selected(pane2%,6) THEN
date%(select%)=date%
ELSE
PROCstore_text_date(select%,$FNindirection(pane2%,0))
ENDIF
from%(select%)=FNaccount_number($FNindirection(pane2%,1))
IF (from%(select%) AND FNhi) AND from%(select%)>-1 THEN
 head%=from%(select%)-FNhi
 IF (h_type%(head%+1) AND 1)=0 THEN from%(select%)=-1
ENDIF
to%(select%)=FNaccount_number($FNindirection(pane2%,2))
IF (to%(select%) AND FNhi) AND to%(select%)>-1 THEN
 head%=to%(select%)-FNhi
 IF (h_type%(head%+1) AND 2)=0 THEN to%(select%)=-1
ENDIF
from_text$(select%)=""
IF from%(select%)=-1 THEN from_text$(select%)=$FNindirection(pane2%,1)
IF to%(select%)=-1 THEN from_text$(select%)=$FNindirection(pane2%,2)
trans%(select%)=FNval($FNindirection(pane2%,3))
text$(select%)=$FNindirection(pane2%,4)
PROCrecalc
PROCset_main_extent(size%)
PROCredraw_from(main%,select%)
modified%=TRUE
PROCmain_window_title
PROCselect_line(select%+1)
PROCinfo_bar_message("InsertA|<S>",1)
ENDPROC
:
DEF PROCinsert_line_below
LOCAL loop%
IF size%>=max_entries% THEN mess%=0 : PROCmessage("TooManyTrans","","OK","") : ENDPROC
IF NOT FNicon_selected(pane2%,6) AND FNtest_date($FNindirection(pane2%,0)) THEN ENDPROC
IF FNvalid_transfer($FNindirection(pane2%,1),$FNindirection(pane2%,2)) THEN ENDPROC
size%+=1
:
FOR loop%=size% TO select%+2 STEP -1
 date%(loop%)=date%(loop%-1)
 from%(loop%)=from%(loop%-1)
 to%(loop%)=to%(loop%-1)
 from_text$(loop%)=from_text$(loop%-1)
 trans%(loop%)=trans%(loop%-1)
 text$(loop%)=text$(loop%-1)
NEXT loop%
:
IF FNicon_selected(pane2%,6) THEN
date%(select%+1)=date%
ELSE
PROCstore_text_date(select%+1,$FNindirection(pane2%,0))
ENDIF
from%(select%+1)=FNaccount_number($FNindirection(pane2%,1))
IF (from%(select%) AND FNhi) AND from%(select%)>-1 THEN
 head%=from%(select%)-FNhi
 IF (h_type%(head%+1) AND 1)=0 THEN from%(select%)=-1
ENDIF
to%(select%+1)=FNaccount_number($FNindirection(pane2%,2))
IF (to%(select%) AND FNhi) AND to%(select%)>-1 THEN
 head%=to%(select%)-FNhi
 IF (h_type%(head%+1) AND 2)=0 THEN to%(select%)=-1
ENDIF
from_text$(select%+1)=""
IF from%(select%+1)=-1 THEN from_text$(select%+1)=$FNindirection(pane2%,1)
IF to%(select%+1)=-1 THEN from_text$(select%+1)=$FNindirection(pane2%,2)
trans%(select%+1)=FNval($FNindirection(pane2%,3))
text$(select%+1)=$FNindirection(pane2%,4)
PROCrecalc
PROCset_main_extent(size%)
PROCredraw_from(main%,select%+1)
modified%=TRUE
PROCmain_window_title
PROCinfo_bar_message("InsertB|<S>",1)
ENDPROC
:
DEF PROCreplace_line
IF NOT FNicon_selected(pane2%,6) AND FNtest_date($FNindirection(pane2%,0)) THEN ENDPROC
IF FNvalid_transfer($FNindirection(pane2%,1),$FNindirection(pane2%,2)) THEN ENDPROC
IF FNicon_selected(pane2%,6) THEN
date%(select%)=date%
ELSE
PROCstore_text_date(select%,$FNindirection(pane2%,0))
ENDIF
from%(select%)=FNaccount_number($FNindirection(pane2%,1))
IF (from%(select%) AND FNhi) AND from%(select%)>-1 THEN
 head%=from%(select%)-FNhi
 IF (h_type%(head%+1) AND 1)=0 THEN from%(select%)=-1
ENDIF
to%(select%)=FNaccount_number($FNindirection(pane2%,2))
IF (to%(select%) AND FNhi) AND to%(select%)>-1 THEN
 head%=to%(select%)-FNhi
 IF (h_type%(head%+1) AND 2)=0 THEN to%(select%)=-1
ENDIF
from_text$(select%)=""
IF from%(select%)=-1 THEN from_text$(select%)=$FNindirection(pane2%,1)
IF to%(select%)=-1 THEN from_text$(select%)=$FNindirection(pane2%,2)
trans%(select%)=FNval($FNindirection(pane2%,3))
text$(select%)=$FNindirection(pane2%,4)
PROCrecalc
PROCredraw_line(main%,select%)
modified%=TRUE
PROCmain_window_title
:
PROCinfo_bar_message("ReplaceTo|<S>",1)
ENDPROC
:
DEF PROCcopy_line
$FNindirection(pane2%,0)=FNdecode_stored_date(select%)
IF from%(select%)=-1 THEN
 $FNindirection(pane2%,1)=from_text$(select%)
ELSE
 IF from%(select%) AND FNhi THEN
  $FNindirection(pane2%,1)=$FNindirection(hpane%,from%(select%)-FNhi)
 ELSE
  $FNindirection(pane2%,1)=$FNindirection(acc_wind%,from%(select%)+1)
 ENDIF
ENDIF
IF to%(select%)=-1 THEN
 $FNindirection(pane2%,2)=from_text$(select%)
ELSE
 IF to%(select%) AND FNhi THEN
  $FNindirection(pane2%,2)=$FNindirection(hpane%,to%(select%)-FNhi)
 ELSE
  $FNindirection(pane2%,2)=$FNindirection(acc_wind%,to%(select%)+1)
 ENDIF
ENDIF
$FNindirection(pane2%,3)=FNpoint(trans%(select%))
$FNindirection(pane2%,4)=text$(select%)
:
FOR loop%=0 TO 4
 IF FNfind_caret(pane2%,loop%) THEN PROCend_caret(pane2%,loop%)
 PROCredraw_icon(pane2%,loop%)
NEXT loop%
:
PROCinfo_bar_message("CopyFrom|<S>",1)
ENDPROC
:
DEF PROCcut_line
LOCAL loop%
$FNindirection(pane2%,0)=FNdecode_stored_date(select%)
IF from%(select%)=-1 THEN
 $FNindirection(pane2%,1)=from_text$(select%)
ELSE
 IF from%(select%) AND FNhi THEN
  $FNindirection(pane2%,1)=$FNindirection(hpane%,from%(select%)-FNhi)
 ELSE
  $FNindirection(pane2%,1)=$FNindirection(acc_wind%,from%(select%)+1)
 ENDIF
ENDIF
IF to%(select%)=-1 THEN
 $FNindirection(pane2%,2)=from_text$(select%)
ELSE
 IF to%(select%) AND FNhi THEN
  $FNindirection(pane2%,2)=$FNindirection(hpane%,to%(select%)-FNhi)
 ELSE
  $FNindirection(pane2%,2)=$FNindirection(acc_wind%,to%(select%)+1)
 ENDIF
ENDIF
$FNindirection(pane2%,3)=FNpoint(trans%(select%))
$FNindirection(pane2%,4)=text$(select%)
:
FOR loop%=select% TO size%-1
 date%(loop%)=date%(loop%+1)
 from%(loop%)=from%(loop%+1)
 to%(loop%)=to%(loop%+1)
 from_text$(loop%)=from_text$(loop%+1)
 trans%(loop%)=trans%(loop%+1)
 text$(loop%)=text$(loop%+1)
NEXT loop%
:
date%(size%)=0
from%(size%)=0
to%(size%)=0
from_text$(size%)=""
trans%(size%)=0
text$(size%)=""
:
size%-=1
PROCset_main_extent(size%)
:
PROCrecalc
PROCredraw_from(main%,select%)
:
FOR loop%=0 TO 4
 IF FNfind_caret(pane2%,loop%) THEN PROCend_caret(pane2%,loop%)
 PROCredraw_icon(pane2%,loop%)
NEXT loop%
:
PROCinfo_bar_message("CutFrom|<S>",1)
:
PROCselect_line(0)
modified%=TRUE
PROCmain_window_title
ENDPROC
:
DEF PROCdelete_line
LOCAL loop%
FOR loop%=select% TO size%-1
 date%(loop%)=date%(loop%+1)
 from%(loop%)=from%(loop%+1)
 to%(loop%)=to%(loop%+1)
 from_text$(loop%)=from_text$(loop%+1)
 trans%(loop%)=trans%(loop%+1)
 text$(loop%)=text$(loop%+1)
NEXT loop%
:
date%(size%)=0
from%(size%)=0
to%(size%)=0
from_text$(size%)=""
trans%(size%)=0
text$(size%)=""
size%-=1
PROCset_main_extent(size%)
:
PROCrecalc
PROCredraw_from(main%,select%)
:
PROCselect_line(0)
modified%=TRUE
PROCmain_window_title
ENDPROC
:
DEF PROCremove_lines
LOCAL loop%
SYS "Hourglass_On"
run_bal%()=0
size%()=0
FOR loop%=0 TO accounts%-1
 run_bal%(loop%,0)=initial%(loop%)
NEXT loop%
FOR loop%=1 TO select%
 IF (to%(loop%)>-1) AND ((to%(loop%) AND FNhi)=0) THEN
  size%(to%(loop%))+=1
  run_bal%(to%(loop%),size%(to%(loop%)))=run_bal%(to%(loop%),size%(to%(loop%))-1)+trans%(loop%)
 ENDIF
 IF from%(loop%)>-1 AND ((from%(loop%) AND FNhi)=0) THEN
  size%(from%(loop%))+=1
  run_bal%(from%(loop%),size%(from%(loop%)))=run_bal%(from%(loop%),size%(from%(loop%))-1)-trans%(loop%)
 ENDIF
NEXT loop%
FOR loop%=select%+1 TO size%
 date%(loop%-select%)=date%(loop%)
 from%(loop%-select%)=from%(loop%)
 to%(loop%-select%)=to%(loop%)
 from_text$(loop%-select%)=from_text$(loop%)
 trans%(loop%-select%)=trans%(loop%)
 text$(loop%-select%)=text$(loop%)
NEXT loop%
FOR loop%=0 TO accounts%-1
 initial%(loop%)=run_bal%(loop%,size%(loop%))
NEXT loop%
FOR loop%=size%-select%+1 TO size%
 date%(loop%)=0
 from%(loop%)=0
 to%(loop%)=0
 from_text$(loop%)=""
 trans%(loop%)=0
 text$(loop%)=""
NEXT loop%
SYS "Hourglass_Off"
size%-=select%
PROCset_main_extent(size%)
PROCselect_line(0)
PROCrecalc
PROCredraw_main
modified%=TRUE
PROCmain_window_title
ENDPROC
:
:
DEF PROCpage_up
LOCAL offset%,yh%
!b%=main%
SYS "Wimp_GetWindowState",,b%
yh%=(b%!16-b%!8)-40
IF yh% MOD 32<>0 THENyh%-=(yh% MOD 32)
yh%-=64
offset%=b%!24
offset%+=yh%
IF offset%>0 offest%=0
b%!24=offset%
SYS "Wimp_OpenWindow",,b%
ENDPROC
:
DEF PROCpage_down
LOCAL offset%,yh%
!b%=main%
SYS "Wimp_GetWindowState",,b%
yh%=(b%!16-b%!8)-40
IF yh% MOD 32<>0 THENyh%-=(yh% MOD 32)
yh%-=64
offset%=b%!24
offset%-=yh%
IF offset%<-31520 offest%=-31520
b%!24=offset%
SYS "Wimp_OpenWindow",,b%
ENDPROC
:
DEF PROCpage_home
!q%=main%
SYS "Wimp_GetWindowState",,q%
q%!24=0
SYS "Wimp_OpenWindow",,q%
ENDPROC
:
DEF PROCpage_end
!b%=main%
SYS "Wimp_GetWindowState",,b%
b%!24=(size%-2)*-32
SYS "Wimp_OpenWindow",,b%
ENDPROC
:
DEF PROCline_up
LOCAL offset%
!b%=main%
SYS "Wimp_GetWindowState",,b%
offset%=b%!24
offset%+=32
IF offset%>0 offest%=0
b%!24=offset%
SYS "Wimp_OpenWindow",,b%
ENDPROC
:
DEF PROCline_down
LOCAL offset%
!b%=main%
SYS "Wimp_GetWindowState",,b%
offset%=b%!24
offset%-=32
IF offset%<-31520 offest%=-31520
b%!24=offset%
SYS "Wimp_OpenWindow",,b%
ENDPROC
:
DEF PROCgoto_line(window%,line%)
LOCAL offset%,mess%,s$
CASE window% OF
 WHEN main% : mess%=1 : IF line%>size% THEN line%=size%
 WHEN acc_view% : mess%=2 : IF line%>size%(view_account%)+1 THEN line%=size%(view_account%)+1
 ENDCASE
IF line%<1 THEN line%=1
!b%=window%
SYS "Wimp_GetWindowState",,b%
offset%=((line%-1)*-32)
IF offset%>0 offest%=0
b%!24=offset%
SYS "Wimp_OpenWindow",,b%
PROCdisplay_menu(-1,0,0)
IF mess%=2 THEN line%-=1 :s$=FNmess_trans("Line") ELSE s$=FNmess_trans("Transaction")
PROCinfo_bar_message("Goto|"+s$+"|"+STR$(line%),mess%)
ENDPROC
:
DEF PROCmouse_select(y%,click%)
LOCAL into%,yoff%,row%,o%
!b%=main%
SYS "Wimp_GetWindowState",,b%
yoff%=-b%!24
into%=b%!16-y%
row%=((yoff%+into%-90) DIV 32)
IF row%>size% OR row%=0 ENDPROC
CASE click% OF
 WHEN 1
  IF row%=select% THEN
   PROCselect_line(0)
  ELSE
   PROCselect_line(row%)
  ENDIF
 WHEN 4 : PROCselect_line(row%)
ENDCASE
ENDPROC
:
DEF PROCselect_line(l%)
LOCAL o%
o%=select%
select%=l%
PROCredraw_line(main%,o%)
PROCredraw_line(main%,select%)
IF view_account%>-1 AND FNpreference(18) THEN
 PROCredraw_line(acc_view%,FNaccount_selection(o%)+1)
 PROCredraw_line(acc_view%,FNaccount_selection(select%)+1)
ENDIF
PROCset_tool_state
PROCupdate_info_bar
ENDPROC
:
DEF FNaccount_selection(l%)
LOCAL loop%
IF view_account%=-1 THEN =-1
loop%=-1
REPEAT
 loop%+=1
 UNTIL ABS(line_ref%(view_account%,loop%))=l% OR loop%>=per_account%
IF ABS(line_ref%(view_account%,loop%))<>l% THEN loop%=-1
=loop%
:
DEF PROCaccount_mouse_select(y%,click%)
LOCAL into%,yoff%,row%,o%
!b%=acc_view%
SYS "Wimp_GetWindowState",,b%
yoff%=-b%!24
into%=b%!16-y%
row%=((yoff%+into%-90) DIV 32)-1
IF row%>size%(view_account%) OR row%=0 ENDPROC
row%=ABS(line_ref%(view_account%,row%))
CASE click% OF
 WHEN 1
  IF row%=select% THEN
   PROCselect_line(0)
  ELSE
   PROCselect_line(row%)
  ENDIF
 WHEN 4 : PROCselect_line(row%)
ENDCASE
ENDPROC
:
:
DEF PROCshow_account(a%)
LOCAL title$
view_account%=a%
PROCset_tool_state
PROCset_account_extent(size%(a%))
$FNindirection(apane%,4)=""+FNpoint(total%(a%))
PROCredraw_icon(apane%,4)
PROCscroll_top(acc_view%)
PROCopen_window(acc_view%)
title$=FNmess_trans("Account")+": "+$FNindirection(acc_wind%,view_account%+1)
IF (NOT FNno_date(a_fdate%(view_account%+1))) OR (NOT FNno_date(a_tdate%(view_account%+1))) THEN
 title$+="  ["
 IF NOT FNno_date(a_fdate%(view_account%+1)) THEN title$+=FNmess_trans("From")+": "+FNdecode_given_date(a_fdate%(view_account%+1))
 IF (NOT FNno_date(a_fdate%(view_account%+1))) AND (NOT FNno_date(a_tdate%(view_account%+1))) THEN title$+=" "
 IF NOT FNno_date(a_tdate%(view_account%+1)) THEN title$+=FNmess_trans("To")+": "+FNdecode_given_date(a_tdate%(view_account%+1))
 title$+="]"
ENDIF
$a_title%=title$
PROCopen_window(apane%)
PROCredraw_account
PROCredraw_title(acc_view%)
PROCinfo_bar_message("ViewNewAcc|<A>",3)
ENDPROC
:
:
DEF PROCset_new_title
account_name$=$FNindirection(set_title%,0)
$FNindirection(pane%,5)=account_name$
PROCredraw_icon(pane%,5)
$FNindirection(apane%,5)=account_name$
PROCredraw_icon(apane%,5)
PROCdisplay_menu(-1,0,0)
modified%=TRUE
PROCmain_window_title
PROCinfo_bar_message("UserTitle",3)
ENDPROC
:
DEF PROCinitial_balance
initial%(view_account%)=FNval($FNindirection(inb_wind%,1))
PROCrecalc
PROCdisplay_menu(-1,0,0)
modified%=TRUE
PROCmain_window_title
PROCinfo_bar_message("InitBal|"+FNpoint(initial%(view_account%)),2)
ENDPROC
:
DEF PROCsort
LOCAL scan%,loop%,sorted%
SYS "Hourglass_On"
scan%=1
REPEAT
 sorted%=TRUE
 FOR loop%=1 TO size%-scan%
  IF date%(loop%)>date%(loop%+1) THEN
   SWAP date%(loop%),date%(loop%+1)
   SWAP to%(loop%),to%(loop%+1)
   SWAP from%(loop%),from%(loop%+1)
   SWAP from_text$(loop%),from_text$(loop%+1)
   SWAP trans%(loop%),trans%(loop%+1)
   SWAP text$(loop%),text$(loop%+1)
   sorted%=FALSE
  ENDIF
 NEXT loop%
 scan%+=1
UNTIL (scan%>=size%) OR sorted%
SYS "Hourglass_Off"
PROCrecalc
PROCredraw_main
modified%=TRUE
PROCmain_window_title
PROCinfo_bar_message("Sorted",3)
ENDPROC
:
DEF PROCsearch_window
$FNindirection(search_wind%,2)=""
$FNindirection(search_wind%,3)=""
PROCset_icon_state(search_wind%,6,1,0,0)
PROCset_icon_state(search_wind%,7,0,0,0)
PROCset_icon_state(search_wind%,8,0,0,0)
PROCset_icon_state(search_wind%,14,1,0,0)
PROCset_icon_state(search_wind%,15,1,0,0)
PROCset_icon_state(search_wind%,16,1,0,0)
ENDPROC
:
DEF PROCsearch(start%,replace%,all%)
LOCAL flag%,f$,d$,sub%,error%
sub%=FNicon_selected(search_wind%,7)
PROCclose_window(search_wind%)
IF start% THEN
 search_loop%=0
 search_field%=-1
 IF sub% THEN
  s_a%=FNinstr_account_number($FNindirection(search_wind%,2))
  r_a%=FNaccount_number($FNindirection(search_wind%,3))
 ELSE
  s_a%=FNaccount_number($FNindirection(search_wind%,2))
  r_a%=FNaccount_number($FNindirection(search_wind%,3))
 ENDIF
 s_a$=$FNindirection(search_wind%,2)
 r_a$=$FNindirection(search_wind%,3)
 IF NOT FNicon_selected(search_wind%,8) THEN
  s_a$=FNupper(s_a$)
 ENDIF
 s_f%=FNicon_selected(search_wind%,14)
 s_t%=FNicon_selected(search_wind%,15)
 s_d%=FNicon_selected(search_wind%,16)
ENDIF
error%=FALSE
IF replace% THEN
 CASE search_d% OF
  WHEN 1
   IF r_a%=-1 THEN
    IF to%(search_loop%)>-1 THEN
     from_text$(search_loop%)=r_a$ : from%(search_loop%)=-1
    ELSE
     mess%=12 : PROCmessage("IllegalReplace","Cancel","","Skip") : error%=TRUE
    ENDIF
   ELSE
    from%(search_loop%)=r_a%
   ENDIF
  WHEN 2
   IF r_a%=-1 THEN
    IF from%(search_loop%)>-1 THEN
     from_text$(search_loop%)=r_a$ : to%(search_loop%)=-1
    ELSE
     mess%=12 : PROCmessage("IllegalReplace","Cancel","","Skip") : error%=TRUE
    ENDIF
   ELSE
    to%(search_loop%)=r_a%
   ENDIF
  WHEN 3 : text$(search_loop%)=r_a$
  ENDCASE
  PROCredraw_line(main%,search_loop%)
  IF view_account%>-1 THEN PROCredraw_window(acc_view%)
  IF NOT error% THEN
   modified%=TRUE
   PROCmain_window_title
  ENDIF
ENDIF
IF error% THEN ENDPROC
REPEAT
 flag%=FALSE
 search_field%=(search_field%+1) MOD 3
 IF search_field%=0 THEN search_loop%+=1
 CASE search_field% OF
  WHEN 0
   IF s_f% THEN
    IF from%(search_loop%)>-1 THEN
     IF sub% THEN
      IF FNinstr_account_match(from%(search_loop%)) THEN
       flag%=TRUE : search_d%=1
       IF from%(search_loop%) AND FNhi THEN
        f$=$FNindirection(hpane%,from%(search_loop%)-FNhi)
       ELSE
        f$=$FNindirection(acc_wind%,from%(search_loop%)+1)
       ENDIF
      ENDIF
     ELSE
      IF from%(search_loop%)=s_a% THEN
       flag%=TRUE : search_d%=1
       IF s_a% AND FNhi THEN
        f$=$FNindirection(hpane%,s_a%-FNhi)
       ELSE
        f$=$FNindirection(acc_wind%,s_a%+1)
       ENDIF
      ENDIF
     ENDIF
    ELSE
     r$=from_text$(search_loop%)
     IF NOT FNicon_selected(search_wind%,8) THEN r$=FNupper(r$)
     IF sub% THEN
      IF INSTR(r$,s_a$) THEN flag%=TRUE : search_d%=1 : f$=from_text$(search_loop%)
     ELSE
      IF r$=s_a$ THEN flag%=TRUE : search_d%=1 : f$=from_text$(search_loop%)
     ENDIF
    ENDIF
   ENDIF
  WHEN 1
   IF s_t% THEN
    IF to%(search_loop%)>-1 THEN
     IF sub% THEN
      IF FNinstr_account_match(to%(search_loop%)) THEN
       flag%=TRUE : search_d%=2
       IF s_a% AND FNhi THEN
        f$=$FNindirection(hpane%,to%(search_loop%)-FNhi)
       ELSE
        f$=$FNindirection(acc_wind%,to%(search_loop%)+1)
       ENDIF
      ENDIF
     ELSE
      IF to%(search_loop%)=s_a% THEN
       flag%=TRUE : search_d%=2
       IF s_a% AND FNhi THEN
        f$=$FNindirection(hpane%,s_a%-FNhi)
       ELSE
        f$=$FNindirection(acc_wind%,s_a%+1)
       ENDIF
      ENDIF
     ENDIF
    ELSE
     r$=from_text$(search_loop%)
     IF NOT FNicon_selected(search_wind%,8) THEN r$=FNupper(r$)
     IF sub% THEN
      IF INSTR(r$,s_a$) THEN flag%=TRUE : search_d%=2 : f$=from_text$(search_loop%)
     ELSE
      IF r$=s_a$ THEN flag%=TRUE : search_d%=2 : f$=from_text$(search_loop%)
     ENDIF
    ENDIF
   ENDIF
  WHEN 2
   IF s_d% THEN
     r$=text$(search_loop%)
     IF NOT FNicon_selected(search_wind%,8) THEN r$=FNupper(r$)
     IF sub% THEN
      IF INSTR(r$,s_a$) THEN flag%=TRUE : search_d%=3 : f$=text$(search_loop%)
     ELSE
      IF r$=s_a$ THEN flag%=TRUE : search_d%=3 : f$=text$(search_loop%)
     ENDIF
   ENDIF
 ENDCASE
 IF flag% AND all% THEN
  error%=FALSE
  CASE search_d% OF
   WHEN 1
    IF r_a%=-1 THEN
     IF to%(search_loop%)>-1 THEN
      from_text$(search_loop%)=r_a$ : from%(search_loop%)=-1
     ELSE
      PROCgoto_line(main%,search_loop%)
      PROCselect_line(search_loop%)
      mess%=13 : PROCmessage("IllegalReplace","Cancel","","Skip") : error%=TRUE
     ENDIF
    ELSE
     from%(search_loop%)=r_a%
    ENDIF
   WHEN 2
    IF r_a%=-1 THEN
     IF from%(search_loop%)>-1 THEN
      from_text$(search_loop%)=r_a$ : to%(search_loop%)=-1
     ELSE
      PROCgoto_line(main%,search_loop%)
      PROCselect_line(search_loop%)
      mess%=13 : PROCmessage("IllegalReplace","Cancel","","Skip") : error%=TRUE
     ENDIF
    ELSE
     to%(search_loop%)=r_a%
    ENDIF
   WHEN 3 : text$(search_loop%)=r_a$
   ENDCASE
  PROCredraw_line(main%,search_loop%)
  IF view_account%>-1 THEN PROCredraw_window(acc_view%)
  IF NOT error% THEN
   modified%=TRUE
   PROCmain_window_title
   flag%=FALSE
  ENDIF
 ENDIF
 UNTIL flag% OR search_loop%>=size%
IF error% THEN ENDPROC
IF flag% AND search_loop%<=size% THEN
 PROCselect_line(search_loop%)
 PROCgoto_line(main%,search_loop%)
 IF NOT all% THEN
  CASE search_d% OF
   WHEN 1 : d$=FNmess_trans("From")
   WHEN 2 : d$=FNmess_trans("To")
   WHEN 3 : d$=FNmess_trans("Description")
   ENDCASE
  $FNindirection(found_wind%,2)=f$
  $FNindirection(found_wind%,3)=r_a$
  $FNindirection(found_wind%,5)=STR$(search_loop%)
  $FNindirection(found_wind%,7)=d$
  PROCopen_window(found_wind%)
  PROCend_caret(found_wind%,-1)
 ENDIF
ENDIF
ENDPROC
:
DEF PROCrecalc
LOCAL loop%,fill%,head%
SYS "Hourglass_On"
fill%=FALSE
balance_off%()=0
total%()=0
line_ref%()=0
run_bal%()=0
h_vals%()=0
size%()=0
FOR loop%=0 TO accounts%-1
 run_bal%(loop%,0)=initial%(loop%)
NEXT loop%
IF size%>0 THEN
FOR loop%=1 TO size%
 IF to%(loop%)>-1 THEN
  IF to%(loop%) AND FNhi THEN
   head%=to%(loop%)-FNhi
   IF (((date%(loop%)>=h_fdate%(head%+1)) OR (FNno_date(h_fdate%(head%+1)))) AND ((date%(loop%)<=h_tdate%(head%+1)) OR (FNno_date(h_tdate%(head%+1))))) THEN h_vals%(head%+1,1)+=trans%(loop%)
  ELSE
   IF (((date%(loop%)>=a_fdate%(to%(loop%)+1)) OR (FNno_date(a_fdate%(to%(loop%)+1)))) AND ((date%(loop%)<=a_tdate%(to%(loop%)+1)) OR (FNno_date(a_tdate%(to%(loop%)+1))))) THEN
    size%(to%(loop%))+=1
    IF size%(to%(loop%))>per_account% THEN
     fill%=TRUE
     fill%(to%(loop%))=TRUE
     size%(to%(loop%))-=1
    ELSE
     fill%(to%(loop%))=FALSE
     line_ref%(to%(loop%),size%(to%(loop%)))=loop%
     run_bal%(to%(loop%),size%(to%(loop%)))=run_bal%(to%(loop%),size%(to%(loop%))-1)+trans%(loop%)
    ENDIF
   ELSE
    IF date%(loop%)<a_fdate%(to%(loop%)+1) AND (NOT FNno_date(a_fdate%(to%(loop%)+1))) THEN balance_off%(to%(loop%),0)+=trans%(loop%)
    IF date%(loop%)>a_tdate%(to%(loop%)+1) AND (NOT FNno_date(a_tdate%(to%(loop%)+1))) THEN balance_off%(to%(loop%),1)+=trans%(loop%)
   ENDIF
  ENDIF
 ENDIF
 IF from%(loop%)>-1 THEN
  IF from%(loop%) AND FNhi THEN
   head%=from%(loop%)-FNhi
   IF (((date%(loop%)>=h_fdate%(head%+1)) OR (FNno_date(h_fdate%(head%+1)))) AND ((date%(loop%)<=h_tdate%(head%+1)) OR (FNno_date(h_tdate%(head%+1))))) THEN h_vals%(head%+1,0)+=trans%(loop%)
  ELSE
   IF (((date%(loop%)>=a_fdate%(from%(loop%)+1)) OR (FNno_date(a_fdate%(from%(loop%)+1)))) AND ((date%(loop%)<=a_tdate%(from%(loop%)+1)) OR (FNno_date(a_tdate%(from%(loop%)+1))))) THEN
    size%(from%(loop%))+=1
    IF size%(from%(loop%))>per_account% THEN
     fill%=TRUE
     fill%(from%(loop%))=TRUE
     size%(from%(loop%))-=1
    ELSE
     fill%(from%(loop%))=FALSE
     line_ref%(from%(loop%),size%(from%(loop%)))=-loop%
     run_bal%(from%(loop%),size%(from%(loop%)))=run_bal%(from%(loop%),size%(from%(loop%))-1)-trans%(loop%)
    ENDIF
   ELSE
    IF date%(loop%)<a_fdate%(from%(loop%)+1) AND (NOT FNno_date(a_fdate%(from%(loop%)+1))) THEN balance_off%(from%(loop%),0)-=trans%(loop%)
    IF date%(loop%)>a_tdate%(from%(loop%)+1) AND (NOT FNno_date(a_tdate%(from%(loop%)+1))) THEN balance_off%(from%(loop%),1)-=trans%(loop%)
   ENDIF
  ENDIF
 ENDIF
NEXT loop%
FOR loop%=0 TO accounts%-1
 FOR l1%=0 TO size%(loop%)
  run_bal%(loop%,l1%)+=balance_off%(loop%,0)
 NEXT l1%
 total%(loop%)=run_bal%(loop%,size%(loop%))+balance_off%(loop%,1)
NEXT loop%
ENDIF
SYS "Hourglass_Off"
overall_balance%=0
FOR loop%=0 TO accounts%-1
overall_balance%+=total%(loop%)
NEXT loop%
$FNindirection(pane%,6)=""+FNpoint(overall_balance%)
PROCredraw_icon(pane%,6)
PROCredraw_window(bal_wind%)
IF view_account%>-1 THEN
 PROCset_account_extent(size%(view_account%))
 $FNindirection(apane%,4)=""+FNpoint(total%(view_account%))
 PROCredraw_icon(apane%,4)
 PROCredraw_account
ENDIF
PROCredraw_window(hel_wind%)
IF fill% THEN mess%=0 : PROCmessage("TooManyEntries","","OK","")
ENDPROC
:
DEF PROCadd_standing_orders(limit%)
LOCAL added%,up_date%,s$,scan%,sorted%,l1%
SYS "Hourglass_On"
IF limit% THEN
 s_dates%()=0
 s_ref%()=-1
 add_count%=0
ENDIF
IF NOT FNpreference(21) THEN limit%=FALSE
added%=0
IF so_number%>0 THEN
 REPEAT
  up_date%=TRUE
  FOR loop%=1 TO so_number%
   IF s_next%(loop%)<=date% AND (NOT FNno_date(s_next%(loop%))) AND s_int%(loop%)>0 THEN
   up_date%=FALSE
    IF size%<max_entries% THEN
     added%+=1
     size%+=1
     date%(size%)=s_next%(loop%)
     from%(size%)=s_from%(loop%)
     to%(size%)=s_to%(loop%)
     from_text$(size%)=s_from_text$(loop%)
     trans%(size%)=s_trans%(loop%)
     text$(size%)=$FNindirection(spane%,loop%-1)
     IF add_count%<=s_orders%*7 THEN
      s_dates%(add_count%)=s_next%(loop%)
      s_ref%(add_count%)=loop%
      add_count%+=1
     ENDIF
     PROCrecalc
     PROCset_main_extent(size%)
     PROCredraw_line(main%,size%)
     modified%=TRUE
    ELSE
     mess%=0 : PROCmessage("TooManyTrans","","OK","")
    ENDIF
    CASE s_type%(loop%) OF
     WHEN 1
      ye%=FNget_given_year(s_next%(loop%))
      mo%=FNget_given_month(s_next%(loop%))
      mo%+=(s_int%(loop%)AND &FFFF0000)>>16
      WHILE mo%>12
       mo%-=12
       ye%+=1
       ENDWHILE
      dy%=(s_int%(loop%)AND &FFFF)
      s_next%(loop%)=FNencode_num_date(dy%,mo%,ye%)
     WHEN 2
      ye%=FNget_given_year(s_next%(loop%))
      mo%=FNget_given_month(s_next%(loop%))
      dy%=FNget_given_day(s_next%(loop%))
      add%=s_int%(loop%)
      WHILE add%>(FNdays_in_month(mo%,ye%)-dy%)
       add%-=(FNdays_in_month(mo%,ye%)-dy%)
       dy%=0
       mo%+=1
       IF mo%>12 THEN mo%=1 : ye%+=1
       ENDWHILE
      dy%+=add%
      s_next%(loop%)=FNencode_num_date(dy%,mo%,ye%)
     ENDCASE
   ENDIF
  NEXT
 UNTIL up_date% OR (limit% AND (added%>s_order_limit%))
 IF FNpreference(11) AND (added%>0) THEN PROCsort
 PROCmain_window_title
 IF FNpreference(10) THEN mess%=0 : PROCmessage("SOWarn|"+STR$(added%),"","OK","")
  IF limit% AND (added%>s_order_limit%) THEN mess%=7 : PROCmessage("SOMistake|"+STR$(s_order_limit%),"Cancel","","Continue")
ENDIF
IF added%>0 THEN
 PROCinfo_bar_message("SOrders|"+STR$(added%),3)
ELSE
 PROCinfo_bar_message("SOrders|"+FNmess_trans("No"),3)
ENDIF
:
s_list_offset%=add_count%
scan%=0
REPEAT
 sorted%=TRUE
 FOR loop%=0 TO (s_list_offset%-2)-scan%
  IF s_dates%(loop%)>s_dates%(loop%+1) THEN
   SWAP s_dates%(loop%),s_dates%(loop%+1)
   SWAP s_ref%(loop%),s_ref%(loop%+1)
   sorted%=FALSE
  ENDIF
 NEXT loop%
 scan%+=1
UNTIL (scan%>=s_list_offset%-2) OR sorted%
:
SYS "Hourglass_Off"
ENDPROC
:
DEF PROCupdate_file
LOCAL loop%,val%
SYS "Hourglass_On"
FOR loop%=1 TO size%
 IF from%(loop%)=-1 THEN
  val%=FNaccount_number(from_text$(loop%))
  IF val%>-1 THEN from%(loop%)=val%
 ENDIF
 IF to%(loop%)=-1 THEN
  val%=FNaccount_number(from_text$(loop%))
  IF val%>-1 THEN to%(loop%)=val%
 ENDIF
 IF from%(loop%)>-1 AND to%(loop%)>-1 THEN from_text$(loop%)=""
NEXT loop%
SYS "Hourglass_Off"
PROCrecalc
modified%=TRUE
PROCmain_window_title
PROCinfo_bar_message("Updated",3)
ENDPROC
:
:
DEF PROCset_main_extent(lines%)
LOCAL size%
IF lines%<15 THEN lines%=15
size%=(lines%*-32)-120
!b%=0
b%!4=size%
b%!8=1526
b%!12=0
SYS "Wimp_SetExtent",main%,b%
!b%=main%
SYS "Wimp_GetWindowState",,b%
SYS "Wimp_OpenWindow",,b%
ENDPROC
:
DEF PROCset_account_extent(lines%)
LOCAL size%
lines%+=1
IF lines%<15 THEN lines%=15
size%=(lines%*-32)-120
!b%=0
b%!4=size%
b%!8=1478
b%!12=0
SYS "Wimp_SetExtent",acc_view%,b%
ENDPROC
:
DEF PROCset_export_extent(opts%)
LOCAL size%
size%=(opts%*-52)-296
!b%=exp_wind%
SYS "Wimp_GetWindowState",,b%
b%!8=(b%!16)+size%
SYS "Wimp_OpenWindow",,b%
SYS "Wimp_CloseWindow",,b%
PROCset_icon_state(exp_wind%,7,0,0,0)
PROCset_icon_state(exp_wind%,8,0,0,0)
PROCset_icon_state(exp_wind%,9,0,0,0)
ENDPROC
:
DEF FNaccount_number(text$)
LOCAL loop%,flag%
flag%=-1
IF text$="" THEN =flag%
FOR loop%=0 TO accounts%-1
 IF $FNindirection(acc_wind%,loop%+1)=text$ THEN flag%=loop%
NEXT loop%
IF flag%=-1 THEN
 FOR loop%=0 TO h_number%-1
  IF $FNindirection(hpane%,loop%)=text$ THEN flag%=loop%+FNhi
 NEXT loop%
ENDIF
=flag%
:
DEF FNhi=1<<30
:
DEF FNinstr_account_number(text$)
LOCAL loop%,count%
matches%()=-1
count%=-1
IF text$="" THEN ENDPROC
FOR loop%=0 TO accounts%-1
 IF INSTR($FNindirection(acc_wind%,loop%+1),text$) THEN matches%(loop%+1)=loop% : count%+=1
NEXT loop%
FOR loop%=0 TO h_number%-1
 IF INSTR($FNindirection(hpane%,loop%),text$) THEN matches%(loop%+accounts%+1)=loop%+FNhi : count%+=1
NEXT loop%
=count%
:
DEF FNinstr_account_match(a%)
LOCAL loop%,flag%
flag%=FALSE
FOR loop%=1 TO accounts%+headers%
 IF matches%(loop%)=a% AND a%<>-1 THEN flag%=TRUE
NEXT loop%
=flag%
:
DEF PROCupdate_info_bar
LOCAL s$,t$,reset%
IF info_bar_reset%>0 THEN reset%=info_bar_reset% ELSE reset%=3
IF info_bar_time%=0 OR (info_bar_time%<TIME) THEN
 info_bar_reset%=0
 info_bar_time%=0
 IF select%=0 THEN
  s$=FNmess_trans("NoSel")
  t$=s$
 ELSE
  s$=FNmess_trans("TransSel|"+STR$(select%))
  IF FNaccount_selection(select%)=-1 THEN
   t$=FNmess_trans("SelNotHere")
  ELSE
   t$=FNmess_trans("LineSel|"+STR$(FNaccount_selection(select%)))
  ENDIF
 ENDIF
 s$=LEFT$(s$,60)
 IF ((NOT FNpreference(16)) AND (reset% AND 1)) THEN
  $FNindirection(pane%,16)=s$
  PROCredraw_icon(pane%,16)
 ENDIF
 IF ((NOT FNpreference(17)) AND (reset% AND 2)) THEN
  $FNindirection(apane%,12)=t$
  PROCredraw_icon(apane%,12)
 ENDIF
ENDIF
ENDPROC
:
DEF PROCinfo_bar_message(m$,bars%)
m$=FNmess_trans(m$)
m$=LEFT$(m$,60)
IF ((NOT FNpreference(16)) AND (bars% AND 1)) THEN
 $FNindirection(pane%,16)=m$
 PROCredraw_icon(pane%,16)
ENDIF
IF ((NOT FNpreference(17)) AND (bars% AND 2)) THEN
 $FNindirection(apane%,12)=m$
 PROCredraw_icon(apane%,12)
ENDIF
info_bar_time%=TIME+300
info_bar_reset%=bars%
ENDPROC
:
DEF PROCset_tool_state
LOCAL b1%,b2%
b1%=FNpreference(16) : b2%=FNpreference(17)
IF b1% AND (NOT FNicon_deleted(pane%,16)) THEN PROCredraw_icon(pane%,16)
IF b2% AND (NOT FNicon_deleted(apane%,12)) THEN PROCredraw_icon(apane%,12)

PROCset_icon_state(pane2%,9,0,ABS(select%=0),0)
PROCset_icon_state(pane2%,10,0,ABS(select%=0),0)
PROCset_icon_state(pane2%,11,0,ABS(select%=0),0)
PROCset_icon_state(pane2%,12,0,ABS(select%=0),0)
PROCset_icon_state(pane2%,14,0,ABS(select%=0),0)
:
PROCset_menu_state(mmenu%,7,0,ABS(select%=0))
PROCset_menu_state(emenu%,1,0,ABS(select%=0))
PROCset_menu_state(emenu%,2,0,ABS(select%=0))
:
PROCset_menu_state(bmenu%,3,0,ABS(view_account%=-1))
PROCset_menu_state(bmenu%,4,0,ABS(view_account%=-1))
PROCset_menu_state(vmenu%,5,0,ABS(view_account%=-1))
PROCset_menu_state(vmenu%,6,0,ABS(view_account%=-1))
:
PROCset_icon_state(pane%,7,0,0,ABS(b1%=0))
PROCset_icon_state(pane%,8,0,0,ABS(b1%=0))
PROCset_icon_state(pane%,9,0,ABS(select%=0),ABS(b1%=0))
PROCset_icon_state(pane%,10,0,ABS(select%=0),ABS(b1%=0))
PROCset_icon_state(pane%,12,0,0,ABS(b1%=0))
PROCset_icon_state(pane%,13,0,0,ABS(b1%=0))
PROCset_icon_state(pane%,14,0,0,ABS(b1%=0))
PROCset_icon_state(pane%,15,0,0,ABS(b1%=0))
PROCset_icon_state(pane%,17,0,0,ABS(b1%=0))
PROCset_icon_state(pane%,18,0,0,ABS(b1%=0))
:
PROCset_icon_state(pane%,16,0,0,ABS(b1%<>0))
:
:
PROCset_icon_state(apane%,8,0,0,ABS(b2%=0))
PROCset_icon_state(apane%,9,0,0,ABS(b2%=0))
PROCset_icon_state(apane%,10,0,0,1) : REM ABS(b2%=0))
PROCset_icon_state(apane%,11,0,0,ABS(b2%=0))
PROCset_icon_state(apane%,13,0,0,ABS(b2%=0))
PROCset_icon_state(apane%,14,0,0,ABS(b2%=0))
PROCset_icon_state(apane%,15,0,0,ABS(b2%=0))
PROCset_icon_state(apane%,16,0,0,ABS(b2%=0))
PROCset_icon_state(apane%,18,0,ABS(select%=0),(ABS(b2%=0) OR (NOT FNpreference(27))))
PROCset_icon_state(apane%,19,0,ABS(select%=0),(ABS(b2%=0) OR (NOT FNpreference(27))))
:
PROCset_icon_state(apane%,12,0,0,ABS(b2%<>0))
:
PROCredraw_icon(apane%,18)
PROCredraw_icon(apane%,19)
:
PROCupdate_info_bar
ENDPROC
:
DEF PROCclear_edit_bar
LOCAL loop%
FOR loop%=0 TO 4
 $FNindirection(pane2%,loop%)=""
 PROCredraw_icon(pane2%,loop%)
 IF FNfind_caret(pane2%,loop%) THEN PROCend_caret(pane2%,loop%)
NEXT loop%
ENDPROC
:
:
DEF PROCnew_account
LOCAL loop%,w%
loop%=-1
REPEAT
 loop%+=1
 UNTIL $FNindirection(acc_wind%,loop%+1)="" OR loop%>=(accounts%-1)
IF $FNindirection(acc_wind%,loop%+1)="" THEN
 account_number%+=1
 !b%=0
 b%!4=((account_number%+1)*-32)-56
 b%!8=872
 b%!12=0
 SYS "Wimp_SetExtent",bal_wind%,b%
 PROCredraw_window(bal_wind%)
 $FNindirection(acc_wind%,loop%+1)="Untitled"
 a_fdate%(loop%+1)=0
 a_tdate%(loop%+1)=0
 PROCredraw_icon(acc_wind%,loop%+1)
 IF loop%>0 THEN PROCset_menu_end(amenu%,loop%-1,0)
 PROCset_menu_end(amenu%,loop%,1)
 w%=LEN(FNmess_trans("ViewAcc"))
 FOR loop%=1 TO accounts%
  IF LEN($FNindirection(acc_wind%,loop%))>w% THEN w%=LEN($FNindirection(acc_wind%,loop%))
 NEXT loop%
 wide_amenu%=w%
 w%=LEN(FNmess_trans("Accounts"))
 FOR loop%=1 TO accounts%
  IF LEN($FNindirection(acc_wind%,loop%))>w% THEN w%=LEN($FNindirection(acc_wind%,loop%))
 NEXT loop%
 narrow_amenu%=w%
 modified%=TRUE
 PROCmain_window_title
ENDIF
ENDPROC
:
DEF PROCedit_account(ac%)
IF $FNindirection(acc_wind%,ac%)="" THEN ENDPROC
IF edit_account%<>-1 THEN PROCset_icon_state(acc_wind%,edit_account%,0,0,0)
$FNindirection(ed_acc%,1)=$FNindirection(acc_wind%,ac%)
$FNindirection(ed_acc%,9)=FNdecode_given_date(a_fdate%(ac%))
$FNindirection(ed_acc%,11)=FNdecode_given_date(a_tdate%(ac%))
PROCredraw_icon(ed_acc%,1)
PROCset_icon_state(acc_wind%,ac%,1,0,0)
PROCopen_window(ed_acc%)
PROCend_caret(ed_acc%,1)
edit_account%=ac%
ENDPROC
:
DEF PROCdelete_account
LOCAL loop%,flag%
flag%=FALSE
SYS "Hourglass_On"
FOR loop%=1 TO size%
 IF from%(loop%)=(edit_account%-1) OR to%(loop%)=(edit_account%-1) THEN flag%=TRUE
NEXT loop%
IF flag% THEN mess%=0 : PROCmessage("Can'tDeleteAcc","","OK","") : SYS "Hourglass_Off" :ENDPROC
FOR loop%=1 TO size%
 IF ((from%(loop%) AND FNhi)=0) AND (from%(loop%)>(edit_account%-1)) THEN from%(loop%)-=1
 IF ((to%(loop%) AND FNhi)=0) AND (to%(loop%)>(edit_account%-1)) THEN to%(loop%)-=1
NEXT loop%
IF edit_account%<accounts% THEN
 FOR loop%=edit_account% TO accounts%-1
  $FNindirection(acc_wind%,loop%)=$FNindirection(acc_wind%,loop%+1)
  a_fdate%(loop%)=a_fdate%(loop%+1)
  a_tdate%(loop%)=a_tdate%(loop%+1)
 NEXT loop%
ENDIF
$FNindirection(acc_wind%,accounts%)=""
a_fdate%(accounts%)=0
a_tdate%(accounts%)=0
PROCset_icon_state(acc_wind%,edit_account%,0,0,0)
PROCset_menu_end(amenu%,edit_account%-2,1)
edit_account%=-1
account_number%-=1
w%=LEN(FNmess_trans("ViewAcc"))
FOR loop%=1 TO accounts%
 IF LEN($FNindirection(acc_wind%,loop%))>w% THEN w%=LEN($FNindirection(acc_wind%,loop%))
NEXT loop%
wide_amenu%=w%
w%=LEN(FNmess_trans("Accounts"))
FOR loop%=1 TO accounts%
 IF LEN($FNindirection(acc_wind%,loop%))>w% THEN w%=LEN($FNindirection(acc_wind%,loop%))
NEXT loop%
narrow_amenu%=w%
!b%=0
b%!4=((account_number%+1)*-32)-56
b%!8=872
b%!12=0
SYS "Wimp_SetExtent",bal_wind%,b%
PROCredraw_window(bal_wind%)
PROCclose_window(ed_acc%)
PROCend_caret(acc_wind%,-1)
PROCredraw_window(acc_wind%)
modified%=TRUE
PROCmain_window_title
SYS "Hourglass_Off"
ENDPROC
:
DEF PROCcancel_account
PROCset_icon_state(acc_wind%,edit_account%,0,0,0)
edit_account%=-1
PROCclose_window(ed_acc%)
PROCend_caret(acc_wind%,-1)
ENDPROC
:
DEF PROCchange_account
LOCAL title$
IF FNtest_date($FNindirection(ed_acc%,9)) THEN ENDPROC
IF FNtest_date($FNindirection(ed_acc%,11)) THEN ENDPROC
PROCset_icon_state(acc_wind%,edit_account%,0,0,0)
PROCclose_window(ed_acc%)
IF $FNindirection(ed_acc%,1)="" THEN edit_account%=-1 : ENDPROC
$FNindirection(acc_wind%,edit_account%)=$FNindirection(ed_acc%,1)
a_fdate%(edit_account%)=FNencode_text_date($FNindirection(ed_acc%,9))
a_tdate%(edit_account%)=FNencode_text_date($FNindirection(ed_acc%,11))
PROCredraw_icon(acc_wind%,edit_account%)
PROCredraw_main
PROCredraw_window(bal_wind%)
IF view_account%=(edit_account%-1) THEN
 title$=FNmess_trans("Account")+": "+$FNindirection(acc_wind%,view_account%+1)
 IF (NOT FNno_date(a_fdate%(view_account%+1))) OR (NOT FNno_date(a_tdate%(view_account%+1))) THEN
  title$+="  ["
  IF NOT FNno_date(a_fdate%(view_account%+1)) THEN title$+=FNmess_trans("From")+": "+FNdecode_given_date(a_fdate%(view_account%+1))
  IF (NOT FNno_date(a_fdate%(view_account%+1))) AND (NOT FNno_date(a_tdate%(view_account%+1))) THEN title$+=" "
  IF NOT FNno_date(a_tdate%(view_account%+1)) THEN title$+=FNmess_trans("To")+": "+FNdecode_given_date(a_tdate%(view_account%+1))
  title$+="]"
 ENDIF
 $a_title%=title$
 PROCredraw_title(acc_view%)
ENDIF
edit_account%=-1
w%=LEN(FNmess_trans("ViewAcc"))
FOR loop%=1 TO accounts%
 IF LEN($FNindirection(acc_wind%,loop%))>w% THEN w%=LEN($FNindirection(acc_wind%,loop%))
NEXT loop%
wide_amenu%=w%
w%=LEN(FNmess_trans("Accounts"))
FOR loop%=1 TO accounts%
 IF LEN($FNindirection(acc_wind%,loop%))>w% THEN w%=LEN($FNindirection(acc_wind%,loop%))
NEXT loop%
narrow_amenu%=w%
modified%=TRUE
PROCmain_window_title
PROCrecalc
PROCend_caret(acc_wind%,-1)
ENDPROC
:
DEF PROCnew_so
LOCAL loop%
loop%=-1
REPEAT
 loop%+=1
 UNTIL $FNindirection(spane%,loop%)="" OR loop%>=(s_orders%-1)
IF $FNindirection(spane%,loop%)="" THEN
 so_number%+=1
 $FNindirection(spane%,loop%)="Untitled"
 PROCredraw_icon(spane%,loop%)
 s_from%(loop%+1)=-1
 s_to%(loop%+1)=-1
 s_from_text$(loop%+1)=""
 s_trans%(loop%+1)=0
 s_type%(loop%+1)=1
 s_next%(loop%+1)=0
 s_int%(loop%+1)=0
 IF loop%<9 THEN loop%=9
 !b%=0
 b%!4=(loop%+1)*-44
 b%!8=548
 b%!12=0
 SYS "Wimp_SetExtent",spane%,b%
 !b%=spane%
 SYS "Wimp_GetWindowState",,b%
 SYS "Wimp_OpenWindow",,b%
 modified%=TRUE
 PROCmain_window_title
ENDIF
ENDPROC
:
DEF PROCdelete_so
LOCAL loop%
IF (edit_so%+1)<so_number% THEN
FOR loop%=edit_so%+1 TO so_number%
 $FNindirection(spane%,loop%-1)=$FNindirection(spane%,loop%)
 s_from%(loop%)=s_from%(loop%+1)
 s_to%(loop%)=s_to%(loop%+1)
 s_from_text$(loop%)=s_from_text$(loop%+1)
 s_trans%(loop%)=s_trans%(loop%+1)
 s_type%(loop%)=s_type%(loop%+1)
 s_next%(loop%)=s_next%(loop%+1)
 s_int%(loop%)=s_int%(loop%+1)
NEXT loop%
ENDIF
$FNindirection(spane%,so_number%-1)=""
s_from%(so_number%)=0
s_to%(so_number%)=0
s_from_text$(so_number%)=""
s_trans%(so_number%)=0
s_type%(so_number%)=0
s_next%(so_number%)=0
s_int%(so_number%)=0
PROCset_icon_state(spane%,edit_so%,0,0,0)
edit_so%=so_number%-1
IF edit_so%<10 THEN edit_so%=10
!b%=0
b%!4=(edit_so%)*-44
b%!8=548
b%!12=0
SYS "Wimp_SetExtent",spane%,b%
!b%=spane%
SYS "Wimp_GetWindowState",,b%
SYS "Wimp_OpenWindow",,b%
edit_so%=-1
so_number%-=1
PROCclose_window(so_wind%)
PROCend_caret(sl_wind%,-1)
PROCredraw_window(spane%)
modified%=TRUE
PROCmain_window_title
ENDPROC
:
DEF PROCedit_so(ac%)
IF $FNindirection(spane%,ac%)="" THEN ENDPROC
IF edit_so%<>-1 THEN PROCset_icon_state(spane%,edit_so%,0,0,0)
$FNindirection(so_wind%,2)=$FNindirection(spane%,ac%)
IF s_from%(ac%+1)>-1 THEN
 IF s_from%(ac%+1) AND FNhi THEN
  $FNindirection(so_wind%,15)=LEFT$($FNindirection(hpane%,s_from%(ac%+1)-FNhi),20)
 ELSE
  $FNindirection(so_wind%,15)=LEFT$($FNindirection(acc_wind%,s_from%(ac%+1)+1),20)
 ENDIF
ENDIF
IF s_from%(ac%+1)=-1 THEN $FNindirection(so_wind%,15)=LEFT$(s_from_text$(ac%+1),20)
IF s_to%(ac%+1)>-1 THEN
 IF s_to%(ac%+1) AND FNhi THEN
  $FNindirection(so_wind%,17)=LEFT$($FNindirection(hpane%,s_to%(ac%+1)-FNhi),20)
 ELSE
  $FNindirection(so_wind%,17)=LEFT$($FNindirection(acc_wind%,s_to%(ac%+1)+1),20)
 ENDIF
ENDIF
IF s_to%(ac%+1)=-1 THEN $FNindirection(so_wind%,17)=LEFT$(s_from_text$(ac%+1),20)
CASE s_type%(ac%+1) OF
 WHEN 1
  PROCset_icon_state(so_wind%,25,1,0,0)
  PROCset_icon_state(so_wind%,3,0,0,0)
  PROCset_icon_state(so_wind%,24,0,0,0)
  PROCset_icon_state(so_wind%,8,0,1,0)
  $FNindirection(so_wind%,3)=STR$((s_int%(ac%+1)AND &FFFF000)>>>16)
  $FNindirection(so_wind%,8)="0"
 WHEN 2
  PROCset_icon_state(so_wind%,25,0,0,0)
  PROCset_icon_state(so_wind%,3,0,1,0)
  PROCset_icon_state(so_wind%,24,1,0,0)
  PROCset_icon_state(so_wind%,8,0,0,0)
  $FNindirection(so_wind%,3)="0"
  $FNindirection(so_wind%,8)=STR$(s_int%(ac%+1))
 ENDCASE
$FNindirection(so_wind%,13)=FNpoint(s_trans%(ac%+1))
$FNindirection(so_wind%,23)=FNdecode_given_date(s_next%(ac%+1))
PROCredraw_icon(so_wind%,2)
PROCredraw_icon(so_wind%,13)
PROCredraw_icon(so_wind%,15)
PROCredraw_icon(so_wind%,17)
PROCredraw_icon(so_wind%,23)
PROCredraw_icon(so_wind%,3)
PROCredraw_icon(so_wind%,8)
PROCset_icon_state(spane%,ac%,1,0,0)
PROCopen_window(so_wind%)
PROCend_caret(so_wind%,2)
edit_so%=ac%
ENDPROC
:
DEF PROCcancel_so
PROCset_icon_state(spane%,edit_so%,0,0,0)
edit_so%=-1
PROCclose_window(so_wind%)
PROCend_caret(sl_wind%,-1)
ENDPROC
:
DEF PROCchange_so
IF FNtest_date($FNindirection(so_wind%,23)) THEN ENDPROC
IF FNvalid_transfer($FNindirection(so_wind%,15),$FNindirection(so_wind%,17)) THEN ENDPROC
PROCset_icon_state(spane%,edit_so%,0,0,0)
PROCclose_window(so_wind%)
IF $FNindirection(so_wind%,2)="" THEN edit_so%=-1 : ENDPROC
$FNindirection(spane%,edit_so%)=$FNindirection(so_wind%,2)
s_from%(edit_so%+1)=FNaccount_number($FNindirection(so_wind%,15))
IF s_from%(edit_so%+1)=-1 THEN s_from_text$(edit_so%+1)=$FNindirection(so_wind%,15)
s_to%(edit_so%+1)=FNaccount_number($FNindirection(so_wind%,17))
IF s_to%(edit_so%+1)=-1 THEN s_from_text$(edit_so%+1)=$FNindirection(so_wind%,17)
CASE TRUE OF
 WHEN FNicon_selected(so_wind%,25)
  s_type%(edit_so%+1)=1
  s_int%(edit_so%+1)=FNget_given_day(FNencode_text_date($FNindirection(so_wind%,23)))+(VAL($FNindirection(so_wind%,3))<<16)
 WHEN FNicon_selected(so_wind%,24)
  s_type%(edit_so%+1)=2
  s_int%(edit_so%+1)=VAL($FNindirection(so_wind%,8))
 ENDCASE
s_trans%(edit_so%+1)=FNval($FNindirection(so_wind%,13))
s_next%(edit_so%+1)=FNencode_text_date($FNindirection(so_wind%,23))
PROCredraw_icon(spane%,edit_so%)
edit_so%=-1
modified%=TRUE
PROCmain_window_title
PROCend_caret(sl_wind%,-1)
ENDPROC
:
DEF PROCget_standing_orders
LOCAL loop%,so%,count%,day%,month%,year%,today%
SYS "Hourglass_On"
count%=s_list_offset%
day%=FNget_given_day(date%)
month%=FNget_given_month(date%)
year%=FNget_given_year(date%)
s_ref%(count%)=-1
s_ref%(count%+1)=-1
IF list_ahead%>0 THEN
FOR loop%=1 TO list_ahead%
 day%+=1
 IF day%>FNdays_in_month(month%,year%) THEN day%=1 : month%+=1
 IF month%>12 THEN month%=1 : year%+=1
 today%=FNencode_num_date(day%,month%,year%)
 FOR so%=1 TO so_number%
  IF (s_next%(so%)=today%) AND (count%<=7*s_orders%) THEN
   s_ref%(count%)=so%
   s_dates%(count%)=today%
   count%+=1
  ENDIF
 NEXT so%
NEXT loop%
ENDIF
!b%=0
b%!4=((count%+((NOT FNpreference(25))*s_list_offset%))*-32)-56
b%!8=1450
b%!12=0
SYS "Wimp_SetExtent",swl_wind%,b%
PROCredraw_window(swl_wind%)
!b%=swl_wind%
SYS "Wimp_GetWindowState",,b%
IF (b%!32 AND 1<<16)<>0 THEN
 PROCclose_window(swl_wind%) : PROCclose_window(wpane%)
 PROCopen_window(swl_wind%) : PROCopen_window(wpane%)
ENDIF
SYS "Hourglass_Off"
ENDPROC
:
DEF PROCnew_head
LOCAL loop%
loop%=-1
REPEAT
 loop%+=1
 UNTIL $FNindirection(hpane%,loop%)="" OR loop%>=(headers%-1)
IF $FNindirection(hpane%,loop%)="" THEN
 h_number%+=1
 $FNindirection(hpane%,loop%)="Untitled"
 PROCredraw_icon(hpane%,loop%)
 h_type%(loop%+1)=3
 IF loop%<9 THEN loop%=9
 !b%=0
 b%!4=(loop%+1)*-44
 b%!8=548
 b%!12=0
 SYS "Wimp_SetExtent",hpane%,b%
 !b%=hpane%
 SYS "Wimp_GetWindowState",,b%
 SYS "Wimp_OpenWindow",,b%
 !b%=0
 b%!4=((h_number%)*-32)-52
 b%!8=1312
 b%!12=0
 SYS "Wimp_SetExtent",hel_wind%,b%
 !b%=hel_wind%
 SYS "Wimp_GetWindowState",,b%
 PROCredraw_window(hel_wind%)
 modified%=TRUE
 PROCmake_header_menu
 PROCmain_window_title
ENDIF
PROCredraw_window(hel_wind%)
ENDPROC
:
DEF PROCedit_head(ac%)
IF $FNindirection(hpane%,ac%)="" THEN ENDPROC
IF edit_h%<>-1 THEN PROCset_icon_state(hpane%,edit_h%,0,0,0)
$FNindirection(he_wind%,4)=$FNindirection(hpane%,ac%)
$FNindirection(he_wind%,13)=FNdecode_given_date(h_fdate%(ac%+1))
$FNindirection(he_wind%,15)=FNdecode_given_date(h_tdate%(ac%+1))
PROCredraw_icon(he_wind%,4)
PROCset_icon_state(he_wind%,8,ABS(h_type%(ac%+1) AND 1),0,0)
PROCset_icon_state(he_wind%,9,ABS(h_type%(ac%+1) AND 2),0,0)
PROCset_icon_state(hpane%,ac%,1,0,0)
PROCopen_window(he_wind%)
PROCend_caret(he_wind%,4)
edit_h%=ac%
ENDPROC
:
DEF PROCcancel_head
PROCset_icon_state(hpane%,edit_h%,0,0,0)
edit_h%=-1
PROCclose_window(he_wind%)
PROCend_caret(head_wind%,-1)
ENDPROC
:
DEF PROCchange_head
IF FNtest_date($FNindirection(he_wind%,13)) THEN ENDPROC
IF FNtest_date($FNindirection(he_wind%,15)) THEN ENDPROC
PROCset_icon_state(hpane%,edit_h%,0,0,0)
PROCclose_window(he_wind%)
IF $FNindirection(he_wind%,4)="" THEN edit_h%=-1 : ENDPROC
$FNindirection(hpane%,edit_h%)=$FNindirection(he_wind%,4)
h_type%(edit_h%+1)=0
IF FNicon_selected(he_wind%,8) THEN h_type%(edit_h%+1)+=1
IF FNicon_selected(he_wind%,9) THEN h_type%(edit_h%+1)+=2
h_fdate%(edit_h%+1)=FNencode_text_date($FNindirection(he_wind%,13))
h_tdate%(edit_h%+1)=FNencode_text_date($FNindirection(he_wind%,15))
PROCredraw_icon(hpane%,edit_h%)
edit_h%=-1
modified%=TRUE
PROCmake_header_menu
PROCmain_window_title
PROCredraw_window(hel_wind%)
PROCend_caret(head_wind%,-1)
PROCredraw_main
PROCrecalc
ENDPROC
:
DEF PROCdelete_he
LOCAL loop%,head%
FOR loop%=1 TO size%
 IF (from%(loop%) AND FNhi) AND from%(loop%)>-1 THEN
  head%=from%(loop%)-FNhi
  IF head%=edit_h% THEN
   from_text$(loop%)=$FNindirection(hpane%,head%)
   from%(loop%)=-1
  ENDIF
 ENDIF
 IF (to%(loop%) AND FNhi) AND to%(loop%)>-1THEN
  head%=to%(loop%)-FNhi
  IF head%=edit_h% THEN
   from_text$(loop%)=$FNindirection(hpane%,head%)
   to%(loop%)=-1
  ENDIF
 ENDIF
NEXT loop%
IF (edit_h%+1)<h_number% THEN
 FOR loop%=edit_h%+1 TO h_number%
  $FNindirection(hpane%,loop%-1)=$FNindirection(hpane%,loop%)
  h_type%(loop%)=h_type%(loop%+1)
  h_fdate%(loop%)=h_fdate%(loop%+1)
  h_tdate%(loop%)=h_tdate%(loop%+1)
 NEXT loop%
 FOR loop%=1 TO size%
  IF (from%(loop%) AND FNhi) AND from%(loop%)>-1 THEN
   head%=from%(loop%)-FNhi
   IF head%>edit_h% THEN head%-=1
   from%(loop%)=head%+FNhi
  ENDIF
  IF (to%(loop%) AND FNhi) AND to%(loop%)>-1 THEN
   head%=to%(loop%)-FNhi
   IF head%>edit_h% THEN head%-=1
   to%(loop%)=head%+FNhi
  ENDIF
 NEXT loop%
ENDIF
$FNindirection(hpane%,h_number%-1)=""
h_type%(h_number%)=0
h_fdate%(h_number%)=0
h_tdate%(h_number%)=0
PROCset_icon_state(hpane%,edit_h%,0,0,0)
edit_h%=h_number%-1
IF edit_h%<10 THEN edit_h%=10
!b%=0
b%!4=(edit_h%)*-44
b%!8=548
b%!12=0
SYS "Wimp_SetExtent",hpane%,b%
!b%=hpane%
SYS "Wimp_GetWindowState",,b%
SYS "Wimp_OpenWindow",,b%
edit_h%=-1
h_number%-=1
!b%=0
b%!4=((h_number%)*-32)-52
b%!8=1312
b%!12=0
SYS "Wimp_SetExtent",hel_wind%,b%
!b%=hel_wind%
SYS "Wimp_GetWindowState",,b%
PROCredraw_window(hel_wind%)
PROCclose_window(he_wind%)
PROCredraw_window(hpane%)
PROCend_caret(head_wind%,-1)
modified%=TRUE
PROCmake_header_menu
PROCrecalc
PROCmain_window_title
PROCredraw_window(hel_wind%)
ENDPROC
:
DEF PROCmake_header_menu
LOCAL loop%,py%,pz%,pw%
py%=0 : pz%=0 : pw%=0
ww%=7 : wz%=7 : wy%=7
FOR loop%=0 TO h_number%-1
PROCset_menu_text(ymenu%,loop%,blank%,21)
PROCset_menu_text(zmenu%,loop%,blank%,21)
NEXT loop%
FOR loop%=0 TO h_number%-1
 IF (h_type%(loop%+1) AND 1) THEN PROCset_menu_text(ymenu%,py%,FNindirection(hpane%,loop%),LEN($FNindirection(hpane%,loop%))+1) : py%+=1 : IF LEN($FNindirection(hpane%,loop%))>wy% THEN wy%=LEN($FNindirection(hpane%,loop%))
 IF (h_type%(loop%+1) AND 2) THEN PROCset_menu_text(zmenu%,pz%,FNindirection(hpane%,loop%),LEN($FNindirection(hpane%,loop%))+1) : pz%+=1 : IF LEN($FNindirection(hpane%,loop%))>wz% THEN wz%=LEN($FNindirection(hpane%,loop%))
 PROCset_menu_text(wmenu%,pw%,FNindirection(hpane%,loop%),LEN($FNindirection(hpane%,loop%))+1) : pw%+=1 : IF LEN($FNindirection(hpane%,loop%))>ww% THEN ww%=LEN($FNindirection(hpane%,loop%))
NEXT loop%
PROCset_menu_width(wmenu%,ww%)
PROCset_menu_width(ymenu%,wy%)
PROCset_menu_width(zmenu%,wz%)
FOR loop%=0 TO h_number%-1
 PROCset_menu_end(wmenu%,loop%,ABS(loop%=(pw%-1)))
 PROCset_menu_end(ymenu%,loop%,ABS(loop%=(py%-1)))
 PROCset_menu_end(zmenu%,loop%,ABS(loop%=(pz%-1)))
NEXT loop%
no_w%=(pw%>0)
no_y%=(py%>0)
no_z%=(pz%>0)
ENDPROC
:
:
DEF PROCget_date
LOCAL loop%,ye%,mo%,dy%,up_date%,add%
IF date$=FNget_system_date("%w3, %dy %m3 %ce%yr") AND system_date% THEN ENDPROC
IF (NOT system_date%) AND FNtest_date(other_date$) THEN ENDPROC
IF system_date% THEN
 date$=FNget_system_date("%w3, %dy %m3 %ce%yr")
 date%=FNencode_text_date(FNget_system_date("%dy"+date_sep$+"%mn"+date_sep$+"%ce%yr"))
ELSE
 date%=FNencode_text_date(other_date$)
 date$=FNdecode_given_date(date%)
 other_date$=date$
 PROCdisplay_menu(-1,0,0)
ENDIF
:
IF date$="" OR FNno_date(date%) THEN date$="No Date" : date%=0
:
$FNindirection(pane%,11)=date$
PROCredraw_icon(pane%,11)
:
IF FNpreference(9) THEN PROCadd_standing_orders(TRUE)
PROCget_standing_orders
ENDPROC
:
DEF FNencode_text_date(s$)
LOCAL d%,m%,y%,i%
i%=INSTR(s$,date_sep$)
d%=VAL(LEFT$(s$,i%-1))
s$=MID$(s$,i%+1)
i%=INSTR(s$,date_sep$)
m%=VAL(LEFT$(s$,i%-1))
s$=MID$(s$,i%+1)
y%=VAL(s$)
IF FNpreference(20) AND y%<100 THEN y%+=date_from%
=(y%<<10)+(m%<<5)+d%
:
DEF PROCstore_num_date(r%,d%,m%,y%)
date%(r%)=(y%<<10)+(m%<<5)+d%
ENDPROC
:
DEF FNget_stored_day(r%)
=date%(r%) AND %11111
:
DEF FNget_stored_month(r%)
=(date%(r%) AND %1111100000)>>>5
:
DEF FNget_stored_year(r%)
=(date%(r%) AND %11111111111111111111110000000000)>>>10
:
DEF FNget_given_day(r%)
=r% AND %11111
:
DEF FNget_given_month(r%)
=(r% AND %1111100000)>>>5
:
DEF FNget_given_year(r%)
=(r% AND %11111111111111111111110000000000)>>>10
:
DEF FNencode_num_date(d%,m%,y%)
=(y%<<10)+(m%<<5)+d%
:
DEF PROCstore_text_date(r%,s$)
LOCAL d%,m%,y%,i%
i%=INSTR(s$,date_sep$)
d%=VAL(LEFT$(s$,i%-1))
s$=MID$(s$,i%+1)
i%=INSTR(s$,date_sep$)
m%=VAL(LEFT$(s$,i%-1))
s$=MID$(s$,i%+1)
y%=VAL(s$)
IF FNpreference(20) AND y%<100 THEN y%+=date_from%
PROCstore_num_date(r%,d%,m%,y%)
ENDPROC
:
DEF FNdecode_given_date(d%)
LOCAL d$,m$,y$
IF FNget_given_day(d%)=0 OR FNget_given_month(d%)=0 THEN =""
d$=STR$(FNget_given_day(d%))
m$=STR$(FNget_given_month(d%))
y$=STR$(FNget_given_year(d%))
IF LEN(d$)=1 THEN d$="0"+d$
IF LEN(m$)=1 THEN m$="0"+m$
IF LEN(y$)=1 THEN y$="0"+y$
IF FNpreference(19) THEN =d$+date_sep$+m$+date_sep$+y$
=d$+date_sep$+m$+date_sep$+RIGHT$(y$,2)
:
DEF FNdecode_stored_date(r%)
LOCAL d$,m$,y$
IF FNget_stored_day(r%)=0 OR FNget_stored_month(r%)=0 THEN =""
d$=STR$(FNget_stored_day(r%))
m$=STR$(FNget_stored_month(r%))
y$=STR$(FNget_stored_year(r%))
IF LEN(d$)=1 THEN d$="0"+d$
IF LEN(m$)=1 THEN m$="0"+m$
IF LEN(y$)=1 THEN y$="0"+y$
IF FNpreference(19) THEN =d$+date_sep$+m$+date_sep$+y$
=d$+date_sep$+m$+date_sep$+RIGHT$(y$,2)
:
DEF FNget_system_date(f$)
LOCAL end%
$time_format%=f$+CHR$(0)
time_b%?0 = 3
SYS "OS_Word",14,time_b%
SYS "OS_ConvertDateAndTime",time_b%,time_string%,64,time_format% TO ,end%
?end%=13
=$time_string%
:
DEF FNno_date(d%)
=(FNget_given_day(d%)=0 OR FNget_given_month(d%)=0)
:
DEF FNtest_date(s$)
LOCAL d%,m%,y%,i%,ok%,m$,d$
d$=s$
ok%=TRUE
IF s$="" THEN =NOT ok%
i%=INSTR(s$,date_sep$)
d%=VAL(LEFT$(s$,i%-1))
s$=MID$(s$,i%+1)
i%=INSTR(s$,date_sep$)
m%=VAL(LEFT$(s$,i%-1))
s$=MID$(s$,i%+1)
y%=VAL(s$)
IF FNpreference(20) AND y%<100 AND y%>0 THEN y%+=date_from%
:
IF d%<1 OR d%>FNdays_in_month(m%,y%) THEN m$="InvDay" : ok%=FALSE
IF m%<1 OR m%>12 THEN m$="InvMonth" : ok%=FALSE
IF y%<1 THEN m$="InvYear" : ok%=FALSE
:
IF INSTR(d$,date_sep$)=0 THEN  mess%=0 : m$="DateFormat|"+date_sep$ : ok%=FALSE
:
IF NOT ok% THEN mess%=0 : PROCmessage(m$,"","OK","")
=NOT ok%
:
DEF FNdays_in_month(m%,y%)
LOCAL d%
CASE m% OF
 WHEN 4,6,9,11 : d%=30
 WHEN 1,3,5,7,8,10,12 : d%=31
 WHEN 2
  d%=28
  IF ((y% MOD 4)=0) AND NOT ((y% MOD 100)=0) THEN d%=29
  IF ((y% MOD 4)=0) AND ((y% MOD 100)=0) AND ((y% MOD 400)=0) THEN d%=29
 ENDCASE
=d%
:
DEF FNvalid_transfer(a$,b$)
LOCAL a1%,a2%,ok%,m$
ok%=TRUE
a1%=FNaccount_number(a$)
a2%=FNaccount_number(b$)
IF a1%=-1 AND a2%=-1 THEN ok%=FALSE : m$="IllegalTrans"
:
IF NOT ok% THEN mess%=0 : PROCmessage(m$,"","OK","")
=NOT ok%
:
DEF FNpreference(p%)
=((preferences% AND (1<<p%))<>0)
:
DEF PROCpreference(p%,state%)
LOCAL
IF ((preferences% AND (1<<p%))<>0) THEN preferences%-=(1<<p%)
IF state% THEN preferences%+=(1<<p%)
ENDPROC
:
DEF PROCsave_preferences(s%)
IF FNtest_date($FNindirection(ppane%,58)) THEN ENDPROC
PROCpreference(0,FNicon_selected(ppane%,2))
PROCpreference(1,FNicon_selected(ppane%,3))
PROCpreference(2,FNicon_selected(ppane%,8))
PROCpreference(3,FNicon_selected(ppane%,9))
PROCpreference(4,FNicon_selected(ppane%,10))
PROCpreference(5,FNicon_selected(ppane%,11))
PROCpreference(6,FNicon_selected(ppane%,17))
PROCpreference(7,FNicon_selected(ppane%,18))
PROCpreference(8,FNicon_selected(ppane%,19))
PROCpreference(9,FNicon_selected(ppane%,14))
PROCpreference(10,FNicon_selected(ppane%,15))
PROCpreference(11,FNicon_selected(ppane%,16))
PROCpreference(12,FNicon_selected(ppane%,20))
PROCpreference(13,FNicon_selected(ppane%,21))
PROCpreference(14,FNicon_selected(ppane%,22))
PROCpreference(15,FNicon_selected(ppane%,23))
PROCpreference(16,FNicon_selected(ppane%,26))
PROCpreference(17,FNicon_selected(ppane%,27))
PROCpreference(18,FNicon_selected(ppane%,28))
PROCpreference(19,FNicon_selected(ppane%,31))
PROCpreference(20,FNicon_selected(ppane%,32))
PROCpreference(21,FNicon_selected(ppane%,33))
PROCpreference(22,FNicon_selected(ppane%,34))
PROCpreference(23,FNicon_selected(ppane%,60))
PROCpreference(24,FNicon_selected(ppane%,61))
PROCpreference(25,FNicon_selected(ppane%,62))
PROCpreference(26,FNicon_selected(ppane%,66))
PROCpreference(27,FNicon_selected(ppane%,67))
PROCpreference(28,FNicon_selected(ppane%,68))
PROCpreference(29,FNicon_selected(ppane%,69))
:
s_order_limit%=VAL($FNindirection(ppane%,35))
list_ahead%=VAL($FNindirection(ppane%,56))
date_from%=VAL($FNindirection(ppane%,63))
date_sep$=$FNindirection(ppane%,71)
:
pref_date%=FNencode_text_date($FNindirection(ppane%,58))
system_date%=FNpreference(29)
other_date$=FNdecode_given_date(pref_date%)
PROCget_date
:
grid_colour%=FNget_icon_colour(ppane%,38)
text_colour%=FNget_icon_colour(ppane%,41)
back_colour%=FNget_icon_colour(ppane%,44)
sel_colour%=FNget_icon_colour(ppane%,47)
rep_colour%=FNget_icon_colour(ppane%,50)
fill_colour%=FNget_icon_colour(ppane%,53)
:
PROCwindow_background(main%,back_colour%)
PROCwindow_background(acc_view%,back_colour%)
PROCwindow_background(hel_wind%,back_colour%)
PROCwindow_background(bal_wind%,back_colour%)
PROCwindow_background(swl_wind%,back_colour%)
:
IF s% THEN
file%=OPENOUT("<Accounts+$Dir>.Choices")
PRINT#file%,preferences%,s_order_limit%,grid_colour%,text_colour%,back_colour%,sel_colour%,rep_colour%,fill_colour%,date_from%,date_sep$,list_ahead%,pref_date%
CLOSE#file%
ENDIF
PROCrecalc
PROCget_standing_orders
PROCload_font
PROCredraw_main
PROCredraw_window(hel_wind%)
PROCredraw_window(bal_wind%)
PROCredraw_window(swl_wind%)
PROCset_tool_state
ENDPROC
:
DEF PROCload_preferences(l%)
IF l% THEN
file%=OPENIN("<Accounts+$Dir>.Choices")
INPUT#file%,preferences%,s_order_limit%,grid_colour%,text_colour%,back_colour%,sel_colour%,rep_colour%,fill_colour%,date_from%,date_sep$,list_ahead%,pref_date%
CLOSE#file%
ENDIF
PROCset_icon_state(ppane%,2,FNpreference(0),0,0)
PROCset_icon_state(ppane%,3,FNpreference(1),0,0)
PROCset_icon_state(ppane%,8,FNpreference(2),0,0)
PROCset_icon_state(ppane%,9,FNpreference(3),0,0)
PROCset_icon_state(ppane%,10,FNpreference(4),0,0)
PROCset_icon_state(ppane%,11,FNpreference(5),0,0)
PROCset_icon_state(ppane%,17,FNpreference(6),0,0)
PROCset_icon_state(ppane%,18,FNpreference(7),0,0)
PROCset_icon_state(ppane%,19,FNpreference(8),0,0)
PROCset_icon_state(ppane%,14,FNpreference(9),0,0)
PROCset_icon_state(ppane%,15,FNpreference(10),0,0)
PROCset_icon_state(ppane%,16,FNpreference(11),0,0)
PROCset_icon_state(ppane%,20,FNpreference(12),0,0)
PROCset_icon_state(ppane%,21,FNpreference(13),0,0)
PROCset_icon_state(ppane%,22,FNpreference(14),0,0)
PROCset_icon_state(ppane%,23,FNpreference(15),0,0)
PROCset_icon_state(ppane%,26,FNpreference(16),0,0)
PROCset_icon_state(ppane%,27,FNpreference(17),0,0)
PROCset_icon_state(ppane%,28,FNpreference(18),0,0)
PROCset_icon_state(ppane%,31,FNpreference(19),0,0)
PROCset_icon_state(ppane%,32,FNpreference(20),0,0)
PROCset_icon_state(ppane%,33,FNpreference(21),0,0)
PROCset_icon_state(ppane%,34,FNpreference(22),0,0)
PROCset_icon_state(ppane%,60,FNpreference(23),0,0)
PROCset_icon_state(ppane%,61,FNpreference(24),0,0)
PROCset_icon_state(ppane%,62,FNpreference(25),0,0)
PROCset_icon_state(ppane%,66,FNpreference(26) AND FNpreference(0),(NOT FNpreference(0)) OR (NOT os_350%),0)
PROCset_icon_state(ppane%,67,FNpreference(27) AND FNpreference(18),(NOT FNpreference(0)),0)
PROCset_icon_state(ppane%,68,FNpreference(28),0,0)
PROCset_icon_state(ppane%,69,FNpreference(29),0,0)
PROCset_icon_state(ppane%,70,NOT FNpreference(29),0,0)
:
$FNindirection(ppane%,71)=date_sep$
PROCredraw_icon(ppane%,71)
:
$FNindirection(ppane%,56)=STR$(list_ahead%)
PROCredraw_icon(ppane%,56)
:
$FNindirection(ppane%,35)=STR$(s_order_limit%)
PROCredraw_icon(ppane%,35)
PROCset_icon_state(ppane%,38,0,ABS(NOT FNicon_selected(ppane%,3)),0)
PROCset_icon_state(ppane%,39,0,ABS(NOT FNicon_selected(ppane%,3)),0)
PROCset_icon_state(ppane%,40,0,ABS(NOT FNicon_selected(ppane%,3)),0)
:
PROCset_icon_state(ppane%,35,0,ABS(NOT FNpreference(21)),0)
PROCset_icon_state(ppane%,36,0,ABS(NOT FNpreference(21)),0)
PROCset_icon_state(ppane%,37,0,ABS(NOT FNpreference(21)),0)
:
$FNindirection(ppane%,63)=STR$(date_from%)
PROCredraw_icon(ppane%,63)
PROCset_icon_state(ppane%,63,0,ABS(NOT FNpreference(20)),0)
PROCset_icon_state(ppane%,57,0,ABS(NOT FNpreference(20)),0)
:
$FNindirection(ppane%,58)=FNdecode_given_date(pref_date%)
PROCredraw_icon(ppane%,58)
PROCset_icon_state(ppane%,58,0,ABS(FNpreference(29)),0)
system_date%=FNpreference(29)
other_date$=$FNindirection(ppane%,58)
REMPROCget_date
:
PROCset_icon_colour(ppane%,38,7,grid_colour%)
PROCset_icon_colour(ppane%,41,7,text_colour%)
PROCset_icon_colour(ppane%,44,7,back_colour%)
PROCset_icon_colour(ppane%,47,7,sel_colour%)
PROCset_icon_colour(ppane%,50,7,rep_colour%)
PROCset_icon_colour(ppane%,53,7,fill_colour%)
:
PROCwindow_background(main%,back_colour%)
PROCwindow_background(acc_view%,back_colour%)
PROCwindow_background(hel_wind%,back_colour%)
PROCwindow_background(bal_wind%,back_colour%)
PROCwindow_background(swl_wind%,back_colour%)
:
PROCload_font
PROCrecalc
PROCredraw_main
PROCredraw_window(hel_wind%)
ENDPROC
:
DEF PROCquick_save(t%)
CASE t% OF
 WHEN 1
  IF INSTR($FNindirection(save%,1),".")=0 THEN ERROR 255,FNmess_trans("NoPath")
 WHEN 2,3
  IF INSTR($FNindirection(exp_wind%,1),".")=0 THEN ERROR 255,FNmess_trans("NoPath")
 ENDCASE
CASE t% OF
 WHEN 1 : PROCsave
 WHEN 2 : PROCsave_account
 WHEN 3 : PROCsave_text
 WHEN 4 : PROCsave_csv
 WHEN 5 : PROCsave_tsv
 WHEN 6 : PROCsave_csvh
 WHEN 7 : PROCsave_tsvh
 WHEN 8 : PROCsave_texth
 ENDCASE
ENDPROC
:
DEF PROCsave
LOCAL loop%,file%
$m_title%=$FNindirection(save%,1)
file%=OPENOUT($FNindirection(save%,1))
PRINT#file%,account_name$
PRINT#file%,size%
FOR loop%=0 TO accounts%-1
 PRINT#file%,$FNindirection(acc_wind%,loop%+1)
 PRINT#file%,initial%(loop%)
 PRINT#file%,a_fdate%(loop%)
 PRINT#file%,a_tdate%(loop%)
NEXT loop%
FOR loop%=1 TO size%
 PRINT#file%,date%(loop%)
 PRINT#file%,to%(loop%)
 PRINT#file%,from%(loop%)
 PRINT#file%,from_text$(loop%)
 PRINT#file%,trans%(loop%)
 PRINT#file%,text$(loop%)
NEXT loop%
PRINT#file%,so_number%
IF so_number%>0 THEN
 FOR loop%=1 TO so_number%
  PRINT#file%,$FNindirection(spane%,loop%-1)
  PRINT#file%,s_to%(loop%)
  PRINT#file%,s_from%(loop%)
  PRINT#file%,s_from_text$(loop%)
  PRINT#file%,s_trans%(loop%)
  PRINT#file%,s_next%(loop%)
  PRINT#file%,s_type%(loop%)
  PRINT#file%,s_int%(loop%)
 NEXT loop%
ENDIF
PRINT#file%,h_number%
IF h_number%>0 THEN
 FOR loop%=1 TO h_number%
  PRINT#file%,$FNindirection(hpane%,loop%-1)
  PRINT#file%,h_type%(loop%)
  PRINT#file%,h_fdate%(loop%)
  PRINT#file%,h_tdate%(loop%)
 NEXT loop%
ENDIF
modified%=FALSE
PROCmain_window_title
CLOSE#file%
SYS "OS_File",&12,$FNindirection(save%,1),file_type_accounts%
PROCdisplay_menu(-1,0,0)
ENDPROC
:
DEF PROCsave_account
LOCAL loop%,file%,pref%,date$,val%,sep$,head%,date%
date%=FNicon_selected(exp_wind%,7)
pref%=FNpreference(19)
sep$=date_sep$
date_sep$="/"
PROCpreference(19,0)
SYS "Hourglass_On"
file%=OPENOUT($FNindirection(exp_wind%,1))
PRINT#file%,"",0,0,initial%(view_account%)
FOR loop%=1 TO size%(view_account%)
 date$=FNdecode_stored_date(ABS(line_ref%(view_account%,loop%)))
 IF SGN(line_ref%(view_account%,loop%))=1 THEN
  IF from%(ABS(line_ref%(view_account%,loop%)))>-1 THEN
   IF from%(ABS(line_ref%(view_account%,loop%))) AND FNhi THEN
    head%=from%(ABS(line_ref%(view_account%,loop%)))-FNhi
    text$=$FNindirection(hpane%,head%)
   ELSE
    text$=$FNindirection(acc_wind%,from%(ABS(line_ref%(view_account%,loop%)))+1)
   ENDIF
  ELSE
   text$=from_text$(ABS(line_ref%(view_account%,loop%)))
  ENDIF
 ELSE
  IF to%(ABS(line_ref%(view_account%,loop%)))>-1 THEN
   IF to%(ABS(line_ref%(view_account%,loop%))) AND FNhi THEN
    head%=to%(ABS(line_ref%(view_account%,loop%)))-FNhi
    text$=$FNindirection(hpane%,head%)
   ELSE
    text$=$FNindirection(acc_wind%,to%(ABS(line_ref%(view_account%,loop%)))+1)
   ENDIF
  ELSE
   text$=from_text$(ABS(line_ref%(view_account%,loop%)))
  ENDIF
 ENDIF
 IF date% THEN text$=FNtext(text$,12,TRUE)+date$
 PRINT#file%,text$
 val%=trans%(ABS(line_ref%(view_account%,loop%)))
 IF SGN(line_ref%(view_account%,loop%))=1 THEN
  PRINT#file%,val%,0
 ELSE
  PRINT#file%,0,val%
 ENDIF
 val%=run_bal%(view_account%,loop%)
 PRINT#file%,val%
NEXT loop%
CLOSE#file%
SYS "OS_File",&12,$FNindirection(exp_wind%,1),file_type_account%
SYS "Hourglass_Off"
PROCdisplay_menu(-1,0,0)
PROCpreference(19,pref%)
date_sep$=sep$
PROCinfo_bar_message("AccExp|"+FNmess_trans("Account"),3)
ENDPROC
:
DEF PROCsave_text
LOCAL loop%,file%,line$,head%
SYS "Hourglass_On"
file%=OPENOUT($FNindirection(exp_wind%,1))
IF FNicon_selected(exp_wind%,9) THEN
 text$="   "+FNmess_trans("File")+": "+account_name$
 BPUT#file%,text$
 text$=FNmess_trans("Account")+": "+$FNindirection(acc_wind%,view_account%+1)
 BPUT#file%,text$
 text$="   "+FNmess_trans("Date")+": "+FNdecode_given_date(date%)
 BPUT#file%,text$
 BPUT#file%,""
ENDIF
IF FNicon_selected(exp_wind%,8) THEN
 dwidth%=LEN(FNdecode_given_date(date%))-4
 text$=STRING$((width% DIV 2)+(width% MOD 2)," ")+FNmess_trans("Date")+STRING$((dwidth% DIV 2)," ")+" "
 text$+=FNtext(FNmess_trans("FromTo"),20,TRUE)+" "+FNtext(FNmess_trans("Credit"),9,FALSE)+" "
 text$+=FNtext(FNmess_trans("Debit"),9,FALSE)+" "+FNtext(FNmess_trans("Bal"),9,FALSE)+" Description"
 IF FNicon_selected(exp_wind%,7) THEN text$="    "+text$
 BPUT#file%,text$
ENDIF
FOR loop%=1 TO size%(view_account%)
 IF FNicon_selected(exp_wind%,7) THEN text$=FNtext(STR$(loop%),3,FALSE)+" " ELSE text$=""
 text$+=FNdecode_stored_date(ABS(line_ref%(view_account%,loop%)))
 text$=LEFT$(text$+STRING$(dwidth%," "),dwidth%)
 line$=text$+" "
 IF SGN(line_ref%(view_account%,loop%))=1 THEN
  IF from%(ABS(line_ref%(view_account%,loop%)))>-1 THEN
   IF from%(ABS(line_ref%(view_account%,loop%))) AND FNhi THEN
    head%=from%(ABS(line_ref%(view_account%,loop%)))-FNhi
    text$=$FNindirection(hpane%,head%)
   ELSE
    text$=$FNindirection(acc_wind%,from%(ABS(line_ref%(view_account%,loop%)))+1)
   ENDIF
  ELSE
   text$=from_text$(ABS(line_ref%(view_account%,loop%)))
  ENDIF
 ELSE
  IF to%(ABS(line_ref%(view_account%,loop%)))>-1 THEN
   IF to%(ABS(line_ref%(view_account%,loop%))) AND FNhi THEN
    head%=to%(ABS(line_ref%(view_account%,loop%)))-FNhi
    text$=$FNindirection(hpane%,head%)
   ELSE
    text$=$FNindirection(acc_wind%,to%(ABS(line_ref%(view_account%,loop%)))+1)
   ENDIF
  ELSE
   text$=from_text$(ABS(line_ref%(view_account%,loop%)))
  ENDIF
 ENDIF
 line$+=FNtext(text$,20,TRUE)+" "
 text$=FNpoint(trans%(ABS(line_ref%(view_account%,loop%))))
 IF SGN(line_ref%(view_account%,loop%))=1 THEN
  line$+=FNtext("",9,FALSE)+" "+FNtext(text$,9,FALSE)+" "
 ELSE
  line$+=FNtext(text$,9,FALSE)+" "+FNtext("",9,FALSE)+" "
 ENDIF
 text$=FNpoint(run_bal%(view_account%,loop%))
 line$+=FNtext(text$,9,FALSE)+" "
 text$=text$(ABS(line_ref%(view_account%,loop%)))
 line$+=text$
 BPUT#file%,line$
NEXT loop%
CLOSE#file%
SYS "OS_File",&12,$FNindirection(exp_wind%,1),file_type_text%
SYS "Hourglass_Off"
PROCdisplay_menu(-1,0,0)
PROCinfo_bar_message("AccExp|"+FNmess_trans("Txt"),3)
ENDPROC
:
DEF PROCsave_csv
LOCAL loop%,file%,line$,head%,q$
SYS "Hourglass_On"
IF FNicon_selected(exp_wind%,9) THEN q$="""" ELSE q$=""
file%=OPENOUT($FNindirection(exp_wind%,1))
IF FNicon_selected(exp_wind%,8) THEN
 width%=LEN(FNdecode_given_date(date%))-4
 text$=q$+FNmess_trans("Date")+q$+","
 text$+=q$+FNmess_trans("FromTo")+q$+","+q$+FNmess_trans("Credit")+q$+","
 text$+=q$+FNmess_trans("Debit")+q$+","+q$+FNmess_trans("Bal")+q$+","+q$+FNmess_trans("Description")+q$
 IF FNicon_selected(exp_wind%,7) THEN text$=q$+q$+","+text$
 BPUT#file%,text$
ENDIF
FOR loop%=1 TO size%(view_account%)
 IF FNicon_selected(exp_wind%,7) THEN line$=STR$(loop%)+"," ELSE line$=""
 text$=FNdecode_stored_date(ABS(line_ref%(view_account%,loop%)))
 line$+=q$+text$+q$+","
 IF SGN(line_ref%(view_account%,loop%))=1 THEN
  IF from%(ABS(line_ref%(view_account%,loop%)))>-1 THEN
   IF from%(ABS(line_ref%(view_account%,loop%))) AND FNhi THEN
    head%=from%(ABS(line_ref%(view_account%,loop%)))-FNhi
    text$=$FNindirection(hpane%,head%)
   ELSE
    text$=$FNindirection(acc_wind%,from%(ABS(line_ref%(view_account%,loop%)))+1)
   ENDIF
  ELSE
   text$=from_text$(ABS(line_ref%(view_account%,loop%)))
  ENDIF
 ELSE
  IF to%(ABS(line_ref%(view_account%,loop%)))>-1 THEN
   IF to%(ABS(line_ref%(view_account%,loop%))) AND FNhi THEN
    head%=to%(ABS(line_ref%(view_account%,loop%)))-FNhi
    text$=$FNindirection(hpane%,head%)
   ELSE
    text$=$FNindirection(acc_wind%,to%(ABS(line_ref%(view_account%,loop%)))+1)
   ENDIF
  ELSE
   text$=from_text$(ABS(line_ref%(view_account%,loop%)))
  ENDIF
 ENDIF
 line$+=q$+text$+q$+","
 text$=FNpoint(trans%(ABS(line_ref%(view_account%,loop%))))
 IF SGN(line_ref%(view_account%,loop%))=1 THEN
  line$+="0,"+text$+","
 ELSE
  line$+=text$+",0,"
 ENDIF
 text$=FNpoint(run_bal%(view_account%,loop%))
 line$+=text$+","
 text$=text$(ABS(line_ref%(view_account%,loop%)))
 line$+=q$+text$+q$
 BPUT#file%,line$
NEXT loop%
CLOSE#file%
SYS "OS_File",&12,$FNindirection(exp_wind%,1),file_type_csv%
SYS "Hourglass_Off"
PROCdisplay_menu(-1,0,0)
PROCinfo_bar_message("AccExp|"+FNmess_trans("CSVN"),3)
ENDPROC
:
DEF PROCsave_tsv
LOCAL loop%,file%,line$,head%
SYS "Hourglass_On"
file%=OPENOUT($FNindirection(exp_wind%,1))
IF FNicon_selected(exp_wind%,8) THEN
 width%=LEN(FNdecode_given_date(date%))-4
 text$=FNmess_trans("Date")+CHR$(9)
 text$+=FNmess_trans("FromTo")+CHR$(9)+FNmess_trans("Credit")+CHR$(9)
 text$+=FNmess_trans("Debit")+CHR$(9)+FNmess_trans("Bal")+CHR$(9)+FNmess_trans("Description")
 IF FNicon_selected(exp_wind%,7) THEN text$=CHR$(9)+text$
 BPUT#file%,text$
ENDIF
FOR loop%=1 TO size%(view_account%)
 IF FNicon_selected(exp_wind%,7) THEN line$=STR$(loop%)+CHR$(9) ELSE line$=""
 text$=FNdecode_stored_date(ABS(line_ref%(view_account%,loop%)))
 line$+=text$+CHR$(9)
 IF SGN(line_ref%(view_account%,loop%))=1 THEN
  IF from%(ABS(line_ref%(view_account%,loop%)))>-1 THEN
   IF from%(ABS(line_ref%(view_account%,loop%))) AND FNhi THEN
    head%=from%(ABS(line_ref%(view_account%,loop%)))-FNhi
    text$=$FNindirection(hpane%,head%)
   ELSE
    text$=$FNindirection(acc_wind%,from%(ABS(line_ref%(view_account%,loop%)))+1)
   ENDIF
  ELSE
   text$=from_text$(ABS(line_ref%(view_account%,loop%)))
  ENDIF
 ELSE
  IF to%(ABS(line_ref%(view_account%,loop%)))>-1 THEN
   IF to%(ABS(line_ref%(view_account%,loop%))) AND FNhi THEN
    head%=to%(ABS(line_ref%(view_account%,loop%)))-FNhi
    text$=$FNindirection(hpane%,head%)
   ELSE
    text$=$FNindirection(acc_wind%,to%(ABS(line_ref%(view_account%,loop%)))+1)
   ENDIF
  ELSE
   text$=from_text$(ABS(line_ref%(view_account%,loop%)))
  ENDIF
 ENDIF
 line$+=text$+CHR$(9)
 text$=FNpoint(trans%(ABS(line_ref%(view_account%,loop%))))
 IF SGN(line_ref%(view_account%,loop%))=1 THEN
  line$+="0"+CHR$(9)+text$+CHR$(9)
 ELSE
  line$+=text$+CHR$(9)+"0"+CHR$(9)
 ENDIF
 text$=FNpoint(run_bal%(view_account%,loop%))
 line$+=text$+CHR$(9)
 text$=text$(ABS(line_ref%(view_account%,loop%)))
 line$+=text$
 BPUT#file%,line$
NEXT loop%
CLOSE#file%
SYS "OS_File",&12,$FNindirection(exp_wind%,1),file_type_text%
SYS "Hourglass_Off"
PROCdisplay_menu(-1,0,0)
PROCinfo_bar_message("AccExp|"+FNmess_trans("TSVN"),3)
ENDPROC
:
DEF PROCsave_texth
LOCAL l%,loop%,file%,line$
SYS "Hourglass_On"
file%=OPENOUT($FNindirection(exp_wind%,1))
IF FNicon_selected(exp_wind%,8) THEN
 line$="   "+FNmess_trans("File")+": "+account_name$
 BPUT#file%,line$
 line$="   "+FNmess_trans("Date")+": "+FNdecode_given_date(date%)
 BPUT#file%,line$
 BPUT#file%,""
ENDIF
dwidth%=LEN(FNdecode_given_date(date%))
IF FNicon_selected(exp_wind%,7) THEN
 line$=FNtext("Header",20,TRUE)+" "+FNmess_trans("Type")+" "
 line$+=FNtext(FNmess_trans("DateF"),dwidth%,2)+" "+FNtext(FNmess_trans("DateT"),width%,2)+" "
 line$+=FNtext(FNmess_trans("In"),9,FALSE)+" "+FNtext(FNmess_trans("Out"),9,FALSE)+" "
 line$+=FNtext(FNmess_trans("Bal"),9,FALSE)
 BPUT#file%,line$
ENDIF
FOR loop%=0 TO h_number%-1
 line$=FNtext($FNindirection(hpane%,loop%),20,TRUE)+" "
 IF (h_type%(loop%+1) AND 1)=1 THEN text$="In "
 IF (h_type%(loop%+1) AND 2)=2 THEN text$=FNmess_trans("Out")
 IF (h_type%(loop%+1) AND 3)=3 THEN text$=FNmess_trans("IO")
 line$+=text$+" "
 text$=FNdecode_given_date(h_fdate%(loop%+1))
 text$=LEFT$(text$+STRING$(dwidth%," "),dwidth%)
 line$+=text$+" "
 text$=FNdecode_given_date(h_tdate%(loop%+1))
 text$=LEFT$(text$+STRING$(dwidth%," "),dwidth%)
 line$+=text$+" "
 IF (h_type%(loop%+1) AND 1)=1 THEN
  line$+=FNtext(FNpoint(h_vals%(loop%+1,0)),9,FALSE)+" "
 ELSE
  line$+="          "
 ENDIF
 IF (h_type%(loop%+1) AND 2)=2 THEN
  line$+=FNtext(FNpoint(h_vals%(loop%+1,1)),9,FALSE)+" "
 ELSE
  line$+="          "
 ENDIF
 line$+=FNtext(FNpoint(h_vals%(loop%+1,0)-h_vals%(loop%+1,1)),9,FALSE)
 BPUT#file%,line$
NEXT loop%
CLOSE#file%
SYS "Hourglass_Off"
PROCdisplay_menu(-1,0,0)
SYS "OS_File",&12,$FNindirection(exp_wind%,1),file_type_text%
PROCinfo_bar_message("HeadExp|"+FNmess_trans("Txt"),1)
ENDPROC
:
DEF PROCsave_csvh
LOCAL l%,loop%,file%,line$,q$
SYS "Hourglass_On"
IF FNicon_selected(exp_wind%,8) THEN q$="""" ELSE q$=""
file%=OPENOUT($FNindirection(exp_wind%,1))
IF FNicon_selected(exp_wind%,7) THEN
 line$=q$+"Header"+q$+","+q$+FNmess_trans("Type")+q$+","
 line$+=q$+FNmess_trans("DateF")+q$+","+q$+FNmess_trans("DateT")+q$+","
 line$+=q$+FNmess_trans("In")+q$+","+q$+FNmess_trans("Out")+q$+","
 line$+=q$+FNmess_trans("Bal")+q$
 BPUT#file%,line$
ENDIF
FOR loop%=0 TO h_number%-1
 line$=q$+$FNindirection(hpane%,loop%)+q$+","
 IF (h_type%(loop%+1) AND 1)=1 THEN text$=FNmess_trans("In")
 IF (h_type%(loop%+1) AND 2)=2 THEN text$=FNmess_trans("Out")
 IF (h_type%(loop%+1) AND 3)=3 THEN text$=FNmess_trans("IO")
 line$+=q$+text$+q$+","
 line$+=q$+FNdecode_given_date(h_fdate%(loop%+1))+q$+","
 line$+=q$+FNdecode_given_date(h_tdate%(loop%+1))+q$+","
 IF (h_type%(loop%+1) AND 1)=1 THEN
  line$+=FNpoint(h_vals%(loop%+1,0))+","
 ELSE
  line$+=","
 ENDIF
 IF (h_type%(loop%+1) AND 2)=2 THEN
  line$+=FNpoint(h_vals%(loop%+1,1))+","
 ELSE
  line$+=","
 ENDIF
 line$+=FNpoint(h_vals%(loop%+1,0)-h_vals%(loop%+1,1))
 BPUT#file%,line$
NEXT loop%
CLOSE#file%
SYS "Hourglass_Off"
PROCdisplay_menu(-1,0,0)
SYS "OS_File",&12,$FNindirection(exp_wind%,1),file_type_csv%
PROCinfo_bar_message("HeadExp|"+FNmess_trans("CSVN"),1)
ENDPROC
:
DEF PROCsave_tsvh
LOCAL l%,loop%,file%,line$
SYS "Hourglass_On"
file%=OPENOUT($FNindirection(exp_wind%,1))
IF FNicon_selected(exp_wind%,7) THEN
 line$="Header"+CHR$(9)+FNmess_trans("Type")+CHR$(9)
 line$+=FNmess_trans("DateF")+CHR$(9)+FNmess_trans("DateT")+CHR$(9)
 line$+=FNmess_trans("In")+CHR$(9)+FNmess_trans("Out")+CHR$(9)
 line$+=FNmess_trans("Bal")
 BPUT#file%,line$
ENDIF
FOR loop%=0 TO h_number%-1
 line$=$FNindirection(hpane%,loop%)+CHR$(9)
 IF (h_type%(loop%+1) AND 1)=1 THEN text$=FNmess_trans("In")
 IF (h_type%(loop%+1) AND 2)=2 THEN text$=FNmess_trans("Out")
 IF (h_type%(loop%+1) AND 3)=3 THEN text$=FNmess_trans("IO")
 line$+=text$+CHR$(9)
 line$+=FNdecode_given_date(h_fdate%(loop%+1))+CHR$(9)
 line$+=FNdecode_given_date(h_tdate%(loop%+1))+CHR$(9)
 IF (h_type%(loop%+1) AND 1)=1 THEN
  line$+=FNpoint(h_vals%(loop%+1,0))+CHR$(9)
 ELSE
  line$+=CHR$(9)
 ENDIF
 IF (h_type%(loop%+1) AND 2)=2 THEN
  line$+=FNpoint(h_vals%(loop%+1,1))+CHR$(9)
 ELSE
  line$+=CHR$(9)
 ENDIF
 line$+=FNpoint(h_vals%(loop%+1,0)-h_vals%(loop%+1,1))
 BPUT#file%,line$
NEXT loop%
CLOSE#file%
SYS "Hourglass_Off"
PROCdisplay_menu(-1,0,0)
SYS "OS_File",&12,$FNindirection(exp_wind%,1),file_type_text%
PROCinfo_bar_message("HeadExp|"+FNmess_trans("TSVN"),1)
ENDPROC
:
DEF PROCsave_textt
LOCAL l%,loop%,file%,line$
SYS "Hourglass_On"
file%=OPENOUT($FNindirection(exp_wind%,1))
IF FNicon_selected(exp_wind%,9) THEN
 line$="   "+FNmess_trans("File")+": "+account_name$
 BPUT#file%,line$
 line$="   "+FNmess_trans("Date")+": "+FNdecode_given_date(date%)
 BPUT#file%,line$
 BPUT#file%,""
ENDIF
dwidth%=LEN(FNdecode_given_date(date%))
IF FNicon_selected(exp_wind%,8) THEN
 IF FNicon_selected(exp_wind%,7) THEN line$="     " ELSE line$=""
 line$+=FNtext(FNmess_trans("Date"),dwidth%,2)+" "
 line$+=FNtext(FNmess_trans("From"),20,TRUE)+" "+FNtext(FNmess_trans("To"),20,TRUE)+" "
 line$+=FNtext(FNmess_trans("Amount"),9,FALSE)+" "
 line$+=FNmess_trans("Description")
 BPUT#file%,line$
ENDIF
FOR loop%=1 TO size%
 IF FNicon_selected(exp_wind%,7) THEN line$=FNtext(STR$(loop%),4,FALSE)+" " ELSE line$=""
 text$=FNdecode_given_date(date%(loop%))
 text$=LEFT$(text$+STRING$(dwidth%," "),dwidth%)
 line$+=text$+" "
 IF from%(loop%)>-1 THEN
  IF from%(loop%) AND FNhi THEN
   head%=from%(loop%)-FNhi
   line$+=FNtext($FNindirection(hpane%,head%),20,TRUE)+" "
  ELSE
   line$+=FNtext($FNindirection(acc_wind%,from%(loop%)+1),20,TRUE)+" "
  ENDIF
 ELSE
  line$+=FNtext(from_text$(loop%),20,TRUE)+" "
 ENDIF
 IF to%(loop%)>-1 THEN
  IF to%(loop%) AND FNhi THEN
   head%=to%(loop%)-FNhi
   line$+=FNtext($FNindirection(hpane%,head%),20,TRUE)+" "
  ELSE
   line$+=FNtext($FNindirection(acc_wind%,to%(loop%)+1),20,TRUE)+" "
  ENDIF
 ELSE
  line$+=FNtext(from_text$(loop%),20,TRUE)+" "
 ENDIF
 line$+=FNtext(FNpoint(trans%(loop%)),9,FALSE)+" "
 line$+=text$(loop%)
 BPUT#file%,line$
NEXT loop%
CLOSE#file%
SYS "Hourglass_Off"
PROCdisplay_menu(-1,0,0)
SYS "OS_File",&12,$FNindirection(exp_wind%,1),file_type_text%
PROCinfo_bar_message("TranExp|"+FNmess_trans("Txt"),1)
ENDPROC
:
DEF PROCsave_csvt
LOCAL l%,loop%,file%,line$,q$
SYS "Hourglass_On"
IF FNicon_selected(exp_wind%,9) THEN q$="""" ELSE q$=""
file%=OPENOUT($FNindirection(exp_wind%,1))
IF FNicon_selected(exp_wind%,8) THEN
 IF FNicon_selected(exp_wind%,7) THEN line$=q$+q$+"," ELSE line$=""
 line$+=q$+FNmess_trans("Date")+q$+","
 line$+=q$+FNmess_trans("From")+q$+","+q$+FNmess_trans("To")+q$+","
 line$+=q$+FNmess_trans("Amount")+q$+","
 line$+=q$+FNmess_trans("Description")+q$
 BPUT#file%,line$
ENDIF
FOR loop%=1 TO size%
 IF FNicon_selected(exp_wind%,7) THEN line$=STR$(loop%)+"," ELSE line$=""
 line$+=q$+FNdecode_given_date(date%(loop%))+q$+","
 IF from%(loop%)>-1 THEN
  IF from%(loop%) AND FNhi THEN
   head%=from%(loop%)-FNhi
   line$+=q$+$FNindirection(hpane%,head%)+q$+","
  ELSE
   line$+=q$+$FNindirection(acc_wind%,from%(loop%)+1)+q$+","
  ENDIF
 ELSE
  line$+=q$+from_text$(loop%)+q$+","
 ENDIF
 IF to%(loop%)>-1 THEN
  IF to%(loop%) AND FNhi THEN
   head%=to%(loop%)-FNhi
   line$+=q$+$FNindirection(hpane%,head%)+q$+","
  ELSE
   line$+=q$+$FNindirection(acc_wind%,to%(loop%)+1)+q$+","
  ENDIF
 ELSE
  line$+=q$+from_text$(loop%)+q$+","
 ENDIF
 line$+=FNpoint(trans%(loop%))+","
 line$+=q$+text$(loop%)+q$
 BPUT#file%,line$
NEXT loop%
CLOSE#file%
SYS "Hourglass_Off"
PROCdisplay_menu(-1,0,0)
SYS "OS_File",&12,$FNindirection(exp_wind%,1),file_type_csv%
PROCinfo_bar_message("TranExp|"+FNmess_trans("CSVN"),1)
ENDPROC
:
DEF PROCsave_tsvt
LOCAL l%,loop%,file%,line$
SYS "Hourglass_On"
file%=OPENOUT($FNindirection(exp_wind%,1))
IF FNicon_selected(exp_wind%,8) THEN
 IF FNicon_selected(exp_wind%,7) THEN line$=CHR$(9) ELSE line$=""
 line$+=FNmess_trans("Date")+CHR$(9)
 line$+=FNmess_trans("From")+CHR$(9)+FNmess_trans("To")+CHR$(9)
 line$+=FNmess_trans("Amount")+CHR$(9)
 line$+=FNmess_trans("Description")
 BPUT#file%,line$
ENDIF
FOR loop%=1 TO size%
 IF FNicon_selected(exp_wind%,7) THEN line$=STR$(loop%)+CHR$(9) ELSE line$=""
 line$+=FNdecode_given_date(date%(loop%))+CHR$(9)
 IF from%(loop%)>-1 THEN
  IF from%(loop%) AND FNhi THEN
   head%=from%(loop%)-FNhi
   line$+=$FNindirection(hpane%,head%)+CHR$(9)
  ELSE
   line$+=$FNindirection(acc_wind%,from%(loop%)+1)+CHR$(9)
  ENDIF
 ELSE
  line$+=from_text$(loop%)+CHR$(9)
 ENDIF
 IF to%(loop%)>-1 THEN
  IF to%(loop%) AND FNhi THEN
   head%=to%(loop%)-FNhi
   line$+=$FNindirection(hpane%,head%)+CHR$(9)
  ELSE
   line$+=$FNindirection(acc_wind%,to%(loop%)+1)+CHR$(9)
  ENDIF
 ELSE
  line$+=from_text$(loop%)+CHR$(9)
 ENDIF
 line$+=FNpoint(trans%(loop%))+CHR$(9)
 line$+=text$(loop%)
 BPUT#file%,line$
NEXT loop%
CLOSE#file%
SYS "Hourglass_Off"
PROCdisplay_menu(-1,0,0)
SYS "OS_File",&12,$FNindirection(exp_wind%,1),file_type_text%
PROCinfo_bar_message("TranExp|"+FNmess_trans("TSVN"),1)
ENDPROC
:
DEF PROCinit_load(file$)
b%!40=file_type_accounts%
$(b%+44)=file$+CHR$0
b%!20=-2
PROCload
ENDPROC
:
DEF PROCquick_load
IF b%!40<>file_type_accounts% ENDPROC
b%!12=b%!8
b%!16=4
SYS "Wimp_SendMessage",17,b%,b%!4
b%!20=-2
IF modified% AND FNpreference(23) THEN
 mess%=11 : PROCmessage("LoadNew?","Cancel","","Load")
ELSE
 PROCload
ENDIF
ENDPROC
:
DEF PROCload
LOCAL loop%,file%,w%
PROCclear_file
$FNindirection(save%,1)=FNstring(b%+44)
$m_title%=$FNindirection(save%,1)
file%=OPENIN(FNstring(b%+44))
INPUT#file%,account_name$
INPUT#file%,size%
account_number%=0
FOR loop%=0 TO accounts%-1
 INPUT#file%,$FNindirection(acc_wind%,loop%+1)
 IF $FNindirection(acc_wind%,loop%+1)<>"" THEN account_number%+=1
 INPUT#file%,initial%(loop%)
 INPUT#file%,a_fdate%(loop%)
 INPUT#file%,a_tdate%(loop%)
NEXT loop%
FOR loop%=1 TO size%
 INPUT#file%,date%(loop%)
 INPUT#file%,to%(loop%)
 INPUT#file%,from%(loop%)
 INPUT#file%,from_text$(loop%)
 INPUT#file%,trans%(loop%)
 INPUT#file%,text$(loop%)
NEXT loop%
INPUT#file%,so_number%
IF so_number%>0 THEN
 FOR loop%=1 TO so_number%
  INPUT#file%,$FNindirection(spane%,loop%-1)
  INPUT#file%,s_to%(loop%)
  INPUT#file%,s_from%(loop%)
  INPUT#file%,s_from_text$(loop%)
  INPUT#file%,s_trans%(loop%)
  INPUT#file%,s_next%(loop%)
  INPUT#file%,s_type%(loop%)
  INPUT#file%,s_int%(loop%)
 NEXT loop%
ENDIF
INPUT#file%,h_number%
IF h_number%>0 THEN
 FOR loop%=1 TO h_number%
  INPUT#file%,$FNindirection(hpane%,loop%-1)
  INPUT#file%,h_type%(loop%)
  INPUT#file%,h_fdate%(loop%),h_tdate%(loop%)
 NEXT loop%
ENDIF
CLOSE#file%
$FNindirection(pane%,5)=account_name$
PROCredraw_icon(pane%,5)
$FNindirection(apane%,5)=account_name$
PROCredraw_icon(apane%,5)
PROCmake_header_menu
PROCrecalc
PROCset_main_extent(size%)
PROCopen_window(main%)
PROCopen_window(pane%)
PROCopen_window(pane2%)
PROCend_caret(pane2%,0)
PROCredraw_main
modified%=FALSE
PROCmain_window_title
FOR loop%=0 TO accounts%-2
 PROCset_menu_end(amenu%,loop%,0)
NEXT loop%
w%=LEN(FNmess_trans("ViewAcc"))
FOR loop%=1 TO accounts%
 IF LEN($FNindirection(acc_wind%,loop%))>w% THEN w%=LEN($FNindirection(acc_wind%,loop%))
NEXT loop%
wide_amenu%=w%
w%=LEN(FNmess_trans("Accounts"))
FOR loop%=1 TO accounts%
 IF LEN($FNindirection(acc_wind%,loop%))>w% THEN w%=LEN($FNindirection(acc_wind%,loop%))
NEXT loop%
narrow_amenu%=w%
!b%=0
b%!4=((account_number%+1)*-32)-56
b%!8=872
b%!12=0
SYS "Wimp_SetExtent",bal_wind%,b%
!b%=0
b%!4=(so_number%)*-44
IF b%!4>-440 THEN b%!4=-440
b%!8=548
b%!12=0
SYS "Wimp_SetExtent",spane%,b%
!b%=0
b%!4=(h_number%)*-44
IF b%!4>-440 THEN b%!4=-440
b%!8=548
b%!12=0
SYS "Wimp_SetExtent",hpane%,b%
!b%=0
b%!4=((h_number%)*-32)-52
b%!8=1312
b%!12=0
SYS "Wimp_SetExtent",hel_wind%,b%
!b%=hel_wind%
SYS "Wimp_GetWindowState",,b%
PROCredraw_window(hel_wind%)
loop%=-1
REPEAT
 loop%+=1
 UNTIL $FNindirection(acc_wind%,loop%+1)="" OR loop%>=(accounts%-1)
IF loop%<accounts%-1 THEN PROCset_menu_end(amenu%,loop%-1,1)
IF FNpreference(9) AND date%>0 THEN PROCadd_standing_orders(TRUE)
PROCget_standing_orders
ENDPROC
:
DEF PROCinitialise_csv_load
csv_file$=FNstring(b%+44)
PROCset_icon_state(loadcsv_wind%,2,1,0,0)
PROCset_icon_state(loadcsv_wind%,3,0,0,0)
PROCset_icon_state(loadcsv_wind%,4,0,1,0)
PROCset_icon_state(loadcsv_wind%,5,0,1,0)
$FNindirection(loadcsv_wind%,4)=""
$FNindirection(loadcsv_wind%,12)=FNmess_trans("From")+":"
$FNindirection(loadcsv_wind%,16)=FNmess_trans("To")+":"
$FNindirection(loadcsv_wind%,20)=FNmess_trans("Amount")+":"
$FNindirection(loadcsv_wind%,9)=FNmess_trans("Field")+" 1"
$FNindirection(loadcsv_wind%,13)=FNmess_trans("Field")+" 2"
$FNindirection(loadcsv_wind%,17)=FNmess_trans("Field")+" 3"
$FNindirection(loadcsv_wind%,21)=FNmess_trans("Field")+" 4"
$FNindirection(loadcsv_wind%,25)=FNmess_trans("Field")+" 5"
PROCopen_window(loadcsv_wind%)
PROCend_caret(loadcsv_wind%,-1)
$i_title%=FNmess_trans("ImpCSV")
import_sep$=","
ENDPROC
:
DEF PROCinitialise_tsv_load
csv_file$=FNstring(b%+44)
PROCset_icon_state(loadcsv_wind%,2,1,0,0)
PROCset_icon_state(loadcsv_wind%,3,0,0,0)
PROCset_icon_state(loadcsv_wind%,4,0,1,0)
PROCset_icon_state(loadcsv_wind%,5,0,1,0)
$FNindirection(loadcsv_wind%,4)=""
$FNindirection(loadcsv_wind%,12)=FNmess_trans("From")+":"
$FNindirection(loadcsv_wind%,16)=FNmess_trans("To")+":"
$FNindirection(loadcsv_wind%,20)=FNmess_trans("Amount")+":"
$FNindirection(loadcsv_wind%,9)=FNmess_trans("Field")+" 1"
$FNindirection(loadcsv_wind%,13)=FNmess_trans("Field")+" 2"
$FNindirection(loadcsv_wind%,17)=FNmess_trans("Field")+" 3"
$FNindirection(loadcsv_wind%,21)=FNmess_trans("Field")+" 4"
$FNindirection(loadcsv_wind%,25)=FNmess_trans("Field")+" 5"
PROCopen_window(loadcsv_wind%)
PROCend_caret(loadcsv_wind%,-1)
$i_title%=FNmess_trans("ImpTSV")
import_sep$=CHR$(9)
ENDPROC
:
DEF PROCload_csv
LOCAL f1%,f2%,f3%,f4%,f5%,acc%,acc_no%
LOCAL ERROR
ON ERROR LOCAL CLOSE#file% : PROCfile_error : RESTORE ERROR : ENDPROC
PROCclose_window(loadcsv_wind%)
f1%=VAL(MID$($FNindirection(loadcsv_wind%,9),INSTR($FNindirection(loadcsv_wind%,9)," ")+1))
f2%=VAL(MID$($FNindirection(loadcsv_wind%,13),INSTR($FNindirection(loadcsv_wind%,13)," ")+1))
f3%=VAL(MID$($FNindirection(loadcsv_wind%,17),INSTR($FNindirection(loadcsv_wind%,17)," ")+1))
f4%=VAL(MID$($FNindirection(loadcsv_wind%,21),INSTR($FNindirection(loadcsv_wind%,21)," ")+1))
f5%=VAL(MID$($FNindirection(loadcsv_wind%,25),INSTR($FNindirection(loadcsv_wind%,25)," ")+1))
acc%=FNicon_selected(loadcsv_wind%,3)
acc_no%=FNaccount_number($FNindirection(loadcsv_wind%,4))
IF (acc_no%=-1) AND acc% THEN mess%=0 : PROCmessage("NoAccount","","OK","") : ENDPROC
SYS "Hourglass_On"
file%=OPENIN(csv_file$)
WHILE size%<max_entries% AND (NOT EOF#file%)
 line$=GET$#file%
 size%+=1
 line$=FNstrip_spaces(line$)
 IF line$<>"" THEN
  PROCstore_text_date(size%,FNfield_contents(line$,f1%))
  IF acc% THEN
   IF FNval(FNfield_contents(line$,f3%))<>0 THEN
    from%(size%)=acc_no%
    to%(size%)=FNaccount_number(FNfield_contents(line$,f2%))
    IF (to%(size%) AND FNhi) AND to%(size%)>-1 THEN
     head%=to%(size%)-FNhi
     IF (h_type%(head%+1) AND 2)=0 THEN to%(size%)=-1
    ENDIF
    IF to%(size%)=-1 THEN from_text$(size%)=FNfield_contents(line$,f2%)
    trans%(size%)=FNval(FNfield_contents(line$,f3%))
   ELSE
    to%(size%)=acc_no%
    from%(size%)=FNaccount_number(FNfield_contents(line$,f2%))
    IF (from%(size%) AND FNhi) AND from%(size%)>-1 THEN
     head%=from%(size%)-FNhi
     IF (h_type%(head%+1) AND 1)=0 THEN from%(size%)=-1
    ENDIF
    IF from%(size%)=-1 THEN from_text$(size%)=FNfield_contents(line$,f2%)
    trans%(size%)=FNval(FNfield_contents(line$,f4%))
   ENDIF
  ELSE
   from%(size%)=FNaccount_number(FNfield_contents(line$,f2%))
   IF (from%(size%) AND FNhi) AND from%(size%)>-1 THEN
    head%=from%(size%)-FNhi
    IF (h_type%(head%+1) AND 1)=0 THEN from%(size%)=-1
   ENDIF
   to%(size%)=FNaccount_number(FNfield_contents(line$,f1%))
   IF (to%(size%) AND FNhi) AND to%(size%)>-1 THEN
    head%=to%(size%)-FNhi
    IF (h_type%(head%+1) AND 2)=0 THEN to%(size%)=-1
   ENDIF
   IF from%(size%)=-1 THEN from_text$(size%)=FNfield_contents(line$,f2%)
   IF to%(size%)=-1 THEN from_text$(size%)=FNfield_contents(line$,f3%)
   trans%(size%)=FNval(FNfield_contents(line$,f4%))
  ENDIF
  text$(size%)=FNfield_contents(line$,f5%)
 ENDIF
ENDWHILE
CLOSE#file%
SYS "Hourglass_Off"
IF size%>=max_entries% THEN  mess%=0 : PROCmessage("TooManyTrans","","OK","")
PROCrecalc
PROCopen_window(main%)
PROCopen_window(pane%)
PROCopen_window(pane2%)
PROCset_main_extent(size%)
PROCredraw_main
PROCgoto_line(main%,size%)
modified%=TRUE
PROCmain_window_title
PROCinfo_bar_message("CSVLoaded",1)
RESTORE ERROR
ENDPROC
:
DEF FNstrip_spaces(s$)
WHILE LEFT$(s$,1)=" "
 s$=MID$(s$,2)
ENDWHILE
WHILE RIGHT$(s$)=" "
 s$=LEFT$(s$)
ENDWHILE
=s$
:
DEF FNfield_contents(s$,f%)
LOCAL l%
IF f%=0 THEN =""
s$=import_sep$+s$+import_sep$
FOR l%=1 TO f%
 s$=MID$(s$,INSTR(s$,import_sep$)+1)
NEXT l%
s$=LEFT$(s$,INSTR(s$,import_sep$)-1)
IF LEFT$(s$,1)=CHR$(34) s$=MID$(s$,2)
IF RIGHT$(s$)=CHR$(34) s$=LEFT$(s$)
=s$
:
DEF FNincrement_field_number(i%,d%)
LOCAL s$
PROCredraw_icon(loadcsv_wind%,i%)
s$=$FNindirection(loadcsv_wind%,i%)
IF s$=FNmess_trans("None") AND d%=1 THEN =FNmess_trans("Field")+" 1"
IF s$=FNmess_trans("None") THEN =FNmess_trans("None")
s$=MID$(s$,INSTR(s$," ")+1)
IF VAL(s$)=99 AND d%=1 THEN =FNmess_trans("Field")+" 99"
IF VAL(s$)=1 AND d%=-1 THEN =FNmess_trans("None")
="Field "+STR$(VAL(s$)+d%)
:
DEF PROCinitialise_account_load
acc_file$=FNstring(b%+44)
$FNindirection(loadacc_wind%,0)=""
PROCset_icon_state(loadacc_wind%,5,0,0,0)
PROCset_icon_state(loadacc_wind%,8,1,0,0)
PROCset_icon_state(loadacc_wind%,9,0,0,0)
PROCset_icon_state(loadacc_wind%,10,0,0,0)
PROCset_icon_state(loadacc_wind%,11,0,1,0)
PROCset_icon_state(loadacc_wind%,12,0,1,0)
PROCset_icon_state(loadacc_wind%,13,0,0,0)
PROCopen_window(loadacc_wind%)
PROCend_caret(loadacc_wind%,-1)
ENDPROC
:
DEF PROCload_account
LOCAL t$,d%,c%,t%,acc_no%,ods$,dat%
LOCAL ERROR
ON ERROR LOCAL CLOSE#file% : PROCfile_error : RESTORE ERROR : ENDPROC
acc_no%=FNaccount_number($FNindirection(loadacc_wind%,0))
IF (acc_no%=-1) THEN mess%=0 : PROCmessage("NoAccount","","OK","") : ENDPROC
PROCclose_window(loadacc_wind%)
dat%=FNicon_selected(loadacc_wind%,5)
SYS "Hourglass_On"
ods$=date_sep$
date_sep$="/"
file%=OPENIN(acc_file$)
INPUT#file%,t$,c%,d%,t%
IF FNicon_selected(loadacc_wind%,9) THEN initial%(acc_no%)+=t%
IF FNicon_selected(loadacc_wind%,10) THEN
 size%+=1
 PROCstore_text_date(size%,$FNindirection(loadacc_wind%,11))
 from%(size%)=-1
 from_text$(size%)=FNmess_trans("Merged")
 to%(size%)=acc_no%
 trans%(size%)=t%
 text$(size%)=FNmess_trans("Initial")
ENDIF
IF FNicon_selected(loadacc_wind%,13) THEN initial%(acc_no%)=t%
WHILE size%<max_entries% AND (NOT EOF#file%)
 INPUT#file%,t$,c%,d%,t%
 size%+=1
 PROCstore_text_date(size%,FNextract_date(t$))
 IF d%<>0 THEN
  from%(size%)=acc_no%
  to%(size%)=FNaccount_number(t$)
  IF (to%(size%) AND FNhi) AND to%(size%)>-1 THEN
   head%=to%(size%)-FNhi
   IF (h_type%(head%+1) AND 2)=0 THEN to%(size%)=-1
  ENDIF
  IF to%(size%)=-1 THEN from_text$(size%)=t$
  trans%(size%)=d%
 ELSE
  to%(size%)=acc_no%
  from%(size%)=FNaccount_number(t$)
  IF (from%(size%) AND FNhi) AND from%(size%)>-1 THEN
   head%=from%(size%)-FNhi
   IF (h_type%(head%+1) AND 1)=0 THEN from%(size%)=-1
  ENDIF
  IF from%(size%)=-1 THEN from_text$(size%)=t$
  trans%(size%)=c%
 ENDIF
text$(size%)=""
ENDWHILE
CLOSE#file%
date_sep$=ods$
SYS "Hourglass_Off"
IF size%>=max_entries% THEN  mess%=0 : PROCmessage("TooManyTrans","","OK","")
PROCrecalc
PROCopen_window(main%)
PROCopen_window(pane%)
PROCopen_window(pane2%)
PROCset_main_extent(size%)
PROCredraw_main
PROCgoto_line(main%,size%)
modified%=TRUE
PROCmain_window_title
PROCinfo_bar_message("AccLoaded",1)
RESTORE ERROR
ENDPROC
:
DEF FNextract_date(RETURN text$)
LOCAL length%,type%,flag%,pos%,found$,da%,mo%,ye%
flag%=TRUE
IF INSTR(text$,"/") THEN
 pos%=-1
 REPEAT
  pos%=INSTR(text$,"/",pos%+1)
 UNTIL pos%=0 OR MID$(text$,pos%+3,1)="/"
 IF pos%>0 THEN
  pos%-=3
  type%=1
  length%=8
  flag%=FALSE
 ENDIF
ENDIF
IF FNmonth_in(text$) AND flag% THEN
 flag%=FALSE
 pos%=FNmonth_in(text$)
 IF VAL(MID$(text$,pos%+4,2))>31 THEN
  pos%-=4
  type%=2
  length%=9
 ELSE
  pos%-=1
  type%=2
  length%=9
 ENDIF
ENDIF
IF flag% THEN =""
IF type%=1 THEN found$=MID$(text$,pos%,length%+1)
IF type%=2 THEN
 ye%=VAL(RIGHT$(found$,2))
 found$=LEFT$(found$,LEN(found$)-3)
 IF INSTR(found$," ")=3 THEN
  mo%=(INSTR("JanFebMarAprMayJunJulAugSepOctNovDec",RIGHT$(found$,3))+2)/3
  da%=VAL(LEFT$(found$,2))
 ELSE
  mo%=(INSTR("JanFebMarAprMayJunJulAugSepOctNovDec",LEFT$(found$,3))+2)/3
  da%=VAL(RIGHT$(found$,2))
 ENDIF
 found$=STR$(da%)+"/"+STR$(mo%)+"/"+STR$(date_from%+ye%)
ENDIF
text2$=""
IF pos%>1 THEN text2$=LEFT$(text$,pos%-1)
IF pos%+length%<LEN(text$) THEN text2$+=MID$(text$,pos%+length%+1)
text$=text2$
text$=FNstrip_spaces(text$)
=found$
:
DEF PROCfile_error
SYS "Hourglass_Smash"
CASE ERR OF
 WHEN 6 : mess%=0 : PROCmessage("BadData","","Cancel","")
 WHEN 223 : mess%=0 : PROCmessage("BadEOF","","Cancel","")
 OTHERWISE : PROCerror
 ENDCASE
ENDPROC
:
DEF FNmonth_in(t$)
LOCAL pos%,loop%,flag%
flag%=0
FOR loop%=1 TO 36 STEP 3
 pos%=INSTR(text$,MID$("JanFebMarAprMayJunJulAugSepOctNovDec",loop%,3)+" ")
 IF pos% THEN flag%=pos%
NEXT loop%
=flag%

:
DEF PROCprint_account
LOCAL l%,loop%,file%,line$,page_length%,page_pos%,top_margin%,base_margin%,head%,first%,last%,page%,width%
SYS "Hourglass_On"
page%=1
first%=1
last%=size%(view_account%)
IF FNicon_selected(print_wind%,34) THEN
 first%=VAL($FNindirection(print_wind%,36))
 last%=VAL($FNindirection(print_wind%,37))
ENDIF
number_margin%=0
IF print_pageno% THEN number_margin%=2
page_length%=print_length%
top_margin%=print_top%
base_margin%=print_base%
left_margin%=print_left%
right_margin%=print_right%
page_pos%=page_length%
REMfile%=OPENOUT("RAM::RamDisc0.$.PrintFile")
file%=OPENOUT("Printer:")
BPUT#file%,start$+elite$;
FOR loop%=first% TO last%
IF page_pos%+base_margin%+number_margin%>=page_length% THEN
 IF top_margin%>0 THEN
  FOR l%=1 TO top_margin%
   BPUT#file%,""+linefeed$
  NEXT l%
 ENDIF
 page_pos%=top_margin%
 IF print_name% THEN
  page_pos%+=1
  line$="     "+FNmess_trans("File")+": "+account_name$
  line$+=STRING$(91-(right_margin%+left_margin%+LEN(line$)+LEN(FNmess_trans("Account")+": "+$FNindirection(acc_wind%,view_account%+1)))," ")
  line$+=FNmess_trans("Account")+": "+$FNindirection(acc_wind%,view_account%+1)
  BPUT#file%,STRING$(left_margin%," ")+line$+linefeed$
 ENDIF
 IF print_date% THEN
  page_pos%+=1
  line$=FNmess_trans("Printed")+": "+FNdecode_given_date(date%)
  line$=STRING$((96-(left_margin%+right_margin%+LEN(line$)))/2," ")+line$
  BPUT#file%,STRING$(left_margin%," ")+line$+linefeed$
 ENDIF
 IF print_name% OR print_date% THEN page_pos%+=1 : BPUT#file%,""+linefeed$
 IF print_headings% THEN
  page_pos%+=1
  IF print_numbers% THEN line$="    " ELSE line$=""
  line$+=FNtext(FNmess_trans("Date"),10,2)+" "+FNtext(FNmess_trans("FromTo"),20,TRUE)+" "
  line$+=FNtext(FNmess_trans("Debit"),9,FALSE)+" "+FNtext(FNmess_trans("Credit"),9,FALSE)+" "
  line$+=FNtext(FNmess_trans("Bal"),9,FALSE)+" "+FNtext(FNmess_trans("Description"),20,TRUE)
  BPUT#file%,STRING$(left_margin%," ")+bold_on$+underline_on$+line$+bold_off$+underline_off$+linefeed$
 ENDIF
ENDIF
 page_pos%+=1
 text$=FNdecode_stored_date(ABS(line_ref%(view_account%,loop%)))
 width%=10-LEN(text$)
 line$=STRING$((width% DIV 2)+(width% MOD 2)," ")+text$+STRING$((width% DIV 2)," ")+" "
 IF SGN(line_ref%(view_account%,loop%))=1 THEN
  IF from%(ABS(line_ref%(view_account%,loop%)))>-1 THEN
   IF from%(ABS(line_ref%(view_account%,loop%))) AND FNhi THEN
    head%=from%(ABS(line_ref%(view_account%,loop%)))-FNhi
    text$=$FNindirection(hpane%,head%)
   ELSE
    text$=$FNindirection(acc_wind%,from%(ABS(line_ref%(view_account%,loop%)))+1)
   ENDIF
  ELSE
   text$=from_text$(ABS(line_ref%(view_account%,loop%)))
  ENDIF
 ELSE
  IF to%(ABS(line_ref%(view_account%,loop%)))>-1 THEN
   IF to%(ABS(line_ref%(view_account%,loop%))) AND FNhi THEN
    head%=to%(ABS(line_ref%(view_account%,loop%)))-FNhi
    text$=$FNindirection(hpane%,head%)
   ELSE
    text$=$FNindirection(acc_wind%,to%(ABS(line_ref%(view_account%,loop%)))+1)
   ENDIF
  ELSE
   text$=from_text$(ABS(line_ref%(view_account%,loop%)))
  ENDIF
 ENDIF
 line$+=FNtext(text$,20,TRUE)+" "
 text$=FNpoint(trans%(ABS(line_ref%(view_account%,loop%))))
 IF SGN(line_ref%(view_account%,loop%))=1 THEN
  line$+=FNtext("",9,FALSE)+" "+FNtext(text$,9,FALSE)+" "
 ELSE
  line$+=FNtext(text$,9,FALSE)+" "+FNtext("",9,FALSE)+" "
 ENDIF
 text$=FNpoint(run_bal%(view_account%,loop%))
 line$+=FNtext(text$,9,FALSE)+" "
 text$=text$(ABS(line_ref%(view_account%,loop%)))
 line$+=text$
 IF pound$<>"" THEN
  line2$=""
  FOR l%=1 TO LEN(line$)
   IF MID$(line$,l%,1)="" THEN line2$+=pound$ ELSE line2$+=MID$(line$,l%,1)
  NEXT l%
  line$=line2$
 ENDIF
 IF print_numbers% THEN line$=italic_on$+FNtext(STR$(loop%),3,FALSE)+" "+italic_off$+line$
 BPUT#file%,STRING$(left_margin%," ")+line$+linefeed$
 IF (page_pos%+base_margin%+number_margin%>=page_length%) OR loop%=last% THEN
  IF loop%=last% AND (page_pos%+base_margin%+number_margin%<page_length%) THEN
   REPEAT
    BPUT#file%,""+linefeed$
    page_pos%+=1
   UNTIL page_pos%+base_margin%+number_margin%>=page_length%
  ENDIF
  IF print_pageno% THEN
   BPUT#file%,""+linefeed$
   line$=FNmess_trans("Page")+": "+STR$(page%)
   page%+=1
   line$=STRING$((96-(left_margin%+right_margin%+LEN(line$)))/2," ")+line$
   BPUT#file%,STRING$(left_margin%," ")+line$+linefeed$
  ENDIF
  IF base_margin%>0 THEN
   FOR l%=1 TO base_margin%
    BPUT#file%,""+linefeed$
   NEXT l%
  ENDIF
  BPUT#file%,formfeed$;
 ENDIF
NEXT loop%
BPUT#file%,pica$+end$;
CLOSE#file%
SYS "Hourglass_Off"
PROCdisplay_menu(-1,0,0)
PROCclose_window(print_wind%)
ENDPROC
:
DEF PROCcalculate_print_values
LOCAL length%,top%,base%,left%,lines%,right%
length%=VAL($FNindirection(print_wind%,5))
left%=VAL($FNindirection(print_wind%,17))
top%=VAL($FNindirection(print_wind%,9))
base%=VAL($FNindirection(print_wind%,13))
lines%=length%-(top%+base%)
right%=13-left%+(4*FNicon_selected(print_wind%,25))
IF right%<0 THEN
 left%-=ABS(right%) : right%=0
 $FNindirection(print_wind%,17)=STR$(left%)
 PROCredraw_icon(print_wind%,17)
ENDIF
$FNindirection(print_wind%,21)=STR$(lines%)
$FNindirection(print_wind%,41)=STR$(right%)
PROCredraw_icon(print_wind%,21)
PROCredraw_icon(print_wind%,41)
pmax_top%=length%-base%
pmax_base%=length%-top%
pmax_left%=13+(4*FNicon_selected(print_wind%,25))
pmax_size%=99
ENDPROC
:
DEF PROCset_print_window
$FNindirection(print_wind%,1)=$FNindirection(acc_wind%,view_account%+1)
$FNindirection(print_wind%,36)="1"
$FNindirection(print_wind%,37)=STR$(size%(view_account%))
PROCset_icon_state(print_wind%,33,1,0,0)
PROCset_icon_state(print_wind%,34,0,0,0)
PROCset_icon_state(print_wind%,36,0,1,0)
PROCset_icon_state(print_wind%,37,0,1,0)
PROCset_icon_state(print_wind%,24,print_headings%,0,0)
PROCset_icon_state(print_wind%,25,print_numbers%,0,0)
PROCset_icon_state(print_wind%,26,print_date%,0,0)
PROCset_icon_state(print_wind%,27,print_name%,0,0)
PROCset_icon_state(print_wind%,42,print_pageno%,0,0)
$FNindirection(print_wind%,5)=STR$(print_length%)
$FNindirection(print_wind%,9)=STR$(print_top%)
$FNindirection(print_wind%,13)=STR$(print_base%)
$FNindirection(print_wind%,17)=STR$(print_left%)
PROCcalculate_print_values
ENDPROC
:
DEF PROCset_print_values(s%)
print_length%=VAL($FNindirection(print_wind%,5))
print_top%=VAL($FNindirection(print_wind%,9))
print_base%=VAL($FNindirection(print_wind%,13))
print_left%=VAL($FNindirection(print_wind%,17))
print_right%=VAL($FNindirection(print_wind%,41))
print_headings%=FNicon_selected(print_wind%,24)
print_numbers%=FNicon_selected(print_wind%,25)
print_date%=FNicon_selected(print_wind%,26)
print_name%=FNicon_selected(print_wind%,27)
print_pageno%=FNicon_selected(print_wind%,42)
IF s% THEN
file%=OPENOUT("<Accounts+$Dir>.PrintAOpts")
PRINT#file%,print_length%,print_top%,print_base%,print_left%,print_headings%,print_numbers%,print_date%,print_name%,print_pageno%
CLOSE#file%
ENDIF
ENDPROC
:
DEF PROCload_print_values
file%=OPENIN("<Accounts+$Dir>.PrintAOpts")
INPUT#file%,print_length%,print_top%,print_base%,print_left%,print_headings%,print_numbers%,print_date%,print_name%,print_pageno%
CLOSE#file%
print_right%=13-print_left%+(4*print_numbers%)
PROCcalculate_print_values
ENDPROC
:
DEF PROCprint_headers
LOCAL l%,loop%,file%,line$,page_length%,page_pos%,top_margin%,base_margin%,head%,first%,last%,page%,width%
SYS "Hourglass_On"
page_length%=printh_length%
top_margin%=printh_top%
left_margin%=printh_left%
right_margin%=printh_right%
REMfile%=OPENOUT("RAM::RamDisc0.$.PrintFile")
file%=OPENOUT("Printer:")
BPUT#file%,pica$+start$;
IF top_margin%>0 THEN
 FOR loop%=1 TO top_margin%
  BPUT#file%,""+linefeed$
 NEXT loop%
ENDIF
IF printh_name% THEN
 line$=FNmess_trans("File")+": "+account_name$
 line$=STRING$((80-(left_margin%+right_margin%+LEN(line$)))/2," ")+line$
 BPUT#file%,STRING$(left_margin%," ")+line$+linefeed$
ENDIF
IF printh_date% THEN
 line$=FNmess_trans("Printed")+": "+FNdecode_given_date(date%)
 line$=STRING$((80-(left_margin%+right_margin%+LEN(line$)))/2," ")+line$
 BPUT#file%,STRING$(left_margin%," ")+line$+linefeed$
ENDIF
IF printh_name% OR printh_date% THEN BPUT#file%,""+linefeed$
IF printh_headings% THEN
 line$=FNtext("Header",20,TRUE)+" "+FNmess_trans("Type")+" "
 line$+=FNtext(FNmess_trans("DateF"),10,2)+" "+FNtext(FNmess_trans("DateT"),10,2)+" "
 line$+=FNtext(FNmess_trans("In"),9,FALSE)+" "+FNtext(FNmess_trans("Out"),9,FALSE)+" "
 line$+=FNtext(FNmess_trans("Bal"),9,FALSE)
 BPUT#file%,STRING$(left_margin%," ")+bold_on$+underline_on$+line$+bold_off$+underline_off$+linefeed$
ENDIF
FOR loop%=0 TO h_number%-1
 line$=FNtext($FNindirection(hpane%,loop%),20,TRUE)+" "
 IF (h_type%(loop%+1) AND 1)=1 THEN text$="In "
 IF (h_type%(loop%+1) AND 2)=2 THEN text$=FNmess_trans("Out")
 IF (h_type%(loop%+1) AND 3)=3 THEN text$=FNmess_trans("IO")
 line$+=text$+" "
 text$=FNdecode_given_date(h_fdate%(loop%+1))
 width%=10-LEN(text$)
 line$+=STRING$((width% DIV 2)+(width% MOD 2)," ")+text$+STRING$((width% DIV 2)," ")+" "
 text$=FNdecode_given_date(h_tdate%(loop%+1))
 width%=10-LEN(text$)
 line$+=STRING$((width% DIV 2)+(width% MOD 2)," ")+text$+STRING$((width% DIV 2)," ")+" "
 IF (h_type%(loop%+1) AND 1)=1 THEN
  line$+=FNtext(FNpoint(h_vals%(loop%+1,0)),9,FALSE)+" "
 ELSE
  line$+="          "
 ENDIF
 IF (h_type%(loop%+1) AND 2)=2 THEN
  line$+=FNtext(FNpoint(h_vals%(loop%+1,1)),9,FALSE)+" "
 ELSE
  line$+="          "
 ENDIF
 line$+=FNtext(FNpoint(h_vals%(loop%+1,0)-h_vals%(loop%+1,1)),9,FALSE)
 IF pound$<>"" THEN
  line2$=""
  FOR l%=1 TO LEN(line$)
   IF MID$(line$,l%,1)="" THEN line2$+=pound$ ELSE line2$+=MID$(line$,l%,1)
  NEXT l%
  line$=line2$
 ENDIF
 BPUT#file%,STRING$(left_margin%," ")+line$+linefeed$
NEXT loop%
BPUT#file%,formfeed$+end$;
CLOSE#file%
SYS "Hourglass_Off"
PROCdisplay_menu(-1,0,0)
PROCclose_window(printh_wind%)
ENDPROC
:
DEF PROCcalculate_printh_values
LOCAL length%,top%,base%,left%,lines%,right%
length%=VAL($FNindirection(printh_wind%,5))
left%=VAL($FNindirection(printh_wind%,15))
top%=VAL($FNindirection(printh_wind%,9))
lines%=34
right%=4-left%
base%=length%-top%-lines%
IF base%<0 THEN
 top%-=ABS(base%) : base%=0
 $FNindirection(printh_wind%,9)=STR$(top%)
 PROCredraw_icon(printh_wind%,9)
ENDIF
$FNindirection(printh_wind%,29)=STR$(right%)
PROCredraw_icon(printh_wind%,29)
$FNindirection(printh_wind%,13)=STR$(base%)
PROCredraw_icon(printh_wind%,13)
phmax_top%=length%-34
phmax_left%=4
pmax_size%=99
ENDPROC
:
DEF PROCset_printh_window
PROCset_icon_state(printh_wind%,21,printh_headings%,0,0)
PROCset_icon_state(printh_wind%,22,printh_date%,0,0)
PROCset_icon_state(printh_wind%,1,printh_name%,0,0)
$FNindirection(printh_wind%,5)=STR$(printh_length%)
$FNindirection(printh_wind%,9)=STR$(printh_top%)
$FNindirection(printh_wind%,15)=STR$(printh_left%)
$FNindirection(printh_wind%,29)=STR$(printh_right%)
PROCcalculate_printh_values
ENDPROC
:
DEF PROCset_printh_values(s%)
printh_length%=VAL($FNindirection(printh_wind%,5))
printh_top%=VAL($FNindirection(printh_wind%,9))
printh_left%=VAL($FNindirection(printh_wind%,15))
printh_right%=VAL($FNindirection(printh_wind%,29))
printh_headings%=FNicon_selected(printh_wind%,21)
printh_date%=FNicon_selected(printh_wind%,22)
printh_name%=FNicon_selected(printh_wind%,1)
IF s% THEN
file%=OPENOUT("<Accounts+$Dir>.PrintHOpts")
PRINT#file%,printh_length%,printh_top%,printh_left%,printh_headings%,printh_date%,printh_name%
CLOSE#file%
ENDIF
ENDPROC
:
DEF PROCload_printh_values
file%=OPENIN("<Accounts+$Dir>.PrintHOpts")
INPUT#file%,printh_length%,printh_top%,printh_left%,printh_headings%,printh_date%,printh_name%
CLOSE#file%
printh_right%=14-printh_left%
PROCcalculate_printh_values
ENDPROC
:
DEF PROCprint_transactions
LOCAL l%,loop%,file%,line$,page_length%,page_pos%,top_margin%,base_margin%,head%,first%,last%,page%,width%
SYS "Hourglass_On"
page%=1
first%=1
last%=size%
IF FNicon_selected(printt_wind%,32) THEN
 first%=VAL($FNindirection(printt_wind%,34))
 last%=VAL($FNindirection(printt_wind%,35))
ENDIF
number_margin%=0
IF printt_pageno% THEN number_margin%=2
page_length%=printt_length%
top_margin%=printt_top%
base_margin%=printt_base%
left_margin%=printt_left%
right_margin%=printt_right%
page_pos%=page_length%
REMfile%=OPENOUT("RAM::RamDisc0.$.PrintFile")
file%=OPENOUT("Printer:")
BPUT#file%,start$+elite$;
FOR loop%=first% TO last%
IF page_pos%+base_margin%+number_margin%>=page_length% THEN
 IF top_margin%>0 THEN
  FOR l%=1 TO top_margin%
   BPUT#file%,""+linefeed$
  NEXT l%
 ENDIF
 page_pos%=top_margin%
 IF printt_name% THEN
  page_pos%+=1
  line$=FNmess_trans("File")+": "+account_name$
  line$=STRING$((96-(left_margin%+right_margin%+LEN(line$)))/2," ")+line$
  BPUT#file%,STRING$(left_margin%," ")+line$+linefeed$
 ENDIF
 IF printt_date% THEN
  page_pos%+=1
  line$=FNmess_trans("Printed")+": "+FNdecode_given_date(date%)
  line$=STRING$((96-(left_margin%+right_margin%+LEN(line$)))/2," ")+line$
  BPUT#file%,STRING$(left_margin%," ")+line$+linefeed$
 ENDIF
 IF printt_name% OR printt_date% THEN page_pos%+=1 : BPUT#file%,""+linefeed$
 IF printt_headings% THEN
  page_pos%+=1
  IF printt_numbers% THEN line$="     " ELSE line$=""
  line$+=FNtext(FNmess_trans("Date"),10,2)+" "+FNtext(FNmess_trans("From"),20,TRUE)+" "+FNtext(FNmess_trans("To"),20,TRUE)+" "
  line$+=FNtext(FNmess_trans("Amount"),9,FALSE)+" "+FNtext(FNmess_trans("Description"),20,TRUE)
  BPUT#file%,STRING$(left_margin%," ")+bold_on$+underline_on$+line$+bold_off$+underline_off$+linefeed$
 ENDIF
ENDIF
 page_pos%+=1
 text$=FNdecode_stored_date(loop%)
 width%=10-LEN(text$)
 line$=STRING$((width% DIV 2)+(width% MOD 2)," ")+text$+STRING$((width% DIV 2)," ")+" "
 IF from%(loop%)>-1 THEN
  IF from%(loop%) AND FNhi THEN
   head%=from%(loop%)-FNhi
   line$+=FNtext($FNindirection(hpane%,head%),20,TRUE)+" "
  ELSE
   line$+=FNtext($FNindirection(acc_wind%,from%(loop%)+1),20,TRUE)+" "
  ENDIF
 ELSE
  line$+=FNtext(from_text$(loop%),20,TRUE)+" "
 ENDIF
 IF to%(loop%)>-1 THEN
  IF to%(loop%) AND FNhi THEN
   head%=to%(loop%)-FNhi
   line$+=FNtext($FNindirection(hpane%,head%),20,TRUE)+" "
  ELSE
   line$+=FNtext($FNindirection(acc_wind%,to%(loop%)+1),20,TRUE)+" "
  ENDIF
 ELSE
  line$+=FNtext(from_text$(loop%),20,TRUE)+" "
 ENDIF
 line$+=FNtext(FNpoint(trans%(loop%)),9,FALSE)+" "
 line$+=text$(loop%)
 IF pound$<>"" THEN
  line2$=""
  FOR l%=1 TO LEN(line$)
   IF MID$(line$,l%,1)="" THEN line2$+=pound$ ELSE line2$+=MID$(line$,l%,1)
  NEXT l%
  line$=line2$
 ENDIF
 IF printt_numbers% THEN line$=italic_on$+FNtext(STR$(loop%),4,FALSE)+" "+italic_off$+line$
 BPUT#file%,STRING$(left_margin%," ")+line$+linefeed$
 IF (page_pos%+base_margin%+number_margin%>=page_length%) OR loop%=last% THEN
  IF loop%=last% AND (page_pos%+base_margin%+number_margin%<page_length%) THEN
   REPEAT
    BPUT#file%,""+linefeed$
    page_pos%+=1
   UNTIL page_pos%+base_margin%+number_margin%>=page_length%
  ENDIF
  IF printt_pageno% THEN
   BPUT#file%,""+linefeed$
   line$=FNmess_trans("Page")+": "+STR$(page%)
   page%+=1
   line$=STRING$((96-(left_margin%+right_margin%+LEN(line$)))/2," ")+line$
   BPUT#file%,STRING$(left_margin%," ")+line$+linefeed$
  ENDIF
  IF base_margin%>0 THEN
   FOR l%=1 TO base_margin%
    BPUT#file%,""+linefeed$
   NEXT l%
  ENDIF
  BPUT#file%,formfeed$;
 ENDIF
NEXT loop%
BPUT#file%,pica$+end$;
CLOSE#file%
SYS "Hourglass_Off"
PROCdisplay_menu(-1,0,0)
PROCclose_window(printt_wind%)
ENDPROC
:
DEF PROCcalculate_printt_values
LOCAL length%,top%,base%,left%,lines%,right%
length%=VAL($FNindirection(printt_wind%,3))
left%=VAL($FNindirection(printt_wind%,15))
top%=VAL($FNindirection(printt_wind%,7))
base%=VAL($FNindirection(printt_wind%,11))
lines%=length%-(top%+base%)
right%=12-left%+(5*FNicon_selected(printt_wind%,23))
IF right%<0 THEN
 left%-=ABS(right%) : right%=0
 $FNindirection(printt_wind%,15)=STR$(left%)
 PROCredraw_icon(printt_wind%,15)
ENDIF
$FNindirection(printt_wind%,19)=STR$(lines%)
$FNindirection(printt_wind%,39)=STR$(right%)
PROCredraw_icon(printt_wind%,19)
PROCredraw_icon(printt_wind%,39)
ptmax_top%=length%-base%
ptmax_base%=length%-top%
ptmax_left%=13+(4*FNicon_selected(printt_wind%,23))
ptmax_size%=99
ENDPROC
:
DEF PROCset_printt_window
$FNindirection(printt_wind%,34)="1"
$FNindirection(printt_wind%,35)=STR$(size%)
PROCset_icon_state(printt_wind%,31,1,0,0)
PROCset_icon_state(printt_wind%,32,0,0,0)
PROCset_icon_state(printt_wind%,34,0,1,0)
PROCset_icon_state(printt_wind%,35,0,1,0)
PROCset_icon_state(printt_wind%,22,printt_headings%,0,0)
PROCset_icon_state(printt_wind%,23,printt_numbers%,0,0)
PROCset_icon_state(printt_wind%,24,printt_date%,0,0)
PROCset_icon_state(printt_wind%,25,printt_name%,0,0)
PROCset_icon_state(printt_wind%,40,printt_pageno%,0,0)
$FNindirection(printt_wind%,3)=STR$(printt_length%)
$FNindirection(printt_wind%,7)=STR$(printt_top%)
$FNindirection(printt_wind%,11)=STR$(printt_base%)
$FNindirection(printt_wind%,15)=STR$(printt_left%)
PROCcalculate_printt_values
ENDPROC
:
DEF PROCset_printt_values(s%)
printt_length%=VAL($FNindirection(printt_wind%,3))
printt_top%=VAL($FNindirection(printt_wind%,7))
printt_base%=VAL($FNindirection(printt_wind%,11))
printt_left%=VAL($FNindirection(printt_wind%,15))
printt_right%=VAL($FNindirection(printt_wind%,39))
printt_headings%=FNicon_selected(printt_wind%,22)
printt_numbers%=FNicon_selected(printt_wind%,23)
printt_date%=FNicon_selected(printt_wind%,24)
printt_name%=FNicon_selected(printt_wind%,25)
printt_pageno%=FNicon_selected(printt_wind%,40)
IF s% THEN
file%=OPENOUT("<Accounts+$Dir>.PrintTOpts")
PRINT#file%,printt_length%,printt_top%,printt_base%,printt_left%,printt_headings%,printt_numbers%,printt_date%,printt_name%,printt_pageno%
CLOSE#file%
ENDIF
ENDPROC
:
DEF PROCload_printt_values
file%=OPENIN("<Accounts+$Dir>.PrintTOpts")
INPUT#file%,printt_length%,printt_top%,printt_base%,printt_left%,printt_headings%,printt_numbers%,printt_date%,printt_name%,printt_pageno%
CLOSE#file%
printt_right%=13-print_left%+(4*printt_numbers%)
PROCcalculate_print_values
ENDPROC
:
DEF PROCset_code_window
$FNindirection(printcon_wind%,1)=FNtrans_codes(start$)
$FNindirection(printcon_wind%,2)=FNtrans_codes(end$)
$FNindirection(printcon_wind%,3)=FNtrans_codes(pica$)
$FNindirection(printcon_wind%,4)=FNtrans_codes(elite$)
$FNindirection(printcon_wind%,5)=FNtrans_codes(bold_on$)
$FNindirection(printcon_wind%,6)=FNtrans_codes(bold_off$)
$FNindirection(printcon_wind%,7)=FNtrans_codes(italic_on$)
$FNindirection(printcon_wind%,8)=FNtrans_codes(italic_off$)
$FNindirection(printcon_wind%,9)=FNtrans_codes(underline_on$)
$FNindirection(printcon_wind%,10)=FNtrans_codes(underline_off$)
$FNindirection(printcon_wind%,11)=FNtrans_codes(linefeed$)
$FNindirection(printcon_wind%,12)=FNtrans_codes(formfeed$)
$FNindirection(printcon_wind%,13)=FNtrans_codes(pound$)
ENDPROC
:
DEF PROCset_printcodes(s%)
start$=FNtrans_string($FNindirection(printcon_wind%,1))
end$=FNtrans_string($FNindirection(printcon_wind%,2))
pica$=FNtrans_string($FNindirection(printcon_wind%,3))
elite$=FNtrans_string($FNindirection(printcon_wind%,4))
bold_on$=FNtrans_string($FNindirection(printcon_wind%,5))
bold_off$=FNtrans_string($FNindirection(printcon_wind%,6))
italic_on$=FNtrans_string($FNindirection(printcon_wind%,7))
italic_off$=FNtrans_string($FNindirection(printcon_wind%,8))
underline_on$=FNtrans_string($FNindirection(printcon_wind%,9))
underline_off$=FNtrans_string($FNindirection(printcon_wind%,10))
linefeed$=FNtrans_string($FNindirection(printcon_wind%,11))
formfeed$=FNtrans_string($FNindirection(printcon_wind%,12))
pound$=FNtrans_string($FNindirection(printcon_wind%,13))
IF s% THEN
file%=OPENOUT("<Accounts+$Dir>.PrintCodes")
PRINT#file%,pica$,elite$,bold_on$,bold_off$,italic_on$,italic_off$,underline_on$,underline_off$,linefeed$,formfeed$,start$,end$,pound$
CLOSE#file%
ENDIF
ENDPROC
:
DEF PROCload_printcodes
file%=OPENIN("<Accounts+$Dir>.PrintCodes")
INPUT#file%,pica$,elite$,bold_on$,bold_off$,italic_on$,italic_off$,underline_on$,underline_off$,linefeed$,formfeed$,start$,end$,pound$
CLOSE#file%
ENDPROC
:
DEF FNtrans_string(s$)
LOCAL o$,pos%,i$
WHILE LEN(s$)>0
 IF INSTR(s$,",") THEN
  pos%=INSTR(s$,",")
  i$=LEFT$(s$,pos%-1)
  IF LEFT$(i$,1)="""" AND RIGHT$(i$,1)="""" THEN
   i$=MID$(i$,2,LEN(i$)-2)
   o$+=i$
  ELSE
   o$+=CHR$(VAL(i$))
  ENDIF
  s$=MID$(s$,pos%+1)
 ELSE
  IF LEFT$(s$,1)="""" AND RIGHT$(s$,1)="""" THEN
   i$=MID$(s$,2,LEN(s$)-2)
   o$+=i$
  ELSE
   o$+=CHR$(VAL(s$))
  ENDIF
  s$=""
 ENDIF
ENDWHILE
=o$
:
DEF FNtrans_codes(s$)
LOCAL o$,a%
WHILE LEN(s$)>0
 a%=ASC(LEFT$(s$,1))
 IF a%<32 OR a%>126 THEN
  o$+=STR$(a%)+","
 ELSE
  o$+=""""+CHR$(a%)+""","
 ENDIF
 s$=MID$(s$,2)
ENDWHILE
=LEFT$(o$,LEN(o$)-1)
:
DEF PROCclear_file
LOCAL loop%,w%
FOR loop%=1 TO accounts%
 $FNindirection(acc_wind%,loop%)=""
NEXT loop%
$FNindirection(acc_wind%,1)="Untitled"
FOR loop%=0 TO accounts%-2
 PROCset_menu_end(amenu%,loop%,0)
NEXT loop%
w%=0
FOR loop%=1 TO accounts%
 IF LEN($FNindirection(acc_wind%,loop%))>w% THEN w%=LEN($FNindirection(acc_wind%,loop%))
NEXT loop%
PROCset_menu_width(amenu%,w%)
PROCset_menu_end(amenu%,0,1)
FOR loop%=0 TO s_orders%-1
 $FNindirection(spane%,loop%)=""
NEXT loop%
FOR loop%=0 TO headers%-1
 $FNindirection(hpane%,loop%)=""
NEXT loop%
account_name$="Untitled"
$FNindirection(pane%,5)=account_name$
PROCredraw_icon(pane%,5)
$FNindirection(apane%,5)=account_name$
PROCredraw_icon(apane%,5)
size%=0
PROCset_main_extent(size%)
initial%()=0
date%()=0
to%()=0
from%()=0
from_text$()=""
trans%()=0
text$()=""
account_number%=1
so_number%=0
h_number%=0
s_to%()=0
s_from%()=0
s_from_text$()=""
s_trans%()=0
s_next%()=0
s_type%()=0
s_int%()=0
s_list_offset%=0
h_type%()=0
h_fdate%()=0
h_tdate%()=0
a_fdate%()=0
a_tdate%()=0
modified%=FALSE
$FNindirection(save%,1)=FNmess_trans("Accounts")
PROCmain_window_title
PROCinfo_bar_message("Clear",3)
ENDPROC
:
DEF FNfile_size
LOCAL loop%,f_size%
f_size%=FNlen_string(account_name$)
f_size%+=FNlen_integer
FOR loop%=0 TO accounts%-1
 f_size%+=FNlen_string($FNindirection(acc_wind%,loop%+1))
 f_size%+=FNlen_integer
 f_size%+=FNlen_integer
 f_size%+=FNlen_integer
NEXT loop%
FOR loop%=1 TO size%
 f_size%+=FNlen_integer
 f_size%+=FNlen_integer
 f_size%+=FNlen_integer
 f_size%+=FNlen_string(from_text$(loop%))
 f_size%+=FNlen_integer
 f_size%+=FNlen_string(text$(loop%))
NEXT loop%
f_size%+=FNlen_integer
IF so_number%>0 THEN
 FOR loop%=1 TO so_number%
  f_size%+=FNlen_string($FNindirection(spane%,loop%-1))
  f_size%+=FNlen_integer
  f_size%+=FNlen_integer
  f_size%+=FNlen_string(s_from_text$(loop%))
  f_size%+=FNlen_integer
  f_size%+=FNlen_integer
  f_size%+=FNlen_integer
  f_size%+=FNlen_integer
 NEXT loop%
ENDIF
f_size%+=FNlen_integer
IF h_number%>0 THEN
 FOR loop%=1 TO h_number%
  f_size%+=FNlen_string($FNindirection(hpane%,loop%-1))
  f_size%+=FNlen_integer
  f_size%+=FNlen_integer
  f_size%+=FNlen_integer
 NEXT loop%
ENDIF
=f_size%
:
DEF FNlen_integer=5
:
DEF FNlen_string(s$)=2+LEN(s$)
:
DEF PROCfile_info
file_s%=FNfile_size
IF file_s%>(4*1024) THEN
 $FNindirection(finfo_wind%,7)=STR$(INT((FNfile_size+512)/1024))+" Kbytes"
ELSE
 $FNindirection(finfo_wind%,7)=STR$(FNfile_size)+" bytes"
ENDIF
file_n$=$FNindirection(save%,1)
IF INSTR(file_n$,".")>0 THEN
 $FNindirection(finfo_wind%,0)=file_n$
ELSE
 $FNindirection(finfo_wind%,0)="<Untitled>"
ENDIF
$FNindirection(finfo_wind%,3)=STR$(size%)
$FNindirection(finfo_wind%,5)=STR$(account_number%)
$FNindirection(finfo_wind%,11)=STR$(h_number%)
$FNindirection(finfo_wind%,13)=STR$(so_number%)
IF modified% THEN
 $FNindirection(finfo_wind%,9)="Yes"
ELSE
 $FNindirection(finfo_wind%,9)="No"
ENDIF
$f_title%=FNmess_trans("FileInfo")+" ("+account_name$+")"
ENDPROC
:
DEF FNstring(ptr%)
LOCAL a$
WHILE ?ptr%<>0
a$+=CHR$(?ptr%):ptr%+=1
ENDWHILE
=a$
:
DEF FNleaf_name(f$)
WHILE INSTR(f$,".")
 f$=MID$(f$,INSTR(f$,".")+1)
 ENDWHILE
=f$
:
:
DEF PROCmain_window_title
LOCAL t$
IF INSTR($FNindirection(save%,1),".")=0 THEN t$="<Untitled>" ELSE t$=$FNindirection(save%,1)
IF modified% THEN
 $m_title%=t$+" *"
ELSE
 $m_title%=t$
ENDIF
PROCredraw_title(main%)
ENDPROC
:
DEF PROCopen_at(whan%,x%,y%)
LOCAL w%,h%
!q%=whan%
SYS "Wimp_GetWindowState",,q%
w%=q%!12-q%!4
h%=q%!16-q%!8
q%!4=x%
q%!8=y%-h%
q%!12=x%+w%
q%!16=y%
SYS "Wimp_OpenWindow",,q%
ENDPROC
:
DEF PROCopen_as_menu(wind%,x%,y%)
!q%=wind%
SYS"Wimp_GetWindowState",,q%
REMSYS"Wimp_CreateMenu",,wind%,(width%-(q%!12-q%!4))/2,(1024+(q%!16-q%!8))/2
SYS"Wimp_CreateMenu",,wind%,x%,y%
ENDPROC
:
DEF PROCopen_window(whan%)
!b%=whan%
SYS "Wimp_GetWindowState",,b%
b%!28=-1
SYS "Wimp_OpenWindow",,b%
ENDPROC
:
DEF PROCclose_window(whan%)
!q%=whan%
SYS "Wimp_GetWindowState",,q%
SYS "Wimp_CloseWindow",,q%
ENDPROC
:
DEF PROCopen_pane
!q%=pane2%
SYS "Wimp_GetWindowState",,q%
q%!4=b%!4
q%!8=b%!8-152
q%!12=b%!12+38
q%!16=b%!8-40
q%!20=b%!20
q%!28=b%!28
SYS "Wimp_OpenWindow",,q%
!q%=pane%
SYS "Wimp_GetWindowState",,q%
q%!4=b%!4
q%!8=b%!16-148
q%!12=b%!12
q%!16=b%!16
q%!20=b%!20
q%!28=pane2%
b%!28=pane%
SYS "Wimp_OpenWindow",,q%
SYS "Wimp_OpenWindow",,b%
ENDPROC
:
DEF PROCopen_head_pane
!q%=hpane%
SYS "Wimp_GetWindowState",,q%
q%!4=b%!4+22
q%!8=b%!16-460
q%!12=b%!4+582
q%!16=b%!16-20
q%!20=b%!20
q%!28=b%!28
b%!28=hpane%
SYS "Wimp_OpenWindow",,q%
SYS "Wimp_OpenWindow",,b%
ENDPROC
:
DEF PROCopen_apane
!q%=apane%
SYS "Wimp_GetWindowState",,q%
q%!4=b%!4
q%!8=b%!16-148
q%!12=b%!12
q%!16=b%!16
q%!20=b%!20
q%!28=b%!28
b%!28=apane%
SYS "Wimp_OpenWindow",,q%
SYS "Wimp_OpenWindow",,b%
ENDPROC
:
DEF PROCopen_bpane
!q%=bpane%
SYS "Wimp_GetWindowState",,q%
q%!4=b%!4
q%!8=b%!16-52
q%!12=b%!12
q%!16=b%!16
q%!20=b%!20
q%!28=b%!28
b%!28=bpane%
SYS "Wimp_OpenWindow",,q%
SYS "Wimp_OpenWindow",,b%
ENDPROC
:
DEF PROCopen_wpane
!q%=wpane%
SYS "Wimp_GetWindowState",,q%
q%!4=b%!4
q%!8=b%!16-52
q%!12=b%!12
q%!16=b%!16
q%!20=b%!20
q%!28=b%!28
b%!28=wpane%
SYS "Wimp_OpenWindow",,q%
SYS "Wimp_OpenWindow",,b%
ENDPROC
:
DEF PROCopen_hel_pane
!q%=lpane%
SYS "Wimp_GetWindowState",,q%
q%!4=b%!4
q%!8=b%!16-52
q%!12=b%!12
q%!16=b%!16
q%!20=b%!20
q%!28=b%!28
b%!28=lpane%
SYS "Wimp_OpenWindow",,q%
SYS "Wimp_OpenWindow",,b%
ENDPROC
:
DEF PROCopen_ppane
!q%=ppane%
SYS "Wimp_GetWindowState",,q%
q%!4=b%!4+26
q%!8=b%!16-430
q%!12=b%!12+762
q%!16=b%!16-26
q%!28=b%!28
b%!28=ppane%
SYS "Wimp_OpenWindow",,q%
SYS "Wimp_OpenWindow",,b%
ENDPROC
:
DEF PROCopen_spane
!q%=spane%
SYS "Wimp_GetWindowState",,q%
q%!4=b%!4+22
q%!8=b%!16-460
q%!12=b%!12+622
q%!16=b%!16-20
q%!28=b%!28
b%!28=spane%
SYS "Wimp_OpenWindow",,q%
SYS "Wimp_OpenWindow",,b%
ENDPROC
:
DEF PROCscroll_top(!b%)
SYS "Wimp_GetWindowState",,b%
b%!24=0
SYS "Wimp_OpenWindow",,b%
SYS "Wimp_CloseWindow",,b%
ENDPROC
:
DEF PROCwindow_background(RETURN w%,c%)
LOCAL old%
!q%=w%
SYS "Wimp_GetWindowInfo",,q%
q%?39=c%
old%=w%
SYS "Wimp_CreateWindow",,q%+4 TO w%
SYS "Wimp_DeleteWindow",,q%
IF (q%!32 AND (1<<16)) THEN
 !q%=w%
 SYS "Wimp_OpenWindow",,q%
ENDIF
ENDPROC
:
DEF PROCopen_templates(file$)
SYS "Wimp_OpenTemplate",,file$
DIM template_name% 12
ENDPROC
:
DEF FNload_template(name$,buff%,ind%,len%)
$template_name%="            "
$template_name%=name$
SYS "Wimp_LoadTemplate",,buff%,ind%,ind%+len%,-1,template_name%,0 TO ,,new%
=new%
:
DEF PROCclose_templates
SYS "Wimp_CloseTemplate"
ENDPROC
:
:
DEF PROCsend_help(help$)
b%!12=b%!8
b%!16=&503
$(b%+20)=help$+STRING$(4,CHR$(0))
!b%=24+(LEN(help$) AND &FFFFFC)
SYS "Wimp_SendMessage",17,b%,b%!4
ENDPROC
:
DEF PROCrun_help
*Filer_Run <Accounts+$Dir>.!Help
ENDPROC
:
:
DEF PROCset_icon_state(whan%,ihan%,sel%,shad%,del%)
LOCAL eor%,clear%
eor%=0 :clear%=0
IF sel% THEN
clear%+=(1<<21)
eor%  +=(1<<21)
ELSE
clear%+=(1<<21)
eor%  +=(0<<21)
ENDIF
IF shad% THEN
clear%+=(1<<22)
eor%  +=(1<<22)
ELSE
clear%+=(1<<22)
eor%  +=(0<<22)
ENDIF
IF del% THEN
clear%+=(1<<23)
eor%  +=(1<<23)
ELSE
clear%+=(1<<23)
eor%  +=(0<<23)
ENDIF
:
!q%=whan%
q%!4=ihan%
q%!8=eor%
q%!12=clear%
SYS "Wimp_SetIconState",,q%
ENDPROC
:
DEF FNicon_deleted(whan%,icon%)
!q%=whan%
q%!4=icon%
SYS "Wimp_GetIconState",,q%
=((q%!24 AND (1<<23))<>0)
:
DEF FNicon_shaded(whan%,icon%)
!q%=whan%
q%!4=icon%
SYS "Wimp_GetIconState",,q%
=((q%!24 AND (1<<22))<>0)
:
DEF FNicon_selected(whan%,icon%)
!q%=whan%
q%!4=icon%
SYS "Wimp_GetIconState",,q%
=((q%!24 AND (1<<21))<>0)
:
DEF FNindirection(wind%,icon%)
!az%=wind%
az%!4=icon%
SYS "Wimp_GetIconState",,az%
=az%!28
:
DEF PROCset_icon_colour(whand%,ihand%,fcol%,bcol%)
LOCAL eor%,clear%
eor%=0
clear%=(255<<24)
!q%=whand%
q%!4=ihand%
q%!8=eor%
q%!12=clear%
SYS "Wimp_SetIconState",,q%
eor%=0
clear%=0
eor%+=(bcol%<<28)
eor%+=(fcol%<<24)
clear%=eor%
q%!8=eor%
q%!12=clear%
SYS "Wimp_SetIconState",,q%
ENDPROC
:
DEF FNget_icon_colour(w%,i%)
!q%=w% : q%!4=i%
SYS "Wimp_GetIconState",,q%
=((q%!24 AND %1111<<28)>>>28)
:
DEF FNicon_bar(task$)
!q%=-1
q%!4=0
q%!8=0
q%!12=68
q%!16=69
q%!20=&3002
$(q%+24)=task$
:
SYS "Wimp_CreateIcon",,q% TO ihandle%
=ihandle%
:
DEF PROCincrease_icon(w%,i%,l%)
LOCAL val%
val%=VAL($FNindirection(w%,i%))
val%+=1
IF val%<=l% THEN $FNindirection(w%,i%)=STR$(val%)
PROCredraw_icon(w%,i%)
ENDPROC
:
DEF PROCdecrease_icon(w%,i%,l%)
LOCAL val%
val%=VAL($FNindirection(w%,i%))
val%-=1
IF val%>=l% THEN $FNindirection(w%,i%)=STR$(val%)
PROCredraw_icon(w%,i%)
ENDPROC
:
DEF PROCend_caret(w%,i%)
LOCAL len%
IF i%>-1 THEN
 !b%=w% :b%!4=i%
 SYS "Wimp_GetIconState",,b%
 len%=LEN($(b%!28))
ELSE
 len%=0
ENDIF
SYS "Wimp_SetCaretPosition",w%,i%,,,-1,len%
ENDPROC
:
DEF FNfind_caret(w%,i%)
SYS "Wimp_GetCaretPosition",,q%
IF i%=-1 THEN q%!4=-1
=((!q%=w%) AND (q%!4=i%))
:
:
DEF PROCdisplay_bar_menu(menu%,items%,dots%,x%)
menuup%=menu%
SYS "Wimp_CreateMenu",,menu%,x%-64,96+(items%*44)+(dots%*24)
ENDPROC
:
DEF PROCdisplay_menu(menu%,x%,y%)
menuup%=menu%
SYS "Wimp_CreateMenu",,menu%,x%-64,y%
ENDPROC
:
DEF PROCset_menu_title(menu%,title$)
$menu%=title$:menu%?12=7
ENDPROC
:
DEF PROCset_menu_text(menu%,item%,text%,len%)
!(menu%+28+(item%*24)+12)=text%
!(menu%+28+(item%*24)+20)=len%
ENDPROC
:
DEF FNget_menu_text(menu%,item%)
=!(menu%+28+(item%*24)+12)
:
DEF PROCset_menu_state(handle%,item%,tick%,shade%)
LOCAL a%
a%=handle%+28+(item%*24)+10
IF shade% THEN?a%=(?a% OR 64) ELSE?a%=(?a% AND 191)
a%=handle%+28+(item%*24)
IF tick% THEN?a%=(?a% OR 1) ELSE?a%=(?a% AND 254)
ENDPROC
:
DEF PROCset_menu_end(handle%,item%,end%)
LOCAL a%
a%=handle%+28+(item%*24)
IF end% THEN?a%=(?a% OR 128) ELSE?a%=(?a% AND 127)
ENDPROC
:
DEF PROCset_menu_width(handle%,w%)
handle%!16=(w%+1)*16
ENDPROC
:
DEF PROCinit_menu(menu%,RETURN width%,RETURN end%,title$)
width%=LEN(title$)
$menu%=title$:menu%?12=7
menu%?13=2:menu%?14=7:menu%?15=0
menu%!16=(width%+1)*16:menu%!20=44
menu%!24=0:end%=menu%+28
ENDPROC
:
DEF PROCst_menu_item(menu%,RETURN width%,RETURN end%,text$,tick%,dot%,shade%,last%,link%,warn%)
LOCAL f%,d%
IF LEN(text$)<12 THEN
f%=FNst_menu_flags(shade%)
PROCmenu_item(menu%,width%,end%,text$,tick%,dot%,shade%,last%,link%,write%,warn%,f%,0,0,0)
ELSE
DIM d% LEN(text$)
$d%=text$
f%=FNmenu_flags(1,0,0,0,0,1,0,0,shade%,7,0,0)
PROCmenu_item(menu%,width%,end%,text$,tick%,dot%,shade%,last%,link%,write%,warn%,f%,d%,-1,LEN(text$)+1)
ENDIF
ENDPROC
:
DEF PROCmenu_item(menu%,RETURN width%,RETURN end%,text$,tick%,dot%,shade%,last%,link%,write%,mess%,flag%,icon1%,icon2%,icon3%)
LOCAL f%,ist%
f%=tick%+(dot%<<1)+(write%<<2)+(mess%<<3)+(last%<<7)
!end%=f%:end%!4=link%:end%!8=flag%
ist%=((flag%>>6)AND4)+(flag%AND3)
CASE ist% OF
WHEN 1,2,3:$(end%+12)=text$
WHEN 5,6,7:end%!12=icon1%:end%!16=icon2%:end%!20=icon3%
ENDCASE
end%+=24
IF LEN(text$)>width% THENwidth%=LEN(text$)
menu%!16=(width%+1)*16
ENDPROC
:
DEF FNmenu_flags(text%,sp%,bor%,chor%,anti%,ind%,rjust%,half%,shade%,fcol%,bcol%,font%)
LOCAL flag%
flag%=text%+(sp%<<1)+(bor%<<2)+(chor%<<3)+(1<<5)+(anti%<<6)+(ind%<<8)+(rjust%<<9)+(half%<<11)+(shade%<<22)
IF anti%=0 THEN
flag%+=(fcol%<<24)+(bcol%<<28)
ELSE
flag%+=(font%<<24)
ENDIF
=flag%
:
DEF FNst_menu_flags(shade%)
=FNmenu_flags(1,0,0,0,0,0,0,0,shade%,7,0,0)
:
DEF FNm_flags(fg%,bg%)
=FNmenu_flags(1,0,0,0,0,0,0,0,0,fg%,bg%,0)
:
DEF PROCset_cmenu_tick(c%)
LOCAL loop%
FOR loop%=0 TO 15
 PROCset_menu_state(cmenu%,loop%,ABS(loop%=c%),0)
NEXT loop%
ENDPROC
:
:
DEF FNupper(s$)
LOCAL t$,z$,switch%
FOR switch%=1 TO LEN(s$)
z$=MID$(s$,switch%,1)
IF ASC(z$)>=97 AND ASC(z$)<=122 THENz$=CHR$(ASC(z$)-32)
t$+=z$
NEXT switch%
=t$
:
DEF PROCdrag_init
drag_start%=FNswi("DragASprite_Start")
drag_stop%=FNswi("DragASprite_Stop")
SYS "OS_Byte",161,28 TO ,,cmos
IF (cmos AND 2)=0 drag_start%=-1:drag_stop%=-1
ENDPROC
:
DEF FNswi(swi$)
SYS "XOS_SWINumberFromString",,swi$ TO swi;flag
IF (flag AND 1) swi=-1
=swi
:
DEF PROCdrag_box(w%)
LOCAL ox%,oy%,file$
!q%=w%
SYS "Wimp_GetWindowState",,q%
ox%=q%!4-q%!20
oy%=q%!16-q%!24
q%!4=0
SYS "Wimp_GetIconState",,q%
q%!4=5
q%!8=ox%+q%!8
q%!12=oy%+q%!12
q%!16=ox%+q%!16
q%!20=oy%+q%!20
q%!24=0
q%!28=0
q%!32=&7FFFFFFF
q%!36=&7FFFFFFF
IF w%=save% THEN file$=sprite_accounts$ : drag_from%=1
IF w%=exp_wind% THEN
 IF d_type%=1 THEN file$=sprite_account$ : drag_from%=2
 IF d_type%=2 THEN file$=sprite_text$ : drag_from%=3
 IF d_type%=3 THEN file$=sprite_csv$ : drag_from%=4
 IF d_type%=4 THEN file$=sprite_text$ : drag_from%=5
 IF d_type%=5 THEN file$=sprite_csv$ : drag_from%=6
 IF d_type%=6 THEN file$=sprite_text$ : drag_from%=7
 IF d_type%=7 THEN file$=sprite_text$ : drag_from%=8
 IF d_type%=8 THEN file$=sprite_csv$ : drag_from%=9
 IF d_type%=9 THEN file$=sprite_text$ : drag_from%=10
 IF d_type%=10 THEN file$=sprite_text$ : drag_from%=11
ENDIF
IF drag_start%=-1 THEN
SYS "Wimp_DragBox",,q%
ELSE
SYS drag_start%,%11000101,1,file$,q%+8,q%+24
ENDIF
ENDPROC
:
DEF PROCget_path
LOCAL file$,type%
IF drag_from%=1 THEN
 file$=FNleaf_name($FNindirection(save%,1))
 type%=file_type_accounts%
ELSE
 file$=FNleaf_name($FNindirection(exp_wind%,1))
 IF drag_from%=2 THEN type%=file_type_account%
 IF drag_from%=3 THEN type%=file_type_text%
 IF drag_from%=4 THEN type%=file_type_csv%
 IF drag_from%=5 THEN type%=file_type_text%
 IF drag_from%=6 THEN type%=file_type_csv%
 IF drag_from%=7 THEN type%=file_type_text%
 IF drag_from%=8 THEN type%=file_type_text%
 IF drag_from%=9 THEN type%=file_type_csv%
 IF drag_from%=10 THEN type%=file_type_text%
 IF drag_from%=11 THEN type%=file_type_text%
ENDIF
IF drag_stop%<>-1 SYS drag_stop%
SYS "Wimp_GetPointerInfo",,q%
q%!20=q%!12
q%!24=q%!16
q%!28=!q%
q%!32=q%!4
q%!36=FNfile_size
!q%=64
q%!12=0
q%!16=1
q%!40=type%
$(q%+44)=file$+CHR$(0)
SYS "Wimp_SendMessage",18,q%,q%!20,q%!24
ENDPROC
:
DEF FNload_sprites(f$)
LOCAL size%,area%
in%=OPENIN(f$)
size%=EXT#in%
CLOSE#in%
size%+=4
DIM area% size%
!area%=size% :area%!8=16
SYS "OS_SpriteOp",&10A,area%,f$
=area%
:
DEF PROCget_size
size_x%=FNmv(11)<<FNmv(4)
size_y%=FNmv(12)<<FNmv(5)
ENDPROC
:
DEF FNmv(m%)
SYS "OS_ReadModeVariable",-1,m% TO ,,m%
=m%
:
DEF PROCmessage(m$,a$,b$,c$)
m$=FNmess_trans(m$)
a$=FNmess_trans(a$)
b$=FNmess_trans(b$)
c$=FNmess_trans(c$)
$FNindirection(mess_wind%,1)=a$
$FNindirection(mess_wind%,2)=b$
$FNindirection(mess_wind%,3)=c$
PROCset_icon_state(mess_wind%,1,0,0,(a$=""))
PROCset_icon_state(mess_wind%,2,0,0,(b$=""))
PROCset_icon_state(mess_wind%,3,0,0,(c$=""))
$FNindirection(mess_wind%,4)=m$
SYS "Wimp_GetPointerInfo",,q%
PROCopen_at(mess_wind%,(size_x%/2)-364,(size_y%/2)+131)
MOUSE RECTANGLE (size_x%/2)-364,(size_y%/2)-131,728,262
IF FNpreference(14) THEN VDU 7
ENDPROC
:
DEF FNmess_trans(s$)
LOCAL in%,r$
IF s$="" THEN =""
WHILE INSTR(s$,"<")
 in%=INSTR(s$,"<")
 r$=""
 CASE MID$(s$,in%+1,1) OF
  WHEN "A","a" : IF view_account%>-1 THEN r$=$FNindirection(acc_wind%,view_account%+1)
  WHEN "S","s" : r$=STR$(select%)
  WHEN "T","t" : r$=account_name$
  ENDCASE
  s$=LEFT$(s$,in%-1)+r$+MID$(s$,in%+3)
 ENDWHILE
token$=FNsplit(s$)
SYS "MessageTrans_Lookup",messages%,token$,az%,256,s$(1),s$(2),s$(3),s$(4) TO ,,,len%
az%?len%=13
=$az%
:
DEF FNsplit(str$)
LOCAL i%
i%=0
s$()=""
WHILE str$<>""
 col%=INSTR(str$+"|","|")
 s$(i%)=LEFT$(str$,col%-1)
 str$=MID$(str$,col%+1)
 i%+=1
ENDWHILE
=s$(0)
:
DEF PROCreset_mouse
MOUSE RECTANGLE 0,0,size_x%,size_y%
ENDPROC
:
DEF PROCerror
SYS "Hourglass_Smash"
IF debug% THEN
 $b%="     "+REPORT$+" at line "+STR$(ERL)+CHR$(0)
 SYS "Wimp_ReportError",b%,%11,"Accounts+" TO ,con%
ELSE
 $b%="     "+REPORT$+CHR$(0)
 SYS "Wimp_ReportError",b%,%1,"Accounts+" TO ,con%
ENDIF
IF con%=2 THEN PROCclose_down : END
ENDPROC

